<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GSU Player Lounge | GameSync Union</title>
  <link rel="icon" href="GSU_Logo.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto&display=swap" rel="stylesheet" />
  <style>
    .result-popup {
  margin-bottom: 1rem;
}

@media (max-width: 600px) {
  .poll-card {
    padding: 1rem;
  }

  .poll-card button {
    width: 100%;
    margin: 0.5rem 0;
  }

  .poll-card img {
    max-height: 160px;
  }
}

.result-popup {
  text-align: center;
  font-weight: bold;
  margin-bottom: 1rem;
}
.poll-card {
  max-width: 100%;
  overflow: hidden;
  background-color: #1f1f1f;
  border: 2px solid #fff;
  border-radius: 12px;
  padding: 1.4rem;
  margin-top: 1.5rem;
  color: #fff;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}


.poll-card:hover {
  border-color: var(--gsu-red);
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.4);
}

.poll-card h3 {
  font-size: 1.15rem;
  margin-bottom: 1rem;
  font-family: 'Montserrat', sans-serif;
}

.poll-card button {
  background-color: var(--gsu-red);
  color: #fff;
  border: 2px solid transparent;
  padding: 0.6rem 1rem;
  border-radius: 8px;
  font-size: 0.95rem;
  font-weight: 600;
  margin: 0.5rem 0.5rem 0.5rem 0;
  cursor: pointer;
  transition: all 0.3s ease;
}

.poll-card button:hover {
  background-color: #fff;
  color: var(--gsu-red);
  border-color: var(--gsu-red);
}

.poll-card img {
  height: 280px;
  width: auto;
  object-fit: contain;
  background: #111;
  padding: 6px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.poll-card img:hover {
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.3);
}

#poll-images {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 1rem;
  padding: 0.5rem 0;
  justify-content: flex-start;
  max-width: 100%;
}

#poll-images img {
  max-height: 200px;
  max-width: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  scroll-snap-align: center;
  background: #111;
  padding: 6px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#poll-images img:hover {
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.3);
}


.poll-theme {
  display: inline-block;
  background-color: #fff;
  border: 2px solid var(--gsu-red);
  padding: 0.4rem 0.8rem;
  border-radius: 6px;
  font-weight: bold;
  font-size: 0.95rem;
  margin-bottom: 0.8rem;
  color: var(--gsu-red);
}



    #connectPlayersContainer:hover::-webkit-scrollbar-thumb {
    background-color: #fff;
    }
    
    #connectPlayersContainer:hover::-webkit-scrollbar-track {
      background-color: #444;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .online {
      background-color: #4CAF50;
    }
    .offline {
      background-color: #999;
    }

    details summary {
        outline: none;
        list-style: none;
      }
      
      details[open] summary::after {
        content: " üîΩ";
      }
      summary::after {
        content: " ‚ñ∂Ô∏è";
        float: right;
        font-size: 0.9rem;
      }
    
    .fade-out {
        opacity: 1;
        animation: fadeOut 0.5s ease-out forwards;
      }
      
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: scale(0.95);
        }
      }
      
    :root {
      --gsu-red: #e60023;
      --black-main: #191818;
      --black-faded: #1F1F1F;
      --white-text: #FFFFFF;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--black-main);
      color: var(--white-text);
    }
    .page-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem 4rem;
    }
    header {
      background-color: var(--black-faded);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      height: 60px;
      margin-right: 1rem;
    }
    .logo-text {
      font-size: 1.6rem;
      font-family: 'Montserrat', sans-serif;
      color: var(--white-text);
    }
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: var(--white-text);
      font-family: 'Montserrat', sans-serif;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: var(--gsu-red);
    }
    .section-header {
      text-align: center;
      margin: 2rem 0 1rem;
    }
    .section-header h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      color: var(--gsu-red);
    }
    .section-header p {
      font-size: 1.1rem;
      color: #bbb;
    }
    .box {
      background-color: var(--black-faded);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 6px 16px rgba(230, 0, 35, 0.3), 0 0 8px rgba(255, 255, 255, 0.05);
      border: 1px solid var(--gsu-red);
    }
    .guides-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .upload-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #aaa;
    }
    .upload-meta .badge {
      background-color: var(--gsu-red);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    .chat-box {
      background-color: #262626;
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .chat-input {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: var(--white-text);
    }
    .chat-input button {
      background-color: var(--gsu-red);
      border: none;
      color: var(--white-text);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .chat-message {
      background-color: #2a2a2a;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      margin: 0.4rem 0;
      max-width: 80%;
      width: fit-content;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .chat-message span {
      color: var(--gsu-red);
      font-weight: bold;
      margin-right: 6px;
    }
    footer {
      margin-top: auto;
      background-color: var(--black-faded);
      padding: 1.2rem 1rem;
      text-align: center;
      border-top: 1px solid #333;
    }
    .platform-icons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }
    .platform-icons img {
      height: 32px;
      width: auto;
      opacity: 0.9;
    }
    footer p {
      color: #ccc;
      font-size: 1rem;
      font-family: 'Roboto', sans-serif;
    }
    footer p span {
      color: var(--gsu-red);
      font-weight: bold;
    }
    #weeklyPoll {
  max-height: 100vh;
  overflow-y: auto;
  padding-right: 8px;
  scrollbar-gutter: stable;
}

/* GSU red scrollbar for weekly poll */
#weeklyPoll::-webkit-scrollbar {
  width: 10px;
}

#weeklyPoll::-webkit-scrollbar-thumb {
  background-color: var(--gsu-red);
  border-radius: 6px;
  border: 2px solid #1f1f1f; /* subtle background contrast */
}

#weeklyPoll::-webkit-scrollbar-track {
  background: #2a2a2a;
}


#connectPlayersContainer {
  max-height: 600px;
  overflow-y: auto;
  overflow-x: visible;  /* üõ†Ô∏è prevent hover clipping */
  padding-right: 8px;
  margin-right: -4px;    /* helps avoid double scrollbar */
  position: relative;    /* to isolate z-index context */
}


#connectPlayersContainer::-webkit-scrollbar {
  width: 6px;
}

#connectPlayersContainer::-webkit-scrollbar-thumb {
  background-color: var(--gsu-red);
  border-radius: 4px;
}

#connectPlayersContainer::-webkit-scrollbar-track {
  background: #2a2a2a;
}

.upload-card {
  background-color: #1f1f1f;
  border: 2px solid #fff; /* Default white border */
  border-radius: 12px;
  padding: 1.2rem;
  color: var(--white-text);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  position: relative;
  z-index: 0;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.upload-card:hover {
  border-color: var(--gsu-red); /* GSU red on hover */
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.4);
}



.upload-card .fav-img-strip {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 1rem;
  padding-top: 0.75rem;
  padding-bottom: 0.25rem;
}

.upload-card .fav-img-strip img {
  height: 280px;
  width: auto;
  object-fit: contain;
  scroll-snap-align: center;
  background: #111;
  padding: 6px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(255, 255, 255, 0.08);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.upload-card .fav-img-strip {
  display: flex;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  gap: 1.5rem;
  padding-top: 1rem;
  padding-bottom: 0.5rem;
}


.upload-card .fav-img-strip img:hover {
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.3);
}


#connectPlayers {
  margin-top: 3rem;
}

.gamer-of-week {
  background-color: #1f1f1f;
  border: 2px solid var(--gsu-red);
  box-shadow: 0 0 18px rgba(230, 0, 35, 0.4);
  text-align: center;
  padding: 2rem;
  margin: 2rem auto;
  max-width: 800px;
  font-family: 'Montserrat', sans-serif;
}

.gamer-of-week h2 {
  color: var(--gsu-red);
  font-size: 1.6rem;
  margin-bottom: 0.8rem;
}

.gamer-of-week p {
  font-size: 1.05rem;
  color: #ddd;
  max-width: 700px;
  margin: 0 auto;
}
@media (max-width: 768px) {
  header {
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
  }

  .logo {
    flex: 1 1 auto;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    min-width: 0;
  }

  .logo img {
    height: 40px;
    flex-shrink: 0;
  }

  .logo-text {
    font-size: 1.3rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  nav {
    display: flex;
    flex: 2 1 auto;
    flex-wrap: wrap;
    justify-content: flex-end;
    gap: 0.5rem;
    min-width: 0;
  }

  nav a {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
    white-space: nowrap;
  }

  footer {
    display: flex;
    flex-wrap: nowrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 0.8rem 1rem;
    overflow-x: auto;
    flex-shrink: 0;
  }

  .platform-icons {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .platform-icons img {
    height: 26px;
    flex-shrink: 0;
  }

  footer p {
    font-size: 0.75rem;
    white-space: nowrap;
    margin-left: auto;
  }
}
header, footer {
  width: 100vw; /* Full viewport width */
  max-width: 100%;
  box-sizing: border-box;
}
.page-wrapper {
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <header>
      <div class="logo">
        <img src="GSU_LOGO.png" alt="GSU Logo" />
        <div class="logo-text">GAMESYNC UNION</div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="trophies.html">GSU Hall of Trophies & Achievements</a>
        <a href="art.html">Art</a>
        <a href="game-guides.html">Guides</a>
        <a href="uploads.html">GSU Player Lounge</a>
      </nav>
    </header>

    <main>
      <div class="section-header">
        <h1>üöÄ Welcome to the GSU Player Lounge | GameSync Union</h1>
        <p>üéÆ Squad up, show out, cast your vote ‚Äî GSU‚Äôs the place where gamers don‚Äôt choke. üì∏ Post your wins, üî• drop your heat ‚Äî üí¨ Chat, ü§ù connect, and üëë claim your seat.</p>
      </div>

      <div class="box">
        <h2>üí¨ Live GSU Community Chat</h2>
        <div class="chat-box" id="liveChat"></div>
        <div class="chat-input">
          <input type="text" id="chatMessage" placeholder="Type your message...">
          <button onclick="sendMessage()">Send</button>
          <button onclick="clearChat()" style="background:#e60023; color:#fff; border: 1px solid #777; border-radius: 6px; padding: 0.6rem 1rem; margin-left: auto;"> Clear Chat</button>

        </div>
      </div>

      <div class="box gamer-of-week">
      <h2>üëë GSU Gamer of the Week Spotlight</h2>
      <p>Every week, one player earns the crown. Based on uploads, chat, shoutouts, and community presence ‚Äî this is where legends rise.</p>
      <div class="guides-container" id="gamerOfTheWeek"></div>
    </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div class="box">
  <h2>üéØüí™ Find a Squad</h2>
  <p>Browse active players by game, platform, and playstyle ‚Äî build your ideal team for any mission.</p>
  <div class="guides-container" id="squadFinder"></div>
</div>

<div class="box">
  <h2>üéÆ Squad Up: Who‚Äôs Playing?</h2>
  <p>Call out your game, platform, and vibe ‚Äî whether you're ready to grind, fight, or just chill, this is where you find your crew.</p>
  <div class="guides-container" id="squadBoard"></div>
</div>

<div class="box">
  <h2>üì£ Community Shoutouts</h2>
  <p>Drop quick shoutouts to players who clutched, carried, or made your session unforgettable. Respect where it‚Äôs due.</p>
  <div class="guides-container" id="shoutouts"></div>
</div>

<div class="box">
  <h2>üî• GSU Upload Feed</h2>
  <p>See the latest clips, boss runs, fan art, and flexes ‚Äî this is where GSU drops heat, nonstop.</p>
  <div class="guides-container" id="allUploads"></div>
</div>

<div class="box" id="weeklyPollBox">
  <h2>üó≥Ô∏è Weekly GSU Poll (Created by You)</h2>
  <p>Each week, a new player is chosen to run the poll. Cast your vote, settle debates, and shape what‚Äôs trending.</p>
  <div id="weeklyPoll"></div>
</div>


<div class="box">
  <h2>ü§ù Connect with GSU Players</h2>
  <div id="connectDesc" style="transition: opacity 0.3s ease;">Check out gamer profiles, add friends, and see who‚Äôs running what. GSU is about linking real players together.</div>
  <div id="connectPlayersContainer">
    <div class="guides-container" id="connectPlayers"></div>
  </div>
</div>

      
    </main>

    <footer>
      <div class="platform-icons">
        <img src="PS_Logo.png" alt="PlayStation" />
        <img src="Xbox.png" alt="Xbox" />
        <img src="Steam.png" alt="PC" />
        <img src="Switch.png" alt="Nintendo Switch" />
      </div>
      <p>&copy; 2025 <span>GameSync Union</span>. Built for gamers, by gamers.</p>
      <p style="color: #777; font-size: 0.8rem;">Powered by Firebase | Designed with üíª and üéÆ</p>
    </footer>
  </div>

  <script>

    const connectBox = document.getElementById('connectPlayersContainer');
    const connectDesc = document.getElementById('connectDesc');

    connectBox.addEventListener('scroll', () => {
      if (connectBox.scrollTop > 20) {
        connectDesc.style.opacity = 0;
      } else {
        connectDesc.style.opacity = 1;
      }
    });

    
    function clearChat() {
  const user = firebase.auth().currentUser;
  
  if (!user) return;

  if (confirm("Are you sure you want to delete all chat messages?")) {
    const chatBox = document.getElementById("liveChat");

    // Add fade-out effect
    Array.from(chatBox.children).forEach((msg, index) => {
      msg.classList.add("fade-out");
    });

    // Delay deletion after animation completes
    setTimeout(() => {
      db.collection("chat").get().then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => {
        console.log("üî• Chat cleared.");
        chatBox.innerHTML = ""; // clean DOM
      });
    }, 600);
  }
}

      
      
    const firebaseConfig = {
      apiKey: "AIzaSyBA7aIUj919ub7QtkQkAp-xv4XC0tzmSCI",
      authDomain: "gamesync-union.firebaseapp.com",
      projectId: "gamesync-union"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let username = localStorage.getItem("gsuUsername") || "Anonymous";

  
  function addFriend(targetUID) {
  const user = firebase.auth().currentUser;
  if (!user || !targetUID || user.uid === targetUID) return;

  const currentUserRef = db.collection("users").doc(user.uid);
  const targetUserRef = db.collection("users").doc(targetUID);

  db.runTransaction(async (transaction) => {
    const currentDoc = await transaction.get(currentUserRef);
    const targetDoc = await transaction.get(targetUserRef);

    const pending = currentDoc.data().pendingRequests || [];
    const requests = targetDoc.data().friendRequests || [];

    if (!pending.includes(targetUID)) {
      transaction.update(currentUserRef, {
        pendingRequests: firebase.firestore.FieldValue.arrayUnion(targetUID)
      });
    }

    if (!requests.includes(user.uid)) {
      transaction.update(targetUserRef, {
        friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid)
      });
    }
  }).then(() => {
    showFeedback("‚úÖ Friend request sent!");
  }).catch((error) => {
    console.error("Error sending friend request:", error);
    showFeedback("‚ùå Failed to send friend request.");
  });
}



window.addFriend = addFriend;




  </script>
  <script>
    
let currentDMUser = "";

function getChatRoomId(uid1, uid2) {
  return [uid1, uid2].sort().join("_");
}

function openDM(friendId, friendUsername) {
  currentDMUser = friendId;
  const user = firebase.auth().currentUser;
  if (!user) return;

  const roomId = getChatRoomId(user.uid, friendId);
  document.getElementById("dmTitle").innerText = `üí¨ Chat with @${friendUsername}`;
  document.getElementById("dmModal").style.display = "block";

  const chatBox = document.getElementById("dmMessages");
  chatBox.innerHTML = "";

  db.collection("dms").doc(roomId).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        chatBox.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text}</p>`;
      });
    });
}

function sendDM() {
  const msg = document.getElementById("dmInput").value.trim();
  const user = firebase.auth().currentUser;
if (!msg || !currentDMUser || !user) return;

db.collection("users").doc(user.uid).get().then(doc => {
  const senderName = doc.data()?.username || "Anonymous";
  const roomId = getChatRoomId(user.uid, currentDMUser);

  db.collection("dms").doc(roomId).collection("messages").add({
    sender: senderName,
    text: msg,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("dmInput").value = "";
});

}



function closeDM() {
  document.getElementById("dmModal").style.display = "none";
}

function sendFriendRequest(targetId) {
  const user = firebase.auth().currentUser;
  if (!user || user.uid === targetId) return;

  db.collection("users").doc(targetId).update({
    friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid)
  }).then(() => {
    showFeedback("‚úÖ Friend request sent!");
  });
}



function acceptFriend(targetId, buttonElement = null) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    const userDoc = await transaction.get(userRef);
    const targetDoc = await transaction.get(targetRef);

    const userData = userDoc.data();
    const targetData = targetDoc.data();

    const userFriends = userData.friends || [];
    const targetFriends = targetData.friends || [];

    const updatedUserFriends = userFriends.includes(targetId) ? userFriends : [...userFriends, targetId];
    const updatedTargetFriends = targetFriends.includes(user.uid) ? targetFriends : [...targetFriends, user.uid];

    transaction.update(userRef, {
      friends: updatedUserFriends,
      friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      friends: updatedTargetFriends,
      pendingRequests: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback("üéâ Friend request accepted!");
    
    // üßº Remove button group from UI
    if (buttonElement) {
      const container = buttonElement.closest("div");
      container.innerHTML = `<span style="color:var(--gsu-red); font-weight:bold;">‚úÖ Accepted</span>`;
    }

  }).catch(err => {
    console.error("‚ùå Transaction failed:", err);
    showFeedback("‚ùå Failed to accept friend request.");
  });
}







function declineFriend(targetId, buttonElement = null) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    transaction.update(userRef, {
      friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      pendingRequests: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback("‚ùå Friend request declined", "#444");
    
    // üßº Remove button group from UI
    if (buttonElement) {
      const container = buttonElement.closest("div");
      container.innerHTML = `<span style="color:gray;">Request Declined</span>`;
    }

  }).catch(err => console.error("Decline failed:", err));
}






function removeFriend(targetId, username) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    transaction.update(userRef, {
      friends: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      friends: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback(`üëã Removed @${username} as a friend`, "#444");
  }).catch(err => console.error("Unfriend failed:", err));
}

firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    console.warn("üö´ Not logged in.");
  } else {
    console.log("‚úÖ Logged in as:", user.email);
  }
});


firebase.auth().onAuthStateChanged(authUser => {
  
  if (!authUser) {
    console.warn("üö´ Not logged in.");
    return;
  }
 




  console.log("‚úÖ Logged in as:", authUser.email);

  const userRef = db.collection("users").doc(authUser.uid);

  // Update 'online' flag immediately and on unload
  userRef.set({ online: true }, { merge: true });
  window.addEventListener("beforeunload", () => {
    userRef.update({ online: false });
  });

  async function getUsernameFromUID(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? doc.data().username : "(unknown)";
  } catch (error) {
    console.error("Error fetching username:", error);
    return "(error)";
  }
}


  // üî• Show ALL registered users
  db.collection("users").orderBy("username").onSnapshot(snapshot => {
    const container = document.getElementById("connectPlayers");
    container.innerHTML = "";

    if (snapshot.empty) {
      container.innerHTML = `<p style="color:#ccc; text-align:center;">No GSU players found yet.</p>`;
      return;
    }

    let authUserData = {};
    snapshot.forEach(doc => {
      if (doc.id === authUser.uid) {
        authUserData = doc.data();
      }
    });

    snapshot.forEach(doc => {
      const user = doc.data();
      const userId = doc.id;

      const isCurrentUser = authUser.uid === userId;
      const isFriend = (authUserData.friends || []).includes(userId);
      const sentRequest = (authUserData.pendingRequests || []).includes(userId);
      const receivedRequest = (authUserData.friendRequests || []).includes(userId);


      const lastActive = user.lastActive?.toDate();
      const now = new Date();
      const secondsAgo = lastActive ? (now - lastActive) / 1000 : Infinity;
      const status = secondsAgo < 90 ? 'online' : 'offline';

      let friendActions = "";
      if (!isCurrentUser) {
        if (isFriend) {
          friendActions = `
            <button onclick="openDM('${userId}', '${user.username}')">üí¨ DM</button>
            <button onclick="removeFriend('${userId}', '${user.username}')">‚ùå Unfriend</button>`;
        } else if (sentRequest) {
          friendActions = `<span style="color: var(--gsu-red); font-weight: bold;">üî¥ Pending</span>`;
        } else if (receivedRequest) {
          friendActions = `
            <button onclick="acceptFriend('${userId}', this)">‚úÖ Accept</button>
            <button onclick="declineFriend('${userId}', this)">‚ùå Decline</button>`;
        } else {
          friendActions = `<button onclick="addFriend('${userId}')">‚úÖ Add Friend</button>`;
        }
      }

    const div = document.createElement("div");
div.classList.add("upload-card");

const friendUIDs = user.friends || [];
const friendListHTML = friendUIDs.length
  ? `<div id="friend-list-${userId}"><p style="color:#aaa;">Loading...</p></div>`
  : `<p style="color:#888; margin-left:1rem;">No friends yet.</p>`;

div.innerHTML = `
  <h3>
    <span class="status-dot ${status}"></span>
    <span style="color: ${status === 'online' ? 'var(--gsu-red)' : '#aaa'}; font-weight: bold;">
      ${status.toUpperCase()}
    </span>
    üéÆ @${user.username}
  </h3>

  <p><strong>Platform:</strong> ${user.platform || "Not set"}</p>
  <p><strong>Favorite Games:</strong> ${
  user.favoriteGames && user.favoriteGames.length > 0
    ? user.favoriteGames.join(", ")
    : "None listed"
  }</p>
  <p><strong>Number Of Games Played:</strong> ${user.gamesPlayed || "Not tracked"}</p>
  <p><strong>Trophy Stats:</strong> ${user.trophyCount || "N/A"}</p>
  <p><strong>Friends:</strong> ${friendUIDs.length}</p>

  <details style="margin-top: 0.5rem;">
    <summary style="cursor:pointer; font-weight:bold; color:var(--gsu-red);">üîΩ View Friends</summary>
    ${friendListHTML}
  </details>

  ${Array.isArray(user.favoriteImages) && user.favoriteImages.length > 0 ? `
  <div class="fav-img-strip">
    ${user.favoriteImages.map(url => `
      <img src="${url}"/>
    `).join("")}
  </div>
` : ""}





  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
    ${friendActions}
  </div>
`;

// ‚úÖ After the HTML is injected, run the JS logic:
if (friendUIDs.length) {
  const friendListContainer = div.querySelector(`#friend-list-${userId}`);
  Promise.all(friendUIDs.map(getUsernameFromUID)).then(usernames => {
    friendListContainer.innerHTML = usernames.map(name =>
      `<p style="margin-left:1rem; color:#ccc;">üíØ @${name}</p>`
    ).join('');
  });
}

container.appendChild(div);

    });
  });

  // Show friend requests banner
  db.collection("users").doc(authUser.uid).get().then(doc => {
    const userData = doc.data();
    const requests = userData.friendRequests || [];
    if (requests.length > 0) {
      const banner = document.createElement("div");
      banner.style.background = "#e60023";
      banner.style.padding = "12px";
      banner.style.marginBottom = "1rem";
      banner.style.borderRadius = "8px";
      banner.style.color = "#fff";
      banner.innerHTML = `<strong>üì• Friend Requests:</strong><br />`;

      requests.forEach(requesterId => {
        db.collection("users").doc(requesterId).get().then(reqDoc => {
          const reqUser = reqDoc.data();
          const username = reqUser?.username || "Unknown";

          const row = document.createElement("div");
          row.style.marginTop = "6px";
          row.innerHTML = `
            üîî <strong>@${username}</strong> 
            <button onclick="acceptFriend('${requesterId}')">‚úÖ Accept</button>
            <button onclick="declineFriend('${requesterId}')">‚ùå Decline</button>`;
          banner.appendChild(row);
        });
      });

      const parent = document.getElementById("connectPlayers");
      if (parent) parent.prepend(banner);
    }
  });
  setInterval(() => {
  db.collection("users").doc(authUser.uid).update({
    lastActive: firebase.firestore.FieldValue.serverTimestamp()
  });
}, 30000); // every 30 seconds

});

  if (authUser) {
    const userRef = db.collection("users").doc(authUser.uid);
  
    // Set online true immediately
    userRef.update({ online: true }).catch(err => console.error("Error setting online:", err));
  
    // On tab close or refresh
    window.addEventListener("beforeunload", () => {
      userRef.update({ online: false });
    });
  
    // On logout
    firebase.auth().onIdTokenChanged(user => {
      if (!user) {
        userRef.update({ online: false });
      }
    });
  
    // (Optional) Ensure user doc exists with default field
    userRef.set({
      online: true
    }, { merge: true });

    // Display friend requests sent TO this user
  db.collection("users").doc(authUser.uid).get().then(doc => {
  const userData = doc.data();
  const incomingRequests = userData.friendRequests || [];

  if (incomingRequests.length > 0) {
    const banner = document.createElement("div");
    banner.style.background = "#e60023";
    banner.style.padding = "12px";
    banner.style.marginBottom = "1rem";
    banner.style.borderRadius = "8px";
    banner.style.color = "#fff";
    banner.innerHTML = `<strong>üì• Friend Requests:</strong><br />`;

    incomingRequests.forEach(requesterId => {
      db.collection("users").doc(requesterId).get().then(reqDoc => {
        const reqUser = reqDoc.data();
        const username = reqUser?.username || "Unknown";

        const row = document.createElement("div");
        row.style.marginTop = "6px";
        row.innerHTML = `
          üîî <strong>@${username}</strong> 
          <button onclick="acceptFriend('${requesterId}')">‚úÖ Accept</button>
          <button onclick="declineFriend('${requesterId}')">‚ùå Decline</button>
        `;
        banner.appendChild(row);
      });
    });

    const parent = document.getElementById("connectPlayers");
    if (parent) parent.prepend(banner);
  }
});

  }
  
;

function showFeedback(message, bgColor = '#e60023') {
  const banner = document.getElementById("feedbackBanner");
  if (!banner) return;

  banner.innerText = message;
  banner.style.backgroundColor = bgColor;
  banner.style.display = "block";

  setTimeout(() => {
    banner.style.opacity = "1";
    banner.style.transition = "opacity 0.5s ease";
    banner.style.opacity = "0";
  }, 2500);

  setTimeout(() => {
    banner.style.display = "none";
    banner.style.opacity = "1";
  }, 3200);
}


</script>
  <script>
    
    function sendMessage() {
      const input = document.getElementById("chatMessage");
      const message = input.value.trim();
      const user = firebase.auth().currentUser;
    
      if (!message || !user) return;
    
      db.collection("users").doc(user.uid).get().then(doc => {
        const sender = doc.data()?.username || "Anonymous"; // fallback only if absolutely no username exists
    
        db.collection("chat").add({
          sender: sender,
          text: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          input.value = "";
        }).catch((error) => {
          console.error("Error sending message:", error);
        });
      });
    }
    
    

// Real-time listener to show new messages
db.collection("chat").orderBy("timestamp").onSnapshot(snapshot => {
  const chatBox = document.getElementById("liveChat");
  chatBox.innerHTML = "";

  snapshot.forEach(doc => {
  const msg = doc.data();
  const time = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || "";

  chatBox.innerHTML += `
    <div class="chat-message" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <span>@${msg.sender}</span> ${msg.text}
      </div>
      <div class="chat-time" style="font-size: 0.75rem; color:#aaa; margin-left: 1rem; min-width: 60px; text-align: right;">
        ${time}
      </div>
    </div>
  `;
});


  chatBox.scrollTop = chatBox.scrollHeight;
});
function clearDMChat() {
  const user = firebase.auth().currentUser;
  if (!currentDMUser || !user) return;

  if (confirm("Are you sure you want to clear this DM conversation?")) {
    const roomId = getChatRoomId(user.uid, currentDMUser);
    const chatBox = document.getElementById("dmMessages");

    Array.from(chatBox.children).forEach((msg, index) => {
      setTimeout(() => {
        msg.classList.add("fade-out");
      }, index * 50);
    });

    setTimeout(() => {
      db.collection("dms").doc(roomId).collection("messages").get().then(snapshot => {
        snapshot.forEach(doc => doc.ref.delete());
      });
    }, 600); // after animation
  }
}

</script>

<script>
 const weeklyPoll = document.getElementById("weeklyPoll");

weeklyPoll.innerHTML = `
  <div class="poll-card">
    <div class="poll-theme">üï∏Ô∏è Marvel‚Äôs Spider-Man 2 ‚Äì Most Jaw-Dropping Moment</div>
    <h3>Which moment made you stop everything and say ‚Äúno way that just happened‚Äù? üò±</h3>
    <button onclick="submitVote('KravenKillsScorpion')">Kraven killing Scorpion with no hesitation</button>
    <button onclick="submitVote('VenomBreakout')">Venom‚Äôs full escape at Oscorp ‚Äì chaos unleashed</button>
    <button onclick="submitVote('VenomFinalBattle')">Peter & Miles vs. Venom ‚Äì The final battle that nearly killed Harry</button>

    <div id="poll-images">
      <img src="https://static0.gamerantimages.com/wordpress/wp-content/uploads/2023/10/anti-venom-spider-man-2.jpg" alt="Venom Final Battle">
      <img src="https://ew.com/thmb/FvhCq6RvxM7ul65Lou8wXaqKAGo=/1500x0/filters:no_upscale():max_bytes(150000):strip_icc()/spider-man-2-video-game-101623-4-cc85040df4884083a0e2e23a95310879.jpg" alt="Venom Breakout Chaos">
      <img src="https://static0.gamerantimages.com/wordpress/wp-content/uploads/2023/11/spider-man-2-kraven-scorpion.jpg" alt="Kraven Kills Scorpion">
    </div>

    <div class="result-popup" id="pollResultBox" style="display:none;"></div>
  </div>
`;
  function submitVote(choiceId) {
  const user = firebase.auth().currentUser;
  if (!user) {
    showFeedback("üö´ You must be logged in to vote.");
    return;
  }

  const voteRef = db.collection("pollVotes").doc(user.uid);

  voteRef.set({
    choice: choiceId,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  }).then(() => {
    const readableChoice = {
      KravenKillsScorpion: "Kraven killing Scorpion",
      VenomBreakout: "Venom‚Äôs full escape at Oscorp",
      VenomFinalBattle: "Peter & Miles vs. Venom"
    }[choiceId] || choiceId;

    const resultBox = document.getElementById("pollResultBox");
    resultBox.innerText = `üó≥Ô∏è You voted: ${readableChoice}`;
    resultBox.style.display = "block";
  }).catch(error => {
    console.error("Vote failed:", error);
    showFeedback("‚ùå Failed to record your vote.");
  });
}

</script>

<script>
  const weeklyPoll = document.getElementById("weeklyPoll");

  function showFeedback(msg) {
    const resultBox = document.getElementById("pollResultBox");
    resultBox.innerText = msg;
    resultBox.style.display = "block";
  }

  function submitVote(choiceId) {
    const user = firebase.auth().currentUser;
    if (!user) {
      showFeedback("üö´ You must be logged in to vote.");
      return;
    }

    const voteRef = db.collection("pollVotes").doc(user.uid);

    voteRef.set({
      choice: choiceId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      const readableChoice = {
        KravenKillsScorpion: "Kraven killing Scorpion",
        VenomBreakout: "Venom‚Äôs full escape at Oscorp",
        VenomFinalBattle: "Peter & Miles vs. Venom"
      }[choiceId] || choiceId;

      const resultBox = document.getElementById("pollResultBox");
      resultBox.innerText = `üó≥Ô∏è You voted: ${readableChoice}`;
      resultBox.style.display = "block";

      document.querySelectorAll(".poll-card button").forEach(btn => {
        btn.disabled = true;
        if (btn.innerText.includes(readableChoice)) {
          btn.style.borderColor = "#e60023";
          btn.style.backgroundColor = "#fff";
          btn.style.color = "#e60023";
        }
      });
    }).catch(error => {
      console.error("Vote failed:", error);
      showFeedback("‚ùå Failed to record your vote.");
    });
  }

  firebase.auth().onAuthStateChanged(user => {
    if (!user) return;

    const voteRef = db.collection("pollVotes").doc(user.uid);
    voteRef.get().then(doc => {
      if (doc.exists) {
        const choiceId = doc.data().choice;
        const readableChoice = {
          KravenKillsScorpion: "Kraven killing Scorpion",
          VenomBreakout: "Venom‚Äôs full escape at Oscorp",
          VenomFinalBattle: "Peter & Miles vs. Venom"
        }[choiceId] || choiceId;

        const resultBox = document.getElementById("pollResultBox");
        resultBox.innerText = `üó≥Ô∏è You voted: ${readableChoice}`;
        resultBox.style.display = "block";

        document.querySelectorAll(".poll-card button").forEach(btn => {
          btn.disabled = true;
          if (btn.innerText.includes(readableChoice)) {
            btn.style.borderColor = "#e60023";
            btn.style.backgroundColor = "#fff";
            btn.style.color = "#e60023";
          }
        });
      }
    });
  });
</script>

  <div id="dmModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:70%; background:#1F1F1F; color:#fff; border:2px solid var(--gsu-red); border-radius:12px; padding:1rem; z-index:999;">
  <h3 id="dmTitle">üí¨ Chat with ...</h3>
  <div id="dmMessages" style="height:80%; overflow-y:auto; margin-bottom:1rem; background:#2a2a2a; padding:1rem; border-radius:8px;"></div>
  <button onclick="clearDMChat()" style="margin-bottom:1rem; background:#444; color:#fff; border:none; padding:0.5rem 1rem; border-radius:6px;">Clear Chat</button>
  <input id="dmInput" type="text" placeholder="Type your message..." style="width:80%; padding:0.5rem; border-radius:6px;" />
  <button onclick="sendDM()">Send</button>
  <button onclick="closeDM()" style="float:right; background:#e60023;">Close</button>
</div>

<div id="feedbackBanner" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#e60023; color:#fff; padding:10px 20px; border-radius:8px; font-weight:bold; font-family:Montserrat, sans-serif; display:none; z-index:9999; box-shadow: 0 4px 10px rgba(0,0,0,0.4);">
</div>

</body>
</html>
