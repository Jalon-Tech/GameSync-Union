<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Uploads Hub | GameSync Union</title>
  <link rel="icon" href="GSU_Logo.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto&display=swap" rel="stylesheet" />
  <style>
    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .online {
      background-color: #4CAF50;
    }
    .offline {
      background-color: #999;
    }

    details summary {
        outline: none;
        list-style: none;
      }
      
      details[open] summary::after {
        content: " 🔽";
      }
      summary::after {
        content: " ▶️";
        float: right;
        font-size: 0.9rem;
      }
    
    .fade-out {
        opacity: 1;
        animation: fadeOut 0.5s ease-out forwards;
      }
      
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: scale(0.95);
        }
      }
      
    :root {
      --gsu-red: #e60023;
      --black-main: #191818;
      --black-faded: #1F1F1F;
      --white-text: #FFFFFF;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--black-main);
      color: var(--white-text);
    }
    .page-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem 4rem;
    }
    header {
      background-color: var(--black-faded);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      height: 60px;
      margin-right: 1rem;
    }
    .logo-text {
      font-size: 1.6rem;
      font-family: 'Montserrat', sans-serif;
      color: var(--white-text);
    }
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: var(--white-text);
      font-family: 'Montserrat', sans-serif;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: var(--gsu-red);
    }
    .section-header {
      text-align: center;
      margin: 2rem 0 1rem;
    }
    .section-header h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      color: var(--gsu-red);
    }
    .section-header p {
      font-size: 1.1rem;
      color: #bbb;
    }
    .box {
      background-color: var(--black-faded);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 6px 16px rgba(230, 0, 35, 0.3), 0 0 8px rgba(255, 255, 255, 0.05);
      border: 1px solid var(--gsu-red);
    }
    .guides-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    .upload-card {
      background-color: #1f1f1f;
      border: 1px solid #333;
      border-radius: 12px;
      padding: 1.2rem;
      color: var(--white-text);
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.4);
    }
    .upload-card:hover {
      transform: scale(1.015);
      border-color: var(--gsu-red);
      box-shadow: 0 8px 24px rgba(230, 0, 35, 0.25);
    }
    
    .upload-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #aaa;
    }
    .upload-meta .badge {
      background-color: var(--gsu-red);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    .chat-box {
      background-color: #262626;
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .chat-input {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: var(--white-text);
    }
    .chat-input button {
      background-color: var(--gsu-red);
      border: none;
      color: var(--white-text);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .chat-message {
      background-color: #2a2a2a;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      margin: 0.4rem 0;
      max-width: 80%;
      width: fit-content;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .chat-message span {
      color: var(--gsu-red);
      font-weight: bold;
      margin-right: 6px;
    }
    footer {
      margin-top: auto;
      background-color: var(--black-faded);
      padding: 1.2rem 1rem;
      text-align: center;
      border-top: 1px solid #333;
    }
    .platform-icons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }
    .platform-icons img {
      height: 32px;
      width: auto;
      opacity: 0.9;
    }
    footer p {
      color: #ccc;
      font-size: 1rem;
      font-family: 'Roboto', sans-serif;
    }
    footer p span {
      color: var(--gsu-red);
      font-weight: bold;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <header>
      <div class="logo">
        <img src="GSU_LOGO.png" alt="GSU Logo" />
        <div class="logo-text">GAMESYNC UNION</div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="trophies.html">Trophies/Achievements</a>
        <a href="art.html">Art</a>
        <a href="game-guides.html">Guides</a>
        <a href="uploads.html">Community Uploads</a>
      </nav>
    </header>

    <main>
      <div class="section-header">
        <h1>🚀 GameSync Union: Community Flex Zone</h1>
        <p>🎮 Squad up, show out, cast your vote — GSU’s the place where gamers don’t choke. 📸 Post your wins, 🔥 drop your heat — 💬 Chat, 🤝 connect, and 👑 claim your seat.</p>
      </div>

      <div class="box">
        <h2>💬 Live GSU Community Chat</h2>
        <div class="chat-box" id="liveChat"></div>
        <div class="chat-input">
          <input type="text" id="chatMessage" placeholder="Type your message...">
          <button onclick="sendMessage()">Send</button>
          <button onclick="clearChat()" style="background:#e60023; color:#fff; border: 1px solid #777; border-radius: 6px; padding: 0.6rem 1rem; margin-left: auto;"> Clear Chat</button>

        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div class="box">
  <h2>🎯💪 Find a Squad</h2>
  <p>Browse active players by game, platform, and playstyle — build your ideal team for any mission.</p>
  <div class="guides-container" id="squadFinder"></div>
</div>

<div class="box">
  <h2>🎮 Squad Up: Who’s Playing?</h2>
  <p>Call out your game, platform, and vibe — whether you're ready to grind, fight, or just chill, this is where you find your crew.</p>
  <div class="guides-container" id="squadBoard"></div>
</div>

<div class="box">
  <h2>📣 Community Shoutouts</h2>
  <p>Drop quick shoutouts to players who clutched, carried, or made your session unforgettable. Respect where it’s due.</p>
  <div class="guides-container" id="shoutouts"></div>
</div>

<div class="box">
  <h2>🔥 GSU Upload Feed</h2>
  <p>See the latest clips, boss runs, fan art, and flexes — this is where GSU drops heat, nonstop.</p>
  <div class="guides-container" id="allUploads"></div>
</div>

<div class="box">
  <h2>🗳️ Weekly GSU Poll (Created by You)</h2>
  <p>Each week, a new player is chosen to run the poll. Cast your vote, settle debates, and shape what’s trending.</p>
  <div class="guides-container" id="weeklyPoll"></div>
</div>

<div class="box">
  <h2>🤝 Connect with GSU Players</h2>
  <p>Check out gamer profiles, add friends, and see who’s running what. GSU is about linking real players together.</p>
  <div class="guides-container" id="connectPlayers"></div>
</div>

<div class="box">
  <h2>👑 GSU Gamer of the Week Spotlight</h2>
  <p>Every week, one player earns the crown. Based on uploads, chat, shoutouts, and community presence — this is where legends rise.</p>
  <div class="guides-container" id="gamerOfTheWeek"></div>
</div>

      
    </main>

    <footer>
      <div class="platform-icons">
        <img src="PS_Logo.png" alt="PlayStation" />
        <img src="Xbox.png" alt="Xbox" />
        <img src="Steam.png" alt="PC" />
        <img src="Switch.png" alt="Nintendo Switch" />
      </div>
      <p>&copy; 2025 <span>GameSync Union</span>. Built for gamers, by gamers.</p>
      <p style="color: #777; font-size: 0.8rem;">Powered by Firebase | Designed with 💻 and 🎮</p>
    </footer>
  </div>

  <script>
    function clearChat() {
        if (confirm("Are you sure you want to delete all chat messages?")) {
          const chatBox = document.getElementById("liveChat");
          if (chatBox) {
            Array.from(chatBox.children).forEach((msg, index) => {
              setTimeout(() => {
                msg.classList.add("fade-out");
              }, index * 50);
            });
      
            setTimeout(() => {
              db.collection("chat").get().then(snapshot => {
                snapshot.forEach(doc => doc.ref.delete());
              });
            }, 600); // wait for animation to finish before deleting
          }
        }
      }
      
      
    const firebaseConfig = {
      apiKey: "AIzaSyBA7aIUj919ub7QtkQkAp-xv4XC0tzmSCI",
      authDomain: "gamesync-union.firebaseapp.com",
      projectId: "gamesync-union"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let username = localStorage.getItem("gsuUsername") || "Anonymous";

  
    function addFriend(targetUserId, targetUsername) {
  const user = firebase.auth().currentUser;
  if (!user || user.uid === targetUserId) return;

  const userRef = db.collection("users").doc(user.uid);
  const friendUsername = targetUsername;

  // Add the username of the friend to the 'friends' array
  userRef.update({
    friends: firebase.firestore.FieldValue.arrayUnion(friendUsername)
  }).then(() => {
    alert(`You added @${friendUsername} as a friend!`);
  }).catch(err => {
    console.error("Error adding friend:", err);
    alert("Something went wrong adding your friend.");
  });
}
window.addFriend = addFriend;




  </script>
  <script>
let currentDMUser = "";

function openDM(friendId, friendUsername) {
  currentDMUser = friendId;
  document.getElementById("dmTitle").innerText = `💬 Chat with @${friendUsername}`;
  document.getElementById("dmModal").style.display = "block";

  const chatBox = document.getElementById("dmMessages");
  chatBox.innerHTML = "";

  db.collection("dms").doc(friendId).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        chatBox.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text}</p>`;
      });
    });
}

function sendDM() {
  const msg = document.getElementById("dmInput").value;
  const user = firebase.auth().currentUser;
  if (!msg || !currentDMUser || !user) return;

  const senderName = localStorage.getItem("gsuUsername") || "Anonymous";

  db.collection("dms").doc(currentDMUser).collection("messages").add({
    sender: senderName,
    text: msg,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("dmInput").value = "";
}


function closeDM() {
  document.getElementById("dmModal").style.display = "none";
}

function sendFriendRequest(targetId) {
  const user = firebase.auth().currentUser;
  if (!user || user.uid === targetId) return;

  db.collection("users").doc(targetId).update({
    friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid)
  }).then(() => {
    showFeedback("✅ Friend request sent!");
  });
}



function acceptFriend(targetId) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection("users").doc(user.uid).get().then(doc => {
    const currentUser = doc.data();
    const received = currentUser.friendRequests || [];

    if (received.includes(targetId)) {
      db.collection("users").doc(user.uid).update({
        friends: firebase.firestore.FieldValue.arrayUnion(targetId),
        friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
      });

      db.collection("users").doc(targetId).update({
        friends: firebase.firestore.FieldValue.arrayUnion(user.uid)
      });

      showFeedback("🎉 Friend request accepted!");
    } else {
      alert("You can only accept requests sent to you.");
    }
  });
}


function declineFriend(targetId) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  db.collection("users").doc(user.uid).get().then(doc => {
    const currentUser = doc.data();
    const received = currentUser.friendRequests || [];

    if (received.includes(targetId)) {
      db.collection("users").doc(user.uid).update({
        friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
      }).then(() => {
        showFeedback("❌ Friend request declined", "#444");
      });
    } else {
      alert("You can only decline requests sent to you.");
    }
  });
}



function removeFriend(targetId, username) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const currentUserRef = db.collection("users").doc(user.uid);
  const targetUserRef = db.collection("users").doc(targetId);

  currentUserRef.update({
    friends: firebase.firestore.FieldValue.arrayRemove(targetId)
  });

  targetUserRef.update({
    friends: firebase.firestore.FieldValue.arrayRemove(user.uid)
  }).then(() => {
    showFeedback(`👋 Removed @${username} as a friend`, "#444");
  });
}



firebase.auth().onAuthStateChanged(authUser => {
  db.collection("users").orderBy("username").onSnapshot(snapshot => {
    const container = document.getElementById("connectPlayers");
    if (!container) {
      console.warn("❌ Missing #connectPlayers container");
      return;
    }    
    container.innerHTML = "";

    if (snapshot.empty) {
      container.innerHTML = `<p style="color:#ccc; text-align:center;">No GSU players found yet. Be the first to show out!</p>`;
      return;
    }
    
    
    snapshot.forEach(doc => {
      const user = doc.data();
      const userId = doc.id;
      const isCurrentUser = authUser && authUser.uid === userId;
      const isFriend = user.friends?.includes(authUser.uid);
      const sentRequest = (authUser && (user.pendingRequests || []).includes(authUser.uid));
      const receivedRequest = (user.friendRequests || []).includes(authUser.uid);
      const status = user.online ? 'online' : 'offline';

      let friendActions = "";
      if (!isCurrentUser) {
        if (isFriend) {
          friendActions = `
            <button onclick="openDM('${userId}', '${user.username}')">💬 DM</button>
            <button onclick="removeFriend('${userId}', '${user.username}')">🗑️ Remove</button>
          `;
        } else if (user.pendingRequests?.includes(authUser.uid)) {
          friendActions = `<span style="color: var(--gsu-red); font-weight: bold;">🔴 Pending Request</span>`;
        } else if (receivedRequest) {
          friendActions = `
            <button onclick="acceptFriend('${userId}')">✅ Accept</button>
            <button onclick="declineFriend('${userId}')">❌ Decline</button>
          `;
        } else {
          friendActions = `<button onclick="sendFriendRequest('${userId}')">➕ Add Friend</button>`;
        }
      }
      

      const div = document.createElement("div");
      div.classList.add("upload-card");

      div.innerHTML = `
        <h3><span class="status-dot ${status}"></span>🎮 @${user.username}</h3>
        <p><strong>Favorite Games:</strong> ${user.favoriteGames?.join(", ") || "None listed"}</p>
        <p><strong>Number Of Games Played:</strong> ${user.gamesPlayed || "Not tracked"}</p>
        <p><strong>Trophy Stats:</strong> ${user.trophyCount || "N/A"}</p>
        <p><strong>Friends:</strong> ${user.friends?.length || 0}</p>
        <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
          ${user.favoriteImages?.map(url => `<img src="${url}" style="height:50px; border-radius:6px;" />`).join("") || ""}
        </div>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
          ${friendActions}
        </div>


      `;

      container.appendChild(div);
    });
  });
  if (authUser) {
    const userRef = db.collection("users").doc(authUser.uid);
  
    // Set online true immediately
    userRef.update({ online: true }).catch(err => console.error("Error setting online:", err));
  
    // On tab close or refresh
    window.addEventListener("beforeunload", () => {
      userRef.update({ online: false });
    });
  
    // On logout
    firebase.auth().onIdTokenChanged(user => {
      if (!user) {
        userRef.update({ online: false });
      }
    });
  
    // (Optional) Ensure user doc exists with default field
    userRef.set({
      online: true
    }, { merge: true });

    // Display friend requests sent TO this user
db.collection("users").doc(authUser.uid).get().then(doc => {
  const userData = doc.data();
  const incomingRequests = userData.friendRequests || [];

  if (incomingRequests.length > 0) {
    const banner = document.createElement("div");
    banner.style.background = "#e60023";
    banner.style.padding = "12px";
    banner.style.marginBottom = "1rem";
    banner.style.borderRadius = "8px";
    banner.style.color = "#fff";
    banner.innerHTML = `<strong>📥 Friend Requests:</strong><br />`;

    incomingRequests.forEach(requesterId => {
      db.collection("users").doc(requesterId).get().then(reqDoc => {
        const reqUser = reqDoc.data();
        const username = reqUser?.username || "Unknown";

        const row = document.createElement("div");
        row.style.marginTop = "6px";
        row.innerHTML = `
          🔔 <strong>@${username}</strong> 
          <button onclick="acceptFriend('${requesterId}')">✅ Accept</button>
          <button onclick="declineFriend('${requesterId}')">❌ Decline</button>
        `;
        banner.appendChild(row);
      });
    });

    const parent = document.getElementById("connectPlayers");
    if (parent) parent.prepend(banner);
  }
});

  }
  
});

function showFeedback(message, bgColor = '#e60023') {
  const banner = document.getElementById("feedbackBanner");
  if (!banner) return;

  banner.innerText = message;
  banner.style.backgroundColor = bgColor;
  banner.style.display = "block";

  setTimeout(() => {
    banner.style.opacity = "1";
    banner.style.transition = "opacity 0.5s ease";
    banner.style.opacity = "0";
  }, 2500);

  setTimeout(() => {
    banner.style.display = "none";
    banner.style.opacity = "1";
  }, 3200);
}


</script>
  <div id="dmModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:70%; background:#1F1F1F; color:#fff; border:2px solid var(--gsu-red); border-radius:12px; padding:1rem; z-index:999;">
  <h3 id="dmTitle">💬 Chat with ...</h3>
  <div id="dmMessages" style="height:80%; overflow-y:auto; margin-bottom:1rem; background:#2a2a2a; padding:1rem; border-radius:8px;"></div>
  <input id="dmInput" type="text" placeholder="Type your message..." style="width:80%; padding:0.5rem; border-radius:6px;" />
  <button onclick="sendDM()">Send</button>
  <button onclick="closeDM()" style="float:right; background:#e60023;">Close</button>
</div>

<div id="feedbackBanner" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#e60023; color:#fff; padding:10px 20px; border-radius:8px; font-weight:bold; font-family:Montserrat, sans-serif; display:none; z-index:9999; box-shadow: 0 4px 10px rgba(0,0,0,0.4);">
</div>

</body>
</html>
