<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GSU Player Lounge | GameSync Union</title>
  <link rel="icon" href="GSU_Logo.png" type="image/png" />
  
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto&display=swap" rel="stylesheet" />
  <style>

    .poll-reactions button {
  background: transparent;
  border: none;
  font-size: 1.2rem;
  margin: 0 0.3rem;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.poll-reactions button:hover {
  transform: scale(1.25);
}


    .poll-card {
  background: #1c1c1c;
  border: 2px solid #e60023;
  border-radius: 12px;
  padding: 1rem 1.25rem;
  margin-bottom: 2rem;
  font-family: 'Roboto', sans-serif;
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.15);
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}

.poll-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 18px rgba(230, 0, 35, 0.35);
}

.poll-card h3 {
  color: #fff;
  font-family: 'Montserrat', sans-serif;
  margin-bottom: 1rem;
  font-size: 1.1rem;
  text-shadow: 0 0 4px rgba(255, 255, 255, 0.1);
}

.poll-card button {
  background: #111;
  color: #fff;
  border: 2px solid #e60023;
  padding: 0.5rem 1.2rem;
  border-radius: 10px;
  margin: 0.4rem;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s, border-color 0.2s;
}

.poll-card button:hover {
  background: #e60023;
  border-color: #fff;
  color: #fff;
}

.result-popup.correct {
  background: #1f8a5d;
  color: #fff;
  padding: 1rem;
  margin-top: 1rem;
  border-radius: 10px;
  font-weight: bold;
  box-shadow: 0 0 10px rgba(31, 138, 93, 0.4);
}

.result-popup.wrong {
  background: #a11313;
  color: #fff;
  padding: 1rem;
  margin-top: 1rem;
  border-radius: 10px;
  font-weight: bold;
  box-shadow: 0 0 10px rgba(161, 19, 19, 0.4);
}

.result-popup.visible {
  animation: fadeInUp 0.4s ease forwards;
}

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(15px); }
  to { opacity: 1; transform: translateY(0); }
}

.poll-theme {
  padding: 0.4rem 0.75rem;
  border-radius: 8px;
  font-weight: bold;
  margin-bottom: 0.75rem;
  color: #fff;
  font-family: 'Montserrat', sans-serif;
  display: inline-block;
  box-shadow: 0 0 8px rgba(230, 0, 35, 0.3);
}

    #connectPlayersContainer:hover::-webkit-scrollbar-thumb {
    background-color: #fff;
    }
    
    #connectPlayersContainer:hover::-webkit-scrollbar-track {
      background-color: #444;
    }

    .status-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .online {
      background-color: #4CAF50;
    }
    .offline {
      background-color: #999;
    }

    details summary {
        outline: none;
        list-style: none;
      }
      
      details[open] summary::after {
        content: " üîΩ";
      }
      summary::after {
        content: " ‚ñ∂Ô∏è";
        float: right;
        font-size: 0.9rem;
      }
    
    .fade-out {
        opacity: 1;
        animation: fadeOut 0.5s ease-out forwards;
      }
      
      @keyframes fadeOut {
        to {
          opacity: 0;
          transform: scale(0.95);
        }
      }
      
    :root {
      --gsu-red: #e60023;
      --black-main: #191818;
      --black-faded: #1F1F1F;
      --white-text: #FFFFFF;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
    }
    body {
      font-family: 'Roboto', sans-serif;
      background-color: var(--black-main);
      color: var(--white-text);
    }
    .page-wrapper {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem 2rem 4rem;
    }
    header {
      background-color: var(--black-faded);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }
    .logo {
      display: flex;
      align-items: center;
    }
    .logo img {
      height: 60px;
      margin-right: 1rem;
    }
    .logo-text {
      font-size: 1.6rem;
      font-family: 'Montserrat', sans-serif;
      color: var(--white-text);
    }
    nav a {
      margin: 0 1rem;
      text-decoration: none;
      color: var(--white-text);
      font-family: 'Montserrat', sans-serif;
      transition: color 0.3s ease;
    }
    nav a:hover {
      color: var(--gsu-red);
    }
    .section-header {
      text-align: center;
      margin: 2rem 0 1rem;
    }
    .section-header h1 {
      font-family: 'Montserrat', sans-serif;
      font-size: 2.8rem;
      color: var(--gsu-red);
    }
    .section-header p {
      font-size: 1.1rem;
      color: #bbb;
    }
    .box {
      background-color: var(--black-faded);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease, border 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow: 0 6px 16px rgba(230, 0, 35, 0.3), 0 0 8px rgba(255, 255, 255, 0.05);
      border: 1px solid var(--gsu-red);
    }
    .guides-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
    }
    
    .upload-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      color: #aaa;
    }
    .upload-meta .badge {
      background-color: var(--gsu-red);
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      color: #fff;
      font-size: 0.75rem;
    }
    .chat-box {
      background-color: #262626;
      border-radius: 8px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 1rem;
    }
    .chat-input {
      display: flex;
      gap: 0.5rem;
    }
    .chat-input input {
      flex: 1;
      padding: 0.6rem;
      border: none;
      border-radius: 6px;
      background-color: #2a2a2a;
      color: var(--white-text);
    }
    .chat-input button {
      background-color: var(--gsu-red);
      border: none;
      color: var(--white-text);
      padding: 0.6rem 1rem;
      border-radius: 6px;
      cursor: pointer;
    }
    .chat-message {
      background-color: #2a2a2a;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      margin: 0.4rem 0;
      max-width: 80%;
      width: fit-content;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .chat-message span {
      color: var(--gsu-red);
      font-weight: bold;
      margin-right: 6px;
    }
    footer {
      margin-top: auto;
      background-color: var(--black-faded);
      padding: 1.2rem 1rem;
      text-align: center;
      border-top: 1px solid #333;
    }
    .platform-icons {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 0.6rem;
      flex-wrap: wrap;
    }
    .platform-icons img {
      height: 32px;
      width: auto;
      opacity: 0.9;
    }
    footer p {
      color: #ccc;
      font-size: 1rem;
      font-family: 'Roboto', sans-serif;
    }
    footer p span {
      color: var(--gsu-red);
      font-weight: bold;
    }
    #weeklyPoll {
  min-height: 180px;
  max-height: 220px;
  overflow-y: auto;
}

.box#weeklyPollBox {
  height: fit-content;
  max-height: 300px;
}
  @media (max-width: 768px) {
  .box#weeklyPollBox {
    max-height: none;
  }

  #weeklyPoll {
    max-height: none;
  }
}


#weeklyPoll::-webkit-scrollbar {
  width: 6px;
}

#weeklyPoll::-webkit-scrollbar-thumb {
  background-color: var(--gsu-red);
  border-radius: 4px;
}

#weeklyPoll::-webkit-scrollbar-track {
  background: #2a2a2a;
}
#connectPlayersContainer {
  max-height: 600px;
  overflow-y: auto;
  overflow-x: visible;  /* üõ†Ô∏è prevent hover clipping */
  padding-right: 8px;
  margin-right: -4px;    /* helps avoid double scrollbar */
  position: relative;    /* to isolate z-index context */
}


#connectPlayersContainer::-webkit-scrollbar {
  width: 6px;
}

#connectPlayersContainer::-webkit-scrollbar-thumb {
  background-color: var(--gsu-red);
  border-radius: 4px;
}

#connectPlayersContainer::-webkit-scrollbar-track {
  background: #2a2a2a;
}

.upload-card {
  background-color: #1f1f1f;
  border: 2px solid #fff; /* Default white border */
  border-radius: 12px;
  padding: 1.2rem;
  color: var(--white-text);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
  position: relative;
  z-index: 0;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.upload-card:hover {
  border-color: var(--gsu-red); /* GSU red on hover */
  box-shadow: 0 0 12px rgba(230, 0, 35, 0.4);
}



.upload-card img {
  max-height: 50px;
  object-fit: cover;
  border-radius: 6px;
  flex-shrink: 0;
}

#connectPlayers {
  margin-top: 3rem;
}

.gamer-of-week {
  background-color: #1f1f1f;
  border: 2px solid var(--gsu-red);
  box-shadow: 0 0 18px rgba(230, 0, 35, 0.4);
  text-align: center;
  padding: 2rem;
  margin: 2rem auto;
  max-width: 800px;
  font-family: 'Montserrat', sans-serif;
}

.gamer-of-week h2 {
  color: var(--gsu-red);
  font-size: 1.6rem;
  margin-bottom: 0.8rem;
}

.gamer-of-week p {
  font-size: 1.05rem;
  color: #ddd;
  max-width: 700px;
  margin: 0 auto;
}

  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="page-wrapper">
    <header>
      <div class="logo">
        <img src="GSU_LOGO.png" alt="GSU Logo" />
        <div class="logo-text">GAMESYNC UNION</div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="trophies.html">GSU Hall of Trophies & Achievements</a>
        <a href="art.html">Art</a>
        <a href="game-guides.html">Guides</a>
        <a href="uploads.html">GSU Player Lounge</a>
      </nav>
    </header>

    <main>
      <div class="section-header">
        <h1>üöÄ Welcome to the GSU Player Lounge | GameSync Union</h1>
        <p>üéÆ Squad up, show out, cast your vote ‚Äî GSU‚Äôs the place where gamers don‚Äôt choke. üì∏ Post your wins, üî• drop your heat ‚Äî üí¨ Chat, ü§ù connect, and üëë claim your seat.</p>
      </div>

      <div class="box">
        <h2>üí¨ Live GSU Community Chat</h2>
        <div class="chat-box" id="liveChat"></div>
        <div class="chat-input">
          <input type="text" id="chatMessage" placeholder="Type your message...">
          <button onclick="sendMessage()">Send</button>
          <button onclick="clearChat()" style="background:#e60023; color:#fff; border: 1px solid #777; border-radius: 6px; padding: 0.6rem 1rem; margin-left: auto;"> Clear Chat</button>

        </div>
      </div>

      <div class="box gamer-of-week">
      <h2>üëë GSU Gamer of the Week Spotlight</h2>
      <p>Every week, one player earns the crown. Based on uploads, chat, shoutouts, and community presence ‚Äî this is where legends rise.</p>
      <div class="guides-container" id="gamerOfTheWeek"></div>
    </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
      <div class="box">
  <h2>üéØüí™ Find a Squad</h2>
  <p>Browse active players by game, platform, and playstyle ‚Äî build your ideal team for any mission.</p>
  <div class="guides-container" id="squadFinder"></div>
</div>

<div class="box">
  <h2>üéÆ Squad Up: Who‚Äôs Playing?</h2>
  <p>Call out your game, platform, and vibe ‚Äî whether you're ready to grind, fight, or just chill, this is where you find your crew.</p>
  <div class="guides-container" id="squadBoard"></div>
</div>

<div class="box">
  <h2>üì£ Community Shoutouts</h2>
  <p>Drop quick shoutouts to players who clutched, carried, or made your session unforgettable. Respect where it‚Äôs due.</p>
  <div class="guides-container" id="shoutouts"></div>
</div>

<div class="box">
  <h2>üî• GSU Upload Feed</h2>
  <p>See the latest clips, boss runs, fan art, and flexes ‚Äî this is where GSU drops heat, nonstop.</p>
  <div class="guides-container" id="allUploads"></div>
</div>

<div class="box" id="weeklyPollBox">
  <h2>üó≥Ô∏è Weekly GSU Poll (Created by You)</h2>
  <p>Each week, a new player is chosen to run the poll. Cast your vote, settle debates, and shape what‚Äôs trending.</p>
  <div id="weeklyPoll"></div>
  <section id="gsuPollsArea">
  <div id="pollCreatorBox"></div>
  <div id="pollListContainer"></div>
  <div id="pollResultBox"></div>
  <div id="voteBreakdown"></div>
  <div id="weeklyScorecard"></div>
</section>
</div>


<div class="box">
  <h2>ü§ù Connect with GSU Players</h2>
  <div id="connectDesc" style="transition: opacity 0.3s ease;">Check out gamer profiles, add friends, and see who‚Äôs running what. GSU is about linking real players together.</div>
  <div id="connectPlayersContainer">
    <div class="guides-container" id="connectPlayers"></div>
  </div>
</div>

      
    </main>

    <footer>
      <div class="platform-icons">
        <img src="PS_Logo.png" alt="PlayStation" />
        <img src="Xbox.png" alt="Xbox" />
        <img src="Steam.png" alt="PC" />
        <img src="Switch.png" alt="Nintendo Switch" />
      </div>
      <p>&copy; 2025 <span>GameSync Union</span>. Built for gamers, by gamers.</p>
      <p style="color: #777; font-size: 0.8rem;">Powered by Firebase | Designed with üíª and üéÆ</p>
    </footer>
  </div>

  <script>

    const connectBox = document.getElementById('connectPlayersContainer');
    const connectDesc = document.getElementById('connectDesc');

    connectBox.addEventListener('scroll', () => {
      if (connectBox.scrollTop > 20) {
        connectDesc.style.opacity = 0;
      } else {
        connectDesc.style.opacity = 1;
      }
    });

    
    function clearChat() {
  const user = firebase.auth().currentUser;
  
  if (!user) return;

  if (confirm("Are you sure you want to delete all chat messages?")) {
    const chatBox = document.getElementById("liveChat");

    // Add fade-out effect
    Array.from(chatBox.children).forEach((msg, index) => {
      msg.classList.add("fade-out");
    });

    // Delay deletion after animation completes
    setTimeout(() => {
      db.collection("chat").get().then(snapshot => {
        const batch = db.batch();
        snapshot.forEach(doc => batch.delete(doc.ref));
        return batch.commit();
      }).then(() => {
        console.log("üî• Chat cleared.");
        chatBox.innerHTML = ""; // clean DOM
      });
    }, 600);
  }
}

      
      
    const firebaseConfig = {
      apiKey: "AIzaSyBA7aIUj919ub7QtkQkAp-xv4XC0tzmSCI",
      authDomain: "gamesync-union.firebaseapp.com",
      projectId: "gamesync-union"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let username = localStorage.getItem("gsuUsername") || "Anonymous";

  
  function addFriend(targetUID) {
  const user = firebase.auth().currentUser;
  if (!user || !targetUID || user.uid === targetUID) return;

  const currentUserRef = db.collection("users").doc(user.uid);
  const targetUserRef = db.collection("users").doc(targetUID);

  db.runTransaction(async (transaction) => {
    const currentDoc = await transaction.get(currentUserRef);
    const targetDoc = await transaction.get(targetUserRef);

    const pending = currentDoc.data().pendingRequests || [];
    const requests = targetDoc.data().friendRequests || [];

    if (!pending.includes(targetUID)) {
      transaction.update(currentUserRef, {
        pendingRequests: firebase.firestore.FieldValue.arrayUnion(targetUID)
      });
    }

    if (!requests.includes(user.uid)) {
      transaction.update(targetUserRef, {
        friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid)
      });
    }
  }).then(() => {
    showFeedback("‚úÖ Friend request sent!");
  }).catch((error) => {
    console.error("Error sending friend request:", error);
    showFeedback("‚ùå Failed to send friend request.");
  });
}



window.addFriend = addFriend;




  </script>
  <script>
    
let currentDMUser = "";

function getChatRoomId(uid1, uid2) {
  return [uid1, uid2].sort().join("_");
}

function openDM(friendId, friendUsername) {
  currentDMUser = friendId;
  const user = firebase.auth().currentUser;
  if (!user) return;

  const roomId = getChatRoomId(user.uid, friendId);
  document.getElementById("dmTitle").innerText = `üí¨ Chat with @${friendUsername}`;
  document.getElementById("dmModal").style.display = "block";

  const chatBox = document.getElementById("dmMessages");
  chatBox.innerHTML = "";

  db.collection("dms").doc(roomId).collection("messages")
    .orderBy("timestamp")
    .onSnapshot(snapshot => {
      chatBox.innerHTML = "";
      snapshot.forEach(doc => {
        const msg = doc.data();
        chatBox.innerHTML += `<p><strong>${msg.sender}:</strong> ${msg.text}</p>`;
      });
    });
}

function sendDM() {
  const msg = document.getElementById("dmInput").value.trim();
  const user = firebase.auth().currentUser;
if (!msg || !currentDMUser || !user) return;

db.collection("users").doc(user.uid).get().then(doc => {
  const senderName = doc.data()?.username || "Anonymous";
  const roomId = getChatRoomId(user.uid, currentDMUser);

  db.collection("dms").doc(roomId).collection("messages").add({
    sender: senderName,
    text: msg,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("dmInput").value = "";
});

}



function closeDM() {
  document.getElementById("dmModal").style.display = "none";
}

function sendFriendRequest(targetId) {
  const user = firebase.auth().currentUser;
  if (!user || user.uid === targetId) return;

  db.collection("users").doc(targetId).update({
    friendRequests: firebase.firestore.FieldValue.arrayUnion(user.uid)
  }).then(() => {
    showFeedback("‚úÖ Friend request sent!");
  });
}



function acceptFriend(targetId, buttonElement = null) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    const userDoc = await transaction.get(userRef);
    const targetDoc = await transaction.get(targetRef);

    const userData = userDoc.data();
    const targetData = targetDoc.data();

    const userFriends = userData.friends || [];
    const targetFriends = targetData.friends || [];

    const updatedUserFriends = userFriends.includes(targetId) ? userFriends : [...userFriends, targetId];
    const updatedTargetFriends = targetFriends.includes(user.uid) ? targetFriends : [...targetFriends, user.uid];

    transaction.update(userRef, {
      friends: updatedUserFriends,
      friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      friends: updatedTargetFriends,
      pendingRequests: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback("üéâ Friend request accepted!");
    
    // üßº Remove button group from UI
    if (buttonElement) {
      const container = buttonElement.closest("div");
      container.innerHTML = `<span style="color:var(--gsu-red); font-weight:bold;">‚úÖ Accepted</span>`;
    }

  }).catch(err => {
    console.error("‚ùå Transaction failed:", err);
    showFeedback("‚ùå Failed to accept friend request.");
  });
}







function declineFriend(targetId, buttonElement = null) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    transaction.update(userRef, {
      friendRequests: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      pendingRequests: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback("‚ùå Friend request declined", "#444");
    
    // üßº Remove button group from UI
    if (buttonElement) {
      const container = buttonElement.closest("div");
      container.innerHTML = `<span style="color:gray;">Request Declined</span>`;
    }

  }).catch(err => console.error("Decline failed:", err));
}






function removeFriend(targetId, username) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userRef = db.collection("users").doc(user.uid);
  const targetRef = db.collection("users").doc(targetId);

  db.runTransaction(async (transaction) => {
    transaction.update(userRef, {
      friends: firebase.firestore.FieldValue.arrayRemove(targetId)
    });

    transaction.update(targetRef, {
      friends: firebase.firestore.FieldValue.arrayRemove(user.uid)
    });
  }).then(() => {
    showFeedback(`üëã Removed @${username} as a friend`, "#444");
  }).catch(err => console.error("Unfriend failed:", err));
}

firebase.auth().onAuthStateChanged(user => {
  if (!user) {
    console.warn("üö´ Not logged in.");
  } else {
    console.log("‚úÖ Logged in as:", user.email);
  }
});


firebase.auth().onAuthStateChanged(authUser => {
  
  if (!authUser) {
    console.warn("üö´ Not logged in.");
    return;
  }
 




  console.log("‚úÖ Logged in as:", authUser.email);

  const userRef = db.collection("users").doc(authUser.uid);

  // Update 'online' flag immediately and on unload
  userRef.set({ online: true }, { merge: true });
  window.addEventListener("beforeunload", () => {
    userRef.update({ online: false });
  });

  async function getUsernameFromUID(uid) {
  try {
    const doc = await db.collection("users").doc(uid).get();
    return doc.exists ? doc.data().username : "(unknown)";
  } catch (error) {
    console.error("Error fetching username:", error);
    return "(error)";
  }
}


  // üî• Show ALL registered users
  db.collection("users").orderBy("username").onSnapshot(snapshot => {
    const container = document.getElementById("connectPlayers");
    container.innerHTML = "";

    if (snapshot.empty) {
      container.innerHTML = `<p style="color:#ccc; text-align:center;">No GSU players found yet.</p>`;
      return;
    }

    let authUserData = {};
    snapshot.forEach(doc => {
      if (doc.id === authUser.uid) {
        authUserData = doc.data();
      }
    });

    snapshot.forEach(doc => {
      const user = doc.data();
      const userId = doc.id;

      const isCurrentUser = authUser.uid === userId;
      const isFriend = (authUserData.friends || []).includes(userId);
      const sentRequest = (authUserData.pendingRequests || []).includes(userId);
      const receivedRequest = (authUserData.friendRequests || []).includes(userId);


      const lastActive = user.lastActive?.toDate();
      const now = new Date();
      const secondsAgo = lastActive ? (now - lastActive) / 1000 : Infinity;
      const status = secondsAgo < 90 ? 'online' : 'offline';

      let friendActions = "";
      if (!isCurrentUser) {
        if (isFriend) {
          friendActions = `
            <button onclick="openDM('${userId}', '${user.username}')">üí¨ DM</button>
            <button onclick="removeFriend('${userId}', '${user.username}')">‚ùå Unfriend</button>`;
        } else if (sentRequest) {
          friendActions = `<span style="color: var(--gsu-red); font-weight: bold;">üî¥ Pending</span>`;
        } else if (receivedRequest) {
          friendActions = `
            <button onclick="acceptFriend('${userId}', this)">‚úÖ Accept</button>
            <button onclick="declineFriend('${userId}', this)">‚ùå Decline</button>`;
        } else {
          friendActions = `<button onclick="addFriend('${userId}')">‚úÖ Add Friend</button>`;
        }
      }

    const div = document.createElement("div");
div.classList.add("upload-card");

const friendUIDs = user.friends || [];
const friendListHTML = friendUIDs.length
  ? `<div id="friend-list-${userId}"><p style="color:#aaa;">Loading...</p></div>`
  : `<p style="color:#888; margin-left:1rem;">No friends yet.</p>`;

div.innerHTML = `
  <h3>
    <span class="status-dot ${status}"></span>
    <span style="color: ${status === 'online' ? 'var(--gsu-red)' : '#aaa'}; font-weight: bold;">
      ${status.toUpperCase()}
    </span>
    üéÆ @${user.username}
  </h3>

  <p><strong>Platform:</strong> ${user.platform || "Not set"}</p>
  <p><strong>Favorite Games:</strong> ${user.favoriteGames?.join(", ") || "None listed"}</p>
  <p><strong>Number Of Games Played:</strong> ${user.gamesPlayed || "Not tracked"}</p>
  <p><strong>Trophy Stats:</strong> ${user.trophyCount || "N/A"}</p>
  <p><strong>Friends:</strong> ${friendUIDs.length}</p>

  <details style="margin-top: 0.5rem;">
    <summary style="cursor:pointer; font-weight:bold; color:var(--gsu-red);">üîΩ View Friends</summary>
    ${friendListHTML}
  </details>

  <div style="display: flex; gap: 0.75rem; margin-top: 1rem; flex-wrap: wrap; justify-content: flex-start;">
  ${user.favoriteImages?.map(url => `
    <img src="${url}" style="height:140px; width:auto; border-radius:12px; box-shadow: 0 0 10px rgba(0,0,0,0.5);" />
  `).join("") || ""}
</div>


  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.5rem;">
    ${friendActions}
  </div>
`;

// ‚úÖ After the HTML is injected, run the JS logic:
if (friendUIDs.length) {
  const friendListContainer = div.querySelector(`#friend-list-${userId}`);
  Promise.all(friendUIDs.map(getUsernameFromUID)).then(usernames => {
    friendListContainer.innerHTML = usernames.map(name =>
      `<p style="margin-left:1rem; color:#ccc;">üíØ @${name}</p>`
    ).join('');
  });
}

container.appendChild(div);

    });
  });

  // Show friend requests banner
  db.collection("users").doc(authUser.uid).get().then(doc => {
    const userData = doc.data();
    const requests = userData.friendRequests || [];
    if (requests.length > 0) {
      const banner = document.createElement("div");
      banner.style.background = "#e60023";
      banner.style.padding = "12px";
      banner.style.marginBottom = "1rem";
      banner.style.borderRadius = "8px";
      banner.style.color = "#fff";
      banner.innerHTML = `<strong>üì• Friend Requests:</strong><br />`;

      requests.forEach(requesterId => {
        db.collection("users").doc(requesterId).get().then(reqDoc => {
          const reqUser = reqDoc.data();
          const username = reqUser?.username || "Unknown";

          const row = document.createElement("div");
          row.style.marginTop = "6px";
          row.innerHTML = `
            üîî <strong>@${username}</strong> 
            <button onclick="acceptFriend('${requesterId}')">‚úÖ Accept</button>
            <button onclick="declineFriend('${requesterId}')">‚ùå Decline</button>`;
          banner.appendChild(row);
        });
      });

      const parent = document.getElementById("connectPlayers");
      if (parent) parent.prepend(banner);
    }
  });
  setInterval(() => {
  db.collection("users").doc(authUser.uid).update({
    lastActive: firebase.firestore.FieldValue.serverTimestamp()
  });
}, 30000); // every 30 seconds

});

  if (authUser) {
    const userRef = db.collection("users").doc(authUser.uid);
  
    // Set online true immediately
    userRef.update({ online: true }).catch(err => console.error("Error setting online:", err));
  
    // On tab close or refresh
    window.addEventListener("beforeunload", () => {
      userRef.update({ online: false });
    });
  
    // On logout
    firebase.auth().onIdTokenChanged(user => {
      if (!user) {
        userRef.update({ online: false });
      }
    });
  
    // (Optional) Ensure user doc exists with default field
    userRef.set({
      online: true
    }, { merge: true });

    // Display friend requests sent TO this user
  db.collection("users").doc(authUser.uid).get().then(doc => {
  const userData = doc.data();
  const incomingRequests = userData.friendRequests || [];

  if (incomingRequests.length > 0) {
    const banner = document.createElement("div");
    banner.style.background = "#e60023";
    banner.style.padding = "12px";
    banner.style.marginBottom = "1rem";
    banner.style.borderRadius = "8px";
    banner.style.color = "#fff";
    banner.innerHTML = `<strong>üì• Friend Requests:</strong><br />`;

    incomingRequests.forEach(requesterId => {
      db.collection("users").doc(requesterId).get().then(reqDoc => {
        const reqUser = reqDoc.data();
        const username = reqUser?.username || "Unknown";

        const row = document.createElement("div");
        row.style.marginTop = "6px";
        row.innerHTML = `
          üîî <strong>@${username}</strong> 
          <button onclick="acceptFriend('${requesterId}')">‚úÖ Accept</button>
          <button onclick="declineFriend('${requesterId}')">‚ùå Decline</button>
        `;
        banner.appendChild(row);
      });
    });

    const parent = document.getElementById("connectPlayers");
    if (parent) parent.prepend(banner);
  }
});

  }
  
;

function showFeedback(message, bgColor = '#e60023') {
  const banner = document.getElementById("feedbackBanner");
  if (!banner) return;

  banner.innerText = message;
  banner.style.backgroundColor = bgColor;
  banner.style.display = "block";

  setTimeout(() => {
    banner.style.opacity = "1";
    banner.style.transition = "opacity 0.5s ease";
    banner.style.opacity = "0";
  }, 2500);

  setTimeout(() => {
    banner.style.display = "none";
    banner.style.opacity = "1";
  }, 3200);
}

// ‚úÖ GSU Weekly Poll System ‚Äî All 10 Features Integrated
// Requires Firebase v9+ modular SDK already initialized with auth + firestore
// Place inside your <script> tag

// Constants
const pollsRef = db.collection("weekly_polls");
const pollStatsRef = db.collection("users");
const currentUser = firebase.auth().currentUser;

// 1Ô∏è‚É£ Poll Voting + XP + Lock Answer
function voteOnPoll(pollId, chosenOption, correctAnswer) {
  const user = firebase.auth().currentUser;
  if (!user) return alert("Please log in.");

  const voteRef = db.collection("users").doc(user.uid).collection("poll_votes").doc(pollId);

  voteRef.get().then(doc => {
    if (doc.exists) return alert("You‚Äôve already voted.");

    const correct = chosenOption === correctAnswer;

    voteRef.set({ chosenOption, correct });

    // Update vote count
    pollsRef.doc(pollId).update({
      [`voteCounts.${chosenOption}`]: firebase.firestore.FieldValue.increment(1)
    });

    // XP + Streak logic
    const statsRef = pollStatsRef.doc(user.uid);
    statsRef.get().then(snap => {
      let data = snap.exists ? snap.data() : {};
      let summary = data.pollStats || {
        currentStreak: 0,
        longestStreak: 0,
        correctAnswersTotal: 0,
        weeklyXP: 0
      };

      if (correct) {
        summary.currentStreak += 1;
        summary.correctAnswersTotal += 1;
        summary.weeklyXP += 10;
        if (summary.currentStreak > summary.longestStreak) summary.longestStreak = summary.currentStreak;
      } else {
        summary.currentStreak = 0;
      }

      statsRef.set({ pollStats: summary }, { merge: true });

      // üî• 2Ô∏è‚É£ Animated Reveal
      setTimeout(() => showResultBox(chosenOption, correctAnswer, correct), 200);
    });
  });
}

// 2Ô∏è‚É£ Show Result Box (Animated Reveal)
function showResultBox(userAnswer, correctAnswer, correct) {
  const box = document.getElementById("pollResultBox");
  box.innerHTML = `
    <div class="result-popup ${correct ? 'correct' : 'wrong'}">
      ‚úÖ You chose: ‚Äú${userAnswer}‚Äù<br />
      ‚úîÔ∏è Correct answer: ‚Äú${correctAnswer}‚Äù<br />
      ${correct ? 'üî• +10 XP earned!' : 'üò¨ No XP this time.'}
    </div>
  `;
  box.classList.add("visible");
  setTimeout(() => box.classList.remove("visible"), 4000);
}

// 3Ô∏è‚É£ Reactions to Polls
function reactToPoll(pollId, option, emoji) {
  const ref = db.collection("weekly_polls").doc(pollId);
  ref.update({
    [`pollReactions.${option}.${emoji}`]: firebase.firestore.FieldValue.increment(1)
  });
}

// ‚úÖ Poll Creator Shoutout ‚Äì Always visible to ALL users
function loadPollCreator() {
  const creatorBox = document.getElementById("pollCreatorBox");

  db.collection("poll_manager").doc("current").get().then(doc => {
    if (!doc.exists) {
      creatorBox.innerHTML = "<p style='color:#aaa;'>No poll creator selected yet.</p>";
      return;
    }

    const data = doc.data();
    const username = data.username || "Unknown";
    const quote = data.quote || "";

    creatorBox.innerHTML = `
      <div class="poll-card" style="background:#1f1f1f; border:2px solid #e60023; padding:1rem; margin-top:1rem; border-radius:12px; box-shadow:0 0 12px rgba(230,0,35,0.3);">
        <p style="font-size:1.05rem; color:#fff;">
          üó≥Ô∏è This week‚Äôs polls were created by <strong style="color:#e60023;">@${username}</strong>
        </p>
        <blockquote style="margin-top:0.5rem; color:#aaa; font-style:italic;">‚Äú${quote}‚Äù</blockquote>
      </div>
    `;
  }).catch(err => {
    console.error("‚ùå Error loading poll creator:", err);
    creatorBox.innerHTML = "<p style='color:red;'>Error loading poll creator info.</p>";
  });
}

// Call immediately after auth loads
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    loadPollCreator(); // üî• Always run this regardless of polls submitted
  }
});

// 5Ô∏è‚É£ GSU Vote Breakdown
function loadVoteChart(pollId) {
  db.collection("weekly_polls").doc(pollId).get().then(doc => {
    const data = doc.data();
    const counts = data.voteCounts || {};
    let html = "<h4>üìä How GSU Voted:</h4>";
    for (let opt in counts) {
      html += `<p>${opt}: ${counts[opt]} votes</p>`;
    }
    document.getElementById("voteBreakdown").innerHTML = html;
  });
}

// 6Ô∏è‚É£ End of Week Scorecard
function showEndOfWeekCard() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const statsRef = db.collection("users").doc(user.uid);
  statsRef.get().then(doc => {
    const summary = doc.data()?.pollStats || {};
    document.getElementById("weeklyScorecard").innerHTML = `
      ‚úÖ You got ${summary.correctAnswersTotal}/3 this week!<br />
      üî• Current Streak: ${summary.currentStreak}<br />
      üèÖ Total XP: ${summary.weeklyXP}
    `;
  });
}

// 7Ô∏è‚É£ Poll Themes
function stylePollCard(theme, icon, color) {
  return `<div class="poll-theme" style="background:${color};">
    ${icon} <strong>${theme}</strong>
  </div>`;
}

// 8Ô∏è‚É£ Perfect Guess Badge
function checkPerfectGuessBadge(userId) {
  const statsRef = db.collection("users").doc(userId);
  statsRef.get().then(doc => {
    const s = doc.data()?.pollStats;
    if (s?.correctAnswersTotal === 3) {
      db.collection("users").doc(userId).update({
        badges: firebase.firestore.FieldValue.arrayUnion("poll_prophet")
      });
    }
  });
}

// 9Ô∏è‚É£ Livewire Shoutouts
function postPollShoutout(text) {
  db.collection("livewire_events").add({
    type: "poll",
    text,
    timestamp: firebase.firestore.FieldValue.serverTimestamp()
  });
}

// üîü Poll Feedback
function submitPollFeedback(pollId, comment) {
  if (!comment) return;
  db.collection("poll_feedback").doc(pollId).update({
    feedback: firebase.firestore.FieldValue.arrayUnion(comment)
  });
}

// üì¢ To run: call these when polls load or close
// voteOnPoll(pollId, selected, correct);
// reactToPoll(pollId, option, emoji);
// loadPollCreator();
// loadVoteChart(pollId);
// showEndOfWeekCard();
// submitPollFeedback(pollId, "üî• Loved this!");

function renderWeeklyPolls() {
  db.collection("weekly_polls").orderBy("timestamp").limit(3).get().then(snapshot => {
    const container = document.getElementById("pollListContainer");
    container.innerHTML = "";

    snapshot.forEach(doc => {
      const poll = doc.data();
      const pollId = doc.id;

      const themeBox = stylePollCard(poll.theme, poll.icon, poll.color || "#222");

      let html = `
        <div class="poll-card">
          ${themeBox}
          <h3>${poll.question}</h3>
          ${poll.options.map(option => `
            <button onclick="voteOnPoll('${pollId}', '${option}', '${poll.answer}')">
              ${option}
            </button>
          `).join('')}
        </div>

        <div class="poll-reactions" data-poll-id="POLL_ID" data-option="OPTION_TEXT">
          <button onclick="reactToPollUI(this, 'üòÇ')">üòÇ</button>
          <button onclick="reactToPollUI(this, 'üíÄ')">üíÄ</button>
          <button onclick="reactToPollUI(this, 'ü§î')">ü§î</button>
          <button onclick="reactToPollUI(this, 'üëç')">üëç</button>
        </div>

      `;

      container.innerHTML += html;
    });

    loadPollCreator(); // ‚úÖ Show creator shoutout
  });
}

// Auto load on page
firebase.auth().onAuthStateChanged(user => {
  if (user) {
    renderWeeklyPolls();
    showEndOfWeekCard();
    showEndOfWeekCard();
  }
});

// Run this in your browser console or Firebase Functions if needed

firebase.firestore().collection("poll_manager").doc("current").set({
  username: "PhantomWeb",  // üîÅ Change this to your actual username
  quote: "Which game should be remastered next?" // üîÅ Creator's poll quote
}).then(() => {
  console.log("‚úÖ Poll creator successfully set!");
}).catch(error => {
  console.error("‚ùå Failed to set poll creator:", error);
});


</script>
  <script>
    
    function sendMessage() {
      const input = document.getElementById("chatMessage");
      const message = input.value.trim();
      const user = firebase.auth().currentUser;
    
      if (!message || !user) return;
    
      db.collection("users").doc(user.uid).get().then(doc => {
        const sender = doc.data()?.username || "Anonymous"; // fallback only if absolutely no username exists
    
        db.collection("chat").add({
          sender: sender,
          text: message,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          input.value = "";
        }).catch((error) => {
          console.error("Error sending message:", error);
        });
      });
    }
    
    

// Real-time listener to show new messages
db.collection("chat").orderBy("timestamp").onSnapshot(snapshot => {
  const chatBox = document.getElementById("liveChat");
  chatBox.innerHTML = "";

  snapshot.forEach(doc => {
  const msg = doc.data();
  const time = msg.timestamp?.toDate().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) || "";

  chatBox.innerHTML += `
    <div class="chat-message" style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <span>@${msg.sender}</span> ${msg.text}
      </div>
      <div class="chat-time" style="font-size: 0.75rem; color:#aaa; margin-left: 1rem; min-width: 60px; text-align: right;">
        ${time}
      </div>
    </div>
  `;
});


  chatBox.scrollTop = chatBox.scrollHeight;
});
function clearDMChat() {
  const user = firebase.auth().currentUser;
  if (!currentDMUser || !user) return;

  if (confirm("Are you sure you want to clear this DM conversation?")) {
    const roomId = getChatRoomId(user.uid, currentDMUser);
    const chatBox = document.getElementById("dmMessages");

    Array.from(chatBox.children).forEach((msg, index) => {
      setTimeout(() => {
        msg.classList.add("fade-out");
      }, index * 50);
    });

    setTimeout(() => {
      db.collection("dms").doc(roomId).collection("messages").get().then(snapshot => {
        snapshot.forEach(doc => doc.ref.delete());
      });
    }, 600); // after animation
  }
}

</script>

<script>
firebase.auth().onAuthStateChanged(user => {
  if (!user) return;

  const weeklyPollContainer = document.getElementById("weeklyPoll");

  // Load current weekly polls
  db.collection("weekly_polls").orderBy("timestamp").get().then(snapshot => {
    if (snapshot.empty) {
      weeklyPollContainer.innerHTML = `
      <div style="
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: #2a2a2a;
        border: 2px solid #e60023;
        border-radius: 10px;
        text-align: center;
        color: #e60023;
        font-size: 1.3rem;
        font-weight: bold;
        box-shadow: 0 0 12px rgba(230, 0, 35, 0.4);
      ">
        üö´ No active polls this week. Check back later to cast your vote!
      </div>
`;

      return;
    }

    snapshot.forEach(doc => {
      const poll = doc.data();
      const pollId = doc.id;
      const userVoteRef = db.collection("users").doc(user.uid).collection("poll_votes").doc(pollId);

      userVoteRef.get().then(voteDoc => {
        const userVoted = voteDoc.exists;
        const selected = voteDoc.data()?.answer;

        const pollDiv = document.createElement("div");
        pollDiv.style.marginBottom = "1.5rem";
        pollDiv.style.padding = "1rem";
        pollDiv.style.border = "1px solid #444";
        pollDiv.style.borderRadius = "8px";
        pollDiv.style.background = "#2a2a2a";

        let optionsHTML = "";
        poll.options.forEach((opt, i) => {
          const btnId = `vote_${pollId}_${i}`;
          optionsHTML += `
            <button id="${btnId}" class="pollOption" style="
              margin: 6px 0;
              padding: 8px 12px;
              border-radius: 6px;
              background-color: #191818;
              color: #fff;
              border: 1px solid #444;
              width: 100%;
              text-align: left;
              cursor: ${userVoted ? "not-allowed" : "pointer"};
              opacity: ${userVoted && selected !== opt ? 0.5 : 1};
              background-color: ${userVoted && selected === opt ? "#e60023" : "#191818"};
            " ${userVoted ? "disabled" : `onclick="submitPollVote('${pollId}', '${opt}', this)"`}>
              ${opt}
            </button>
          `;
        });

        pollDiv.innerHTML = `
          <h3 style="color: var(--gsu-red); font-size: 1.2rem;">üéÆ ${poll.question}</h3>
          <div>${optionsHTML}</div>
          ${userVoted ? `<p style='color:#aaa; font-size:0.85rem; margin-top:6px;'>‚úÖ You voted: <strong>${selected}</strong></p>` : ""}
        `;

        weeklyPollContainer.appendChild(pollDiv);
      });
    });
  });
});

// Submit vote to Firestore
function submitPollVote(pollId, answer, buttonEl) {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const voteRef = db.collection("users").doc(user.uid).collection("poll_votes").doc(pollId);

  voteRef.get().then(docSnap => {
    if (docSnap.exists) return; // already voted

    voteRef.set({
      answer: answer,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      // Increment vote count in poll
      db.collection("weekly_polls").doc(pollId).update({
        [`voteCount.${answer}`]: firebase.firestore.FieldValue.increment(1)
      });
      location.reload(); // refresh poll section
    });
  });
}
function reactToPollUI(button, emoji) {
  const wrapper = button.closest('.poll-reactions');
  const pollId = wrapper.dataset.pollId;
  const option = wrapper.dataset.option;

  // Disable all emoji buttons temporarily to avoid spamming
  Array.from(wrapper.children).forEach(btn => btn.disabled = true);

  db.collection("weekly_polls").doc(pollId).update({
    [`pollReactions.${option}.${emoji}`]: firebase.firestore.FieldValue.increment(1)
  }).then(() => {
    showFeedback(`You reacted with ${emoji}!`);
  }).catch(err => {
    console.error("Failed to react:", err);
    showFeedback("‚ùå Couldn't react.");
  });
}

</script>


  <div id="dmModal" style="display:none; position:fixed; top:10%; left:10%; width:80%; height:70%; background:#1F1F1F; color:#fff; border:2px solid var(--gsu-red); border-radius:12px; padding:1rem; z-index:999;">
  <h3 id="dmTitle">üí¨ Chat with ...</h3>
  <div id="dmMessages" style="height:80%; overflow-y:auto; margin-bottom:1rem; background:#2a2a2a; padding:1rem; border-radius:8px;"></div>
  <button onclick="clearDMChat()" style="margin-bottom:1rem; background:#444; color:#fff; border:none; padding:0.5rem 1rem; border-radius:6px;">Clear Chat</button>
  <input id="dmInput" type="text" placeholder="Type your message..." style="width:80%; padding:0.5rem; border-radius:6px;" />
  <button onclick="sendDM()">Send</button>
  <button onclick="closeDM()" style="float:right; background:#e60023;">Close</button>
</div>

<div id="feedbackBanner" style="position:fixed; top:20px; left:50%; transform:translateX(-50%); background:#e60023; color:#fff; padding:10px 20px; border-radius:8px; font-weight:bold; font-family:Montserrat, sans-serif; display:none; z-index:9999; box-shadow: 0 4px 10px rgba(0,0,0,0.4);">
</div>

</body>
</html>
