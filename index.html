<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameSync Union</title>
  <link rel="icon" href="GSU_LOGO.png" />
  <link rel="apple-touch-icon" href="GSU_LOGO.png" />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&family=Roboto:wght@400;500&family=Orbitron:wght@600&display=swap" rel="stylesheet" />

  <style>
    :root{
      --gsu-red:#e60023;
      --surface:#1f1f1f;
      --surface-2:#232323;
      --surface-3:#2a2a2a;
      --border:#2f2f2f;
      --text:#ffffff;
      --muted:#bdbdbd;
      --shadow:0 4px 18px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:'Roboto',system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji;
      color:var(--text);
      background:#191818;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    /* ---------- Header ---------- */
    header{
      position:sticky; top:0; z-index:50;
      background:#191919;
      border-bottom:1px solid var(--border);
      box-shadow:0 2px 12px rgba(0,0,0,.35);
    }
    .head-inner{
      max-width:1280px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:1rem; padding:0.8rem 1rem;
    }
    .logo{display:flex; align-items:center; gap:.7rem}
    .logo img{height:46px; width:auto}
    .logo-text{font-family:'Orbitron',sans-serif; letter-spacing:.5px}

    nav{
      display:flex; gap:.9rem; flex-wrap:wrap;
    }
    nav a{
      color:var(--text); text-decoration:none;
      font-family:'Montserrat',sans-serif; font-weight:600; font-size:.95rem;
      padding:.5rem .7rem; border-radius:.6rem; line-height:1;
      border:1px solid transparent;
    }
    nav a:hover{ border-color:var(--gsu-red); color:#fff; background:#1b1b1b }

    .btn{
      background:var(--gsu-red); color:#fff; border:none;
      padding:.7rem 1rem; border-radius:.6rem; cursor:pointer;
      font-family:'Montserrat',sans-serif; font-weight:700; letter-spacing:.2px;
      transition:transform .06s ease;
    }
    .btn:active{ transform:scale(.98) }

    /* ---------- Layout ---------- */
    .main-container{
      max-width:1280px; margin:1.4rem auto; padding:0 1rem;
      display:grid; grid-template-columns:280px minmax(0,1fr) 320px; gap:1.25rem;
    }
    @media (max-width:1160px){
      .main-container{ grid-template-columns:1fr; }
    }

    /* ---------- Card ---------- */
    .box{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:1rem;
      box-shadow:var(--shadow);
      transition:border-color .2s ease, transform .12s ease;
    }
    .box:hover{ border-color:#3a3a3a; transform:translateY(-2px) }

    .section-title{
      margin:0 0 .6rem;
      font-family:'Montserrat',sans-serif; font-weight:700; letter-spacing:.3px;
      text-align:center;
    }
    .section-title.accent{ color:var(--gsu-red) }

    /* ---------- Inputs ---------- */
    .input-field{
      width:100%; background:var(--surface-3); color:#fff;
      border:1px solid var(--border); border-radius:8px;
      padding:.65rem .75rem; margin:.4rem 0 .6rem;
    }

    /* ---------- Profile ---------- */
    #profile-box{
      background:linear-gradient(180deg,#1e1e1e 0%,#262626 100%);
      border:1px solid var(--gsu-red);
    }
    .stat-row{
      display:flex; align-items:center; gap:.8rem;
      padding:.7rem .9rem; margin:.55rem 0;
      background:var(--surface-2); border:1px solid var(--border);
      border-radius:10px; position:relative;
    }
    .stat-row::before{
      content:""; position:absolute; left:0; top:0; bottom:0; width:4px;
      background:var(--gsu-red); border-radius:10px 0 0 10px;
    }

    /* Favorites grid (no layout wobble) */
    #fav-images{
      display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:.9rem;
      padding:.8rem; background:#1b1b1b; border:1px solid var(--border); border-radius:10px;
    }
    @media (max-width:680px){ #fav-images{ grid-template-columns:repeat(2,minmax(0,1fr)); } }
    @media (max-width:420px){ #fav-images{ grid-template-columns:1fr; } }
    #fav-images img{
      width:100%; aspect-ratio:16/9; object-fit:cover;
      border-radius:10px; background:#111; display:block;
    }

    /* ---------- Statline grid ---------- */
    .livewire-stats{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:.9rem; margin-top:.8rem;
    }
    .stat-item{
      background:#212121; border:1px solid var(--border);
      border-radius:10px; padding:.9rem; font-size:.95rem;
    }

    /* ---------- Game Room blocks ---------- */
    .retro-header{ color:var(--gsu-red); font-family:'Montserrat',sans-serif; margin:0 0 .5rem; }
    .match-review-style .retro-body{ display:flex; flex-direction:column; gap:.5rem }
    .showoff-card{ display:flex; flex-direction:column; gap:.8rem; align-items:center }
    .showoff-img{ width:100%; max-width:720px; aspect-ratio:16/9; object-fit:cover; border-radius:10px; background:#111 }

    /* ---------- Alerts ---------- */
    .incoming-drop{ list-style:none; padding:0; margin:.2rem 0 0; }
    .incoming-drop li{
      border:1px solid var(--border); background:#212121; border-radius:10px;
      padding:.6rem .75rem; margin:.45rem 0;
    }

    /* ---------- Spotlight ---------- */
    #spotlight3{
      text-align:center; border:1px solid var(--border);
      background:linear-gradient(180deg,#202020 0%,#242424 100%); padding:1.4rem 1rem;
    }
    #fav-game-updates{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1rem; margin-top:1rem;
    }
    .spotlight-video{
      border:1px solid var(--border); border-radius:12px; background:#232323; padding:1rem;
    }
    .spotlight-video iframe{ width:100%; height:200px; border:0; border-radius:8px }

    /* ---------- Character Sync ---------- */
    #character-sync{
      border:1px solid var(--border); background:#1b1b1b;
      border-radius:12px; padding:.9rem;
    }
    #character-image{
      height:120px; width:120px; object-fit:contain; border-radius:10px;
      background:#000; border:1px solid #3a3a3a; display:block; margin:0 auto;
    }
    #no-character-msg{ display:none; color:#ff6b6b; text-align:center; font-size:.9rem }

    /* ---------- Modal ---------- */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:100 }
    .modal-content{
      width:min(520px,92vw); margin:8vh auto; background:#1e1e1e; color:#fff;
      border:1px solid var(--border); border-radius:14px; padding:1rem 1.1rem 1.2rem;
      box-shadow:var(--shadow);
    }
    .close{ float:right; font-size:28px; color:var(--gsu-red); cursor:pointer }

    /* ---------- Footer ---------- */
    footer{ margin-top:2.2rem; border-top:1px solid var(--border); background:#191919 }
    .foot-inner{ max-width:1280px; margin:0 auto; padding:1rem; text-align:center }
    .platform-icons{ display:flex; justify-content:center; gap:1rem; margin:.2rem 0 .6rem }
    .platform-icons img{ height:28px; opacity:.9 }

    /* Respect reduced motion */
    @media (prefers-reduced-motion:reduce){
      *{animation:none!important; transition:none!important}
    }
  </style>
</head>

<body>
  <!-- Header -->
  <header>
    <div class="head-inner">
      <div class="logo">
        <img src="GSU_LOGO.png" alt="GSU Logo">
        <div class="logo-text">GAMESYNC UNION</div>
      </div>
      <nav>
        <a href="index.html">Home</a>
        <a href="games.html">Games</a>
        <a href="trophies.html">Trophies</a>
        <a href="art.html">Art</a>
        <a href="game-guides.html">Guides</a>
        <a href="uploads.html">Player Lounge</a>
      </nav>
      <button id="logoutBtn" class="btn" style="background:#6f6f6f">Log Out</button>
    </div>
  </header>

  <div class="main-container">
    <!-- Left -->
    <aside>
      <div class="box" id="auth-box">
        <h2 class="section-title">Create Account or Sign In</h2>
        <input type="text" class="input-field" placeholder="Email" />
        <input type="text" class="input-field" placeholder="Username" />
        <input type="password" class="input-field" placeholder="Password" />
        <button class="btn" id="signInBtn">Sign In</button>
        <p style="text-align:center; margin:.6rem 0 0">
          Not a GSU member?
        </p>
        <button class="btn" id="createAccountBtn" style="margin-top:.55rem">Create your GSU account</button>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üïπÔ∏è Retro Game Flashback</h2>
        <p style="font-size:.92rem; color:var(--muted); margin-bottom:.6rem">
          One random flashback every click.
        </p>
        <div class="retro-body">
          <div class="game-title" style="font-weight:700; color:var(--gsu-red)">From here, the Retroverse info unfolds.</div>
          <div class="game-fact" id="retro-fact" style="max-height:96px; overflow:auto; color:#d8d8d8">Loading fact‚Ä¶</div>
          <button class="btn" onclick="loadRetroFact()" style="font-size:.9rem">üïπÔ∏è Spin the Retro Wheel</button>
        </div>
      </div>

      <div class="box">
        <h2 class="retro-header">üéÆ GSU Character Sync-Up</h2>
        <p style="font-size:.92rem; color:var(--muted); margin-bottom:.6rem">Pick a platform to reveal your synced legend.</p>

        <select id="platform-select" class="input-field" onchange="updateCharacterOptions()">
          <option value="">‚Äî Choose Platform ‚Äî</option>
          <option value="PlayStation">PlayStation</option>
          <option value="PC">PC</option>
          <option value="Xbox">Xbox</option>
          <option value="Nintendo">Nintendo</option>
        </select>
        <div id="no-character-msg">No character (yet). Choose a platform.</div>

        <p id="character-role" style="text-align:center; font-weight:700; margin:.5rem 0"></p>
        <div id="character-sync">
          <img id="character-image" src="GSU_LOGO.png" alt="Character" />
          <p id="character-desc" style="font-size:.9rem; color:#cfcfcf; text-align:center; margin:.6rem 0 0">
            Choose your platform to reveal your synced legend.
          </p>
        </div>
      </div>
    </aside>

    <!-- Center -->
    <main>
      <div class="box" style="text-align:center">
        <h2 class="section-title accent">Welcome to GameSync Union</h2>
        <p style="margin:.4rem 0 1rem; color:var(--muted)">No pause. No cap. Just raw sync ‚Äî where gamers link.</p>
        <button class="btn" onclick="window.location.href='about.html'">üìò The Full Breakdown</button>
      </div>

      <div class="box" id="profile-box">
        <h2 class="section-title accent">Your Profile</h2>

        <div class="stat-row" id="fav-games">üî• Favorite Games</div>
        <div class="stat-row" id="games-played">üéÆ Number Of Games Played</div>
        <div class="stat-row" id="trophy-stats">üèÜ Trophy Stats (Total Trophies)</div>

        <div style="margin-top:.8rem; color:var(--muted); font-size:.92rem">üéÆ Synced Game Covers ‚Äî pulled from your top 3 favorites</div>
        <div id="fav-images" style="margin-top:.6rem"></div>

        <div style="text-align:center; margin-top:1rem">
          <button class="btn" onclick="openEditModal()" style="max-width:240px">Update GSU Profile</button>
        </div>
      </div>

      <input type="text" class="input-field" placeholder="Search guides, uploads, art, users, or trophies..." />

      <div class="box">
        <h2 class="section-title accent">üî• Statline Supreme</h2>
        <div class="livewire-stats">
          <div class="stat-item">üë• Total GSU Members: <span id="totalMembers">_</span></div>
          <div class="stat-item">üÜï New Members This Week: <span id="newMembers">_</span></div>
          <div class="stat-item">üìπ Videos Shared: <span id="videoUploads">_</span></div>
          <div class="stat-item">üé® Fan Art Pieces: <span id="fanArt">_</span></div>
          <div class="stat-item">üèÜ Trophies Earned: <span id="trophies">_</span></div>
          <div class="stat-item">ü•ä Combo Guides: <span id="combos">_</span></div>
          <div class="stat-item">üìä Poll Votes: <span id="pollVotes">_</span></div>
        </div>
      </div>

      <div class="box">
        <h2 class="section-title accent">üî• Made the Union Watch</h2>
        <p style="text-align:center; color:var(--muted)">When the Union highlights you ‚Äî it means something.</p>

        <div class="showoff-card">
          <div id="unionWatchMedia" class="showoff-img" aria-label="Featured clip area"></div>
          <div class="showoff-info" style="text-align:center">
            <h3 id="unionWatchTitle" style="margin:.2rem 0 .3rem">Loading featured clip‚Ä¶</h3>
            <p id="unionWatchCaption" style="color:var(--muted)"></p>
          </div>
        </div>

        <div style="text-align:center; margin-top:1rem">
          <button class="btn" onclick="window.location.href='uploads.html'">See Why Everyone‚Äôs Talking</button>
        </div>
      </div>

      <div class="box">
        <h2 class="section-title accent">üëë One Trophy. One Flex.</h2>
        <div class="certified-moment">
          <img id="certifiedImg" src="GSU_LOGO.png" alt="Certified moment" class="showoff-img" style="max-width:560px" />
          <p id="certifiedCaption" style="color:var(--muted)">Finding a legendary flex‚Ä¶</p>
          <button class="btn" onclick="window.location.href='trophies.html'">Relive the Moment</button>
        </div>
      </div>

      <div class="box">
        <h2 class="section-title accent">üé≠ Union Rewind: Talk of the Week</h2>
        <div class="incoming-drop">
          <li id="talkQuoteText" style="font-style:italic">Scanning the Lounge‚Ä¶</li>
          <li id="talkQuoteWho" style="color:var(--muted)">‚Äî</li>
        </div>
      </div>

      <div class="box">
        <h2 class="section-title accent">üì° Union Alerts (last 24h)</h2>
        <ul class="incoming-drop" id="alertsList"><li>Loading fresh drops‚Ä¶</li></ul>
      </div>

      <div class="box" id="spotlight3">
        <h2 class="section-title accent">üéÆ GameSync Spotlight 3</h2>
        <p style="color:var(--muted)">Daily gameplay drops from the titles that matter to you.</p>
        <div id="fav-game-updates"></div>
      </div>
    </main>

    <!-- Right -->
    <aside>
      <div class="box match-review-style">
        <h2 class="retro-header">üïπÔ∏è The GameSync Game Room</h2>
        <p style="font-size:.92rem; color:var(--muted); margin-bottom:.6rem">Quick hitters that test reflexes and precision.</p>
        <div class="retro-body">
          <button class="btn" onclick="location.href='Charge_Run.html'">GSU Charge Run</button>
          <button class="btn">GSU Command Strike</button>
          <button class="btn">GSU Cipher Storm</button>
        </div>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üß† Game Dev Knowledge Drop</h2>
        <p style="font-size:.92rem; color:var(--muted); margin-bottom:.6rem">Level design is more psychology than geometry.</p>
        <div class="retro-body">
          <div style="font-size:.9rem">üìò Flow, affordances, and feedback loops.</div>
          <button class="btn">üìö Learn More</button>
        </div>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üí¨ GSU Vibe Check</h2>
        <div class="retro-body">
          <div style="font-weight:700">üî• Mood: Hype & Competitive</div>
          <div style="font-size:.9rem; color:var(--muted)">‚ÄúDon‚Äôt get perfect-parried again.‚Äù</div>
          <div style="font-size:.9rem; color:var(--muted)">Trophy flexes + fan art drops</div>
          <button class="btn">üì° Scan Live Vibe</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Footer -->
  <footer>
    <div class="foot-inner">
      <div class="platform-icons">
        <img src="PS_Logo.png" alt="PlayStation" />
        <img src="Xbox.png" alt="Xbox" />
        <img src="Steam.png" alt="PC" />
        <img src="Switch.png" alt="Nintendo Switch" />
      </div>
      <p style="color:#ccc; margin:0">&copy; 2025 GameSync Union. Built for gamers, by gamers.</p>
    </div>
  </footer>

  <!-- Edit Modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()" aria-label="Close">&times;</span>
      <h2 id="editTitle" class="section-title">Update Profile</h2>

      <label>Username</label>
      <input type="text" id="editUsername" class="input-field" placeholder="Change your Username">

      <label>Platform</label>
      <select id="editPlatform" class="input-field">
        <option value="">‚Äî Select Platform ‚Äî</option>
        <option value="PlayStation">PlayStation</option>
        <option value="PC">PC</option>
        <option value="Xbox">Xbox</option>
        <option value="Nintendo">Nintendo</option>
        <option value="Multiple">Multiple Platforms</option>
      </select>

      <label>Favorite Games (comma-separated)</label>
      <input type="text" id="editGames" class="input-field" placeholder="Spider-Man 2, Ratchet & Clank‚Ä¶" />

      <label>Number of Games Played</label>
      <input type="number" id="editGamesPlayed" class="input-field" min="0" />

      <label>Favorite Games‚Äô Cover Image URLs (comma-separated)</label>
      <input type="text" id="editGameImages" class="input-field" placeholder="url1, url2, url3" />

      <label>Total Trophy Count</label>
      <input type="number" id="editTrophies" class="input-field" min="0" />

      <button class="btn" onclick="saveProfileChanges()">Save Changes</button>
    </div>
  </div>

  <!-- Signed-out Notice -->
  <div id="authNotice" style="display:none; position:fixed; top:12%; left:50%; transform:translateX(-50%); background:#ffffff; color:#000; border:1px solid var(--border); padding:1rem 1.2rem; border-radius:12px; z-index:120; max-width:360px; box-shadow:var(--shadow); text-align:center;">
    <div style="font-weight:700; margin-bottom:.5rem">Signed out</div>
    <div style="margin-bottom:.8rem; color:#333">Sign in or create your GSU account for the full experience.</div>
    <button onclick="hideAuthNotice()" class="btn">Close</button>
  </div>

  <!-- ========================= JS ========================= -->

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBA7aIUj919ub7QtkQkAp-xv4XC0tzmSCI",
      authDomain: "gamesync-union.firebaseapp.com",
      projectId: "gamesync-union",
      storageBucket: "gamesync-union.appspot.com",
      messagingSenderId: "488911705365",
      appId: "1:488911705365:web:ad8b3be7936a46bb77c51c",
      measurementId: "G-CP48EXW1EV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persist login
    setPersistence(auth, browserLocalPersistence).catch(console.error);

    // expose
    window.db=db; window.auth=auth; window.doc=doc; window.getDoc=getDoc; window.setDoc=setDoc;

    // --- Auth UI ---
    const emailInput    = document.querySelector('#auth-box input[placeholder="Email"]');
    const passwordInput = document.querySelector('#auth-box input[placeholder="Password"]');
    const signInBtn     = document.getElementById('signInBtn');
    const createAccountBtn = document.getElementById('createAccountBtn');

    if (createAccountBtn) createAccountBtn.addEventListener('click', ()=> location.href="account_creation.html");
    if (signInBtn) {
      signInBtn.addEventListener('click', async ()=>{
        const email=(emailInput?.value||"").trim();
        const password=(passwordInput?.value||"");
        if(!email || !password){ alert("Enter both Email and Password."); return; }
        try{
          const userCred = await signInWithEmailAndPassword(auth,email,password);
          await loadProfile(userCred.user.uid);
          alert("Signed in successfully");
        }catch(err){ alert("Login failed: "+err.message); }
      });
    }

    // Load Profile into UI
    async function loadProfile(uid){
      const snap = await getDoc(doc(db,"users",uid));
      if(!snap.exists()) return;
      const data = snap.data();
      const favGames = Array.isArray(data.favoriteGames) ? data.favoriteGames.join(", ") : "N/A";
      document.getElementById("fav-games").textContent    = `üî• Favorite Games: ${favGames}`;
      document.getElementById("games-played").textContent = `üéÆ Number Of Games Played: ${data.gamesPlayed ?? "N/A"}`;
      document.getElementById("trophy-stats").textContent = `üèÜ Trophy Stats (Total Trophies): ${data.trophyCount ?? "N/A"}`;

      const imageRow = document.getElementById("fav-images");
      imageRow.innerHTML="";
      if (Array.isArray(data.favoriteImages)) {
        data.favoriteImages.slice(0,3).forEach((url, i)=>{
          const img=document.createElement("img");
          img.loading="lazy";
          img.src=url;
          img.alt=(data.favoriteGames && data.favoriteGames[i]) || `Favorite ${i+1}`;
          imageRow.appendChild(img);
        });
      }

      // add username + platform above stats (clean)
      const profileBox=document.getElementById("profile-box");
      profileBox.querySelector(".username-info")?.remove();
      profileBox.querySelector(".platform-info")?.remove();

      const u = document.createElement("p");
      u.className="username-info";
      u.style.margin="0 0 .4rem"; u.style.fontWeight="700";
      u.innerText=`üë§ Username: ${data.username || "N/A"}`;
      const p = document.createElement("p");
      p.className="platform-info";
      p.style.margin="0 0 .6rem"; p.innerText=`üîπ Platform: ${data.platform || "N/A"}`;
      profileBox.insertBefore(p, profileBox.children[1]);
      profileBox.insertBefore(u, profileBox.children[1]);
    }

    // Edit modal
    window.openEditModal = function(){
      document.getElementById('editModal').style.display='block';
      document.getElementById('editGames').value =
        document.getElementById('fav-games').textContent.replace('üî• Favorite Games: ','');
      document.getElementById('editGamesPlayed').value =
        document.getElementById('games-played').textContent.replace('üéÆ Number Of Games Played: ','');
      document.getElementById('editTrophies').value =
        document.getElementById('trophy-stats').textContent.replace('üèÜ Trophy Stats (Total Trophies): ','');
      document.getElementById('editUsername').value =
        document.querySelector(".username-info")?.textContent.replace("üë§ Username: ","") || '';
      document.getElementById('editPlatform').value =
        document.querySelector(".platform-info")?.textContent.replace("üîπ Platform: ","") || '';
    };
    window.closeEditModal = ()=> document.getElementById('editModal').style.display='none';

    window.saveProfileChanges = async function(){
      const user = auth.currentUser;
      if(!user){ alert("You must be signed in to update your profile."); return; }

      const games       = document.getElementById('editGames').value.trim();
      const gamesPlayed = document.getElementById('editGamesPlayed').value.trim();
      const imageUrls   = document.getElementById('editGameImages').value.split(',').map(s=>s.trim()).filter(Boolean);
      const trophies    = document.getElementById('editTrophies').value.trim();
      const username    = document.getElementById('editUsername').value.trim();
      const platform    = document.getElementById('editPlatform').value;

      await setDoc(doc(db,"users",user.uid),{
        username, platform,
        favoriteGames: games ? games.split(',').map(s=>s.trim()) : [],
        gamesPlayed: gamesPlayed ? parseInt(gamesPlayed) : 0,
        favoriteImages: imageUrls,
        trophyCount: trophies ? parseInt(trophies) : 0
      },{ merge:true });

      await loadProfile(user.uid);
      closeEditModal();
    };

    // Logout
    document.getElementById("logoutBtn")?.addEventListener("click", async ()=>{
      try{
        await signOut(auth);
        document.getElementById("profile-box").style.display="none";
        location.href="index.html";
      }catch(err){ alert("Error signing out: "+err.message); }
    });

    // Sign-out notice helpers
    window.showAuthNotice = function(){
      document.getElementById("authNotice").style.display="block";
      setTimeout(hideAuthNotice, 10000);
    };
    window.hideAuthNotice = function(){
      document.getElementById("authNotice").style.display="none";
    };

    // Auth gate
    onAuthStateChanged(auth,(user)=>{
      const profileBox=document.getElementById("profile-box");
      if(user){ profileBox.style.display="block"; loadProfile(user.uid); }
      else { profileBox.style.display="none"; showAuthNotice(); }
    });
  </script>

  <!-- Stats + Spotlight + Alerts + Talk + Character + Retro -->
  <script type="module">
    import {
      getFirestore, collection, query, where, orderBy, limit, getDocs,
      getCountFromServer, Timestamp, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const db   = window.db   || getFirestore();
    const auth = window.auth || getAuth();
    const $ = id => document.getElementById(id);

    /* Helpers */
    function setText(id,val){ const el=$(id); if(el) el.textContent=String(val); }
    async function safeCount(colName, parts=[]){
      try{
        const base=collection(db,colName);
        const q=parts.length?query(base,...parts):base;
        const snap=await getCountFromServer(q);
        return snap.data().count||0;
      }catch{ return 0; }
    }
    async function countSubmissions({type=null,hasVideo=false}={}){
      try{
        if(type){ const n=await safeCount("submissions",[where("type","==",type)]); if(n) return n; }
      }catch{}
      try{
        const qs=await getDocs(query(collection(db,"submissions"),orderBy("timestamp","desc"),limit(200)));
        return qs.docs.filter(d=>{
          const x=d.data()||{};
          const okType= type ? String(x.type||"").toLowerCase()===type : true;
          const okVid = hasVideo ? !!x.videoUrl : true;
          return okType && okVid;
        }).length;
      }catch{ return 0; }
    }
    async function sumPollVotes(){
      try{
        const qs=await getDocs(collection(db,"polls"));
        return qs.docs.reduce((sum,d)=>{
          const p=d.data()||{};
          if(typeof p.totalVotes==="number") return sum+p.totalVotes;
          if(Array.isArray(p.options)) return sum+p.options.reduce((s,o)=> s+Number(o.votes ?? o.count ?? 0),0);
          if(p.choices && typeof p.choices==="object") return sum+Object.values(p.choices).reduce((s,v)=> s+Number(v||0),0);
          return sum;
        },0);
      }catch{ return 0; }
    }

    /* Retro facts + Character sync */
    const RetroFacts=[
      "üïπÔ∏è Donkey Kong (1981) introduced Jumpman ‚Äî who later became Mario.",
      "üß± Tetris (1984) was created by a Soviet engineer and smuggled out of the USSR.",
      "üíæ NES cartridges used lockout chips to prevent unlicensed games.",
      "üéØ Pong (1972) was so popular the original machine overflowed with quarters and broke.",
      "üëæ Space Invaders (1978) was the first game to get harder as you played.",
      "üé§ Mortal Kombat helped spark the ESRB rating system.",
      "üåÄ SNES Mode 7 enabled faux-3D in F-Zero and Mario Kart."
    ];
    window.loadRetroFact=function(){
      const fact=RetroFacts[Math.floor(Math.random()*RetroFacts.length)];
      setText("retro-fact",fact);
    };

    const CharacterAssignments=[
      { name:"Peter Parker / Spider-Man", role:"superhero", desc:"Smarts, strength, and soul. You choose right ‚Äî even when it costs you.", img:"https://cdn2.unrealengine.com/egs-marvelsspidermandigitaldeluxeedition-insomniacgamesnixxessoftware-editions-g1a-00-1920x1080-f8f8dc068a4d.jpg", platforms:["PlayStation","PC"] },
      { name:"Kratos", role:"anti-hero", desc:"Fueled by rage, guided by growth. You don‚Äôt run ‚Äî you conquer.", img:"https://w0.peakpx.com/wallpaper/909/900/HD-wallpaper-kratos-game-games-god-of-war-playstation-ps4-ps5-video-games-thumbnail.jpg", platforms:["PlayStation"] },
      { name:"Miles Morales", role:"superhero", desc:"Weight of two worlds, still moving with purpose. You‚Äôre the spark.", img:"https://static0.gamerantimages.com/wordpress/wp-content/uploads/2021/02/spider-man-miles-morales-web-fired-at-screen-night-time.jpg", platforms:["PlayStation","PC"] },
      { name:"Aloy", role:"hunter-protector", desc:"Curiosity + courage. You push boundaries to save the world.", img:"https://media.wired.com/photos/623233505f9392d9abe3e43e/master/pass/Horizon-Forbidden-West-Spoilers-Character-Games-Culture.jpg", platforms:["PlayStation","PC"] },
      { name:"Jin Sakai", role:"samurai-turned-ghost", desc:"Honor matters ‚Äî survival adapts. You do what it takes.", img:"https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/f03405b5-4361-4440-9bd3-6e7db6e9d0e2/dhozwq1-b24c7a15-142b-4437-8f67-de4e96005537.jpg", platforms:["PlayStation"] },
      { name:"Ratchet", role:"galactic hero", desc:"Inventive, loyal, always ready to blast through challenge.", img:"https://platform.theverge.com/wp-content/uploads/sites/2/chorus/uploads/chorus_asset/file/22528658/RACRA_Juggernaut_Legal_scaled.jpeg?quality=90&strip=all&crop=7.8125,0,84.375,100", platforms:["PlayStation"] },
      { name:"Mario", role:"hero-plumber", desc:"Heart and hustle. It‚Äôs-a you!", img:"https://static0.gamerantimages.com/wordpress/wp-content/uploads/2023/03/super-mario-odyssey-sequel-beanbean-kingdom.jpg", platforms:["Nintendo"] },
      { name:"Donkey Kong", role:"jungle powerhouse", desc:"Bold, strong, unshakable. Loyal to your crew.", img:"https://metro.co.uk/wp-content/uploads/2025/06/SEI_255987806-22f2.jpg?quality=90&strip=all&w=646", platforms:["Nintendo"] }
    ];
    window.updateCharacterOptions=function(){
      const platform=document.getElementById("platform-select").value;
      const roleEl=$("character-role"), descEl=$("character-desc"), imgEl=$("character-image"), msgEl=$("no-character-msg");
      if(!platform){ roleEl.textContent=""; descEl.textContent=""; imgEl.src="GSU_LOGO.png"; msgEl.style.display="block"; return; }
      const list=CharacterAssignments.filter(c=>c.platforms.includes(platform));
      if(!list.length){ roleEl.textContent=""; descEl.textContent=""; imgEl.src="GSU_LOGO.png"; msgEl.style.display="block"; return; }
      const pick=list[Math.floor(Math.random()*list.length)];
      roleEl.textContent=`üéÆ You Are: ${pick.name} (${pick.role})`;
      descEl.textContent=pick.desc; imgEl.src=pick.img; msgEl.style.display="none";
    };
    document.addEventListener("DOMContentLoaded",()=>{ loadRetroFact(); updateCharacterOptions(); });

    /* Stats */
    window.populateStats = async function(){
      const sevenDaysAgo=Timestamp.fromDate(new Date(Date.now()-7*24*3600*1000));
      const totalMembers=await safeCount("users");
      const newMembers  =await safeCount("users",[where("createdAt",">=",sevenDaysAgo)]);
      const videoUploads=await countSubmissions({hasVideo:true});
      const fanArt      =await safeCount("community_art");
      const trophies    =await safeCount("community_trophies");
      const combos      =await countSubmissions({type:"combo"});
      const pollVotes   =await sumPollVotes();

      setText("totalMembers",totalMembers);
      setText("newMembers",newMembers);
      setText("videoUploads",videoUploads);
      setText("fanArt",fanArt);
      setText("trophies",trophies);
      setText("combos",combos);
      setText("pollVotes",pollVotes);
    };

    /* Featured clip */
    const H24=24*60*60*1000;
    const since=Timestamp.fromDate(new Date(Date.now()-H24));
    async function buildUnionWatch(){
      const media=$("unionWatchMedia"), title=$("unionWatchTitle"), cap=$("unionWatchCaption");
      if(!media) return;
      let docHit=null;
      try{
        const qs=await getDocs(query(collection(db,"submissions"),where("timestamp",">=",since),orderBy("timestamp","desc"),limit(15)));
        docHit=qs.docs.map(d=>({id:d.id,...d.data()})).find(x=>x.videoUrl);
      }catch{}
      if(!docHit){
        try{
          const qs=await getDocs(query(collection(db,"submissions"),orderBy("timestamp","desc"),limit(20)));
          docHit=qs.docs.map(d=>({id:d.id,...d.data()})).find(x=>x.videoUrl);
        }catch{}
      }
      if(!docHit){ title.textContent="No featured clip yet ‚Äî be the first!"; cap.textContent=""; media.innerHTML=""; return; }
      const user=await (async uid=>{
        try{ const s=await getDoc(doc(db,"users",uid)); const u=s.data()||{}; return u.username || (u.email?.split("@")[0]) || "GSU_Player"; }
        catch{ return "GSU_Player"; }
      })(docHit.userId);

      const embed = (url=>{
        try{
          const u=new URL(url);
          if(u.hostname.includes("youtu.be")) return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
          if(u.hostname.includes("youtube.com")){
            const id=u.searchParams.get("v"); if(id) return `https://www.youtube.com/embed/${id}`;
          }
        }catch{}
        return "";
      })(docHit.videoUrl);

      media.innerHTML = embed
        ? `<iframe src="${embed}" allowfullscreen></iframe>`
        : `<img src="${docHit.cover || 'GSU_LOGO.png'}" class="showoff-img" alt="Featured clip">`;
      title.textContent=`@${user} ‚Äî ${docHit.title || "Featured Clip"}`;
      cap.textContent=docHit.caption || "Certified GSU moment.";
    }

    /* Certified moment */
    async function buildCertifiedMoment(){
      const img=$("certifiedImg"), p=$("certifiedCaption");
      if(!img||!p) return;
      try{
        const qs=await getDocs(query(collection(db,"community_trophies"),orderBy("timestamp","desc"),limit(1)));
        const d=qs.docs[0]?.data();
        if(!d){ p.textContent="No trophies yet ‚Äî earn one and take the spotlight."; img.src="GSU_LOGO.png"; return; }
        const s=await getDoc(doc(db,"users",d.userId)); const u=s.data()||{};
        img.src=d.cover || "GSU_LOGO.png"; img.alt=d.game || "Trophy";
        p.innerHTML = `"${d.title || d.description || 'New Trophy'}" ‚Äî <strong>@${u.username || (u.email?.split("@")[0]) || 'GSU_Player'}</strong>`;
      }catch{ p.textContent="Couldn‚Äôt load trophies."; }
    }

    /* Talk of the week */
    async function buildTalkOfWeek(){
      const q=$("talkQuoteText"), w=$("talkQuoteWho"); if(!q||!w) return;
      try{
        const qs=await getDocs(query(collection(db,"submissions"),orderBy("timestamp","desc"),limit(10)));
        const hit=qs.docs.map(d=>d.data()).find(x => (x.caption||"").trim().length>0);
        if(!hit){ q.textContent="‚ÄúBro didn‚Äôt dodge ‚Äî he teleported üíÄ‚Äù"; w.textContent="‚Äî GSU Lounge"; return; }
        const s=await getDoc(doc(db,"users",hit.userId)); const u=s.data()||{};
        const text=String(hit.caption).trim().replace(/^["‚Äú]|["‚Äù]$/g,"");
        q.textContent=`‚Äú${text}‚Äù`; w.textContent=`‚Äî @${u.username || (u.email?.split("@")[0]) || 'GSU_Player'}`;
      }catch{ q.textContent="‚ÄúWe‚Äôre syncing up the quote feed‚Ä¶‚Äù"; w.textContent="‚Äî GSU"; }
    }

    /* Alerts (24h) */
    async function buildAlerts(){
      const list=$("alertsList"); if(!list) return;
      list.innerHTML="<li>Loading‚Ä¶</li>";
      const rows=[];
      async function pushFrom(col,maker){
        try{
          const qs=await getDocs(query(collection(db,col),where("timestamp",">=",since),orderBy("timestamp","desc")));
          for(const d of qs.docs){
            const x=d.data()||{};
            let user="GSU_Player";
            try{
              const s=await getDoc(doc(db,"users",x.userId)); const u=s.data()||{};
              user = u.username || (u.email?.split("@")[0]) || "GSU_Player";
            }catch{}
            const line=maker(x,user);
            if(line) rows.push(`<li>${line}</li>`);
          }
        }catch{}
      }
      await pushFrom("submissions",(x,u)=>{
        if(x.videoUrl) return `üé• New upload: <strong>${x.title || 'Clip'}</strong> ‚Äî @${u}`;
        if((x.type||"").toLowerCase()==="combo") return `ü•ä New combo guide: <strong>${x.title || 'Combo'}</strong> ‚Äî @${u}`;
        return null;
      });
      await pushFrom("community_art",(x,u)=> `üé® New art: <strong>${x.title || 'Art drop'}</strong> ‚Äî @${u}`);
      await pushFrom("community_trophies",(x,u)=> `üèÜ New trophy: <strong>${x.title || x.game || 'Trophy'}</strong> ‚Äî @${u}`);
      list.innerHTML = rows.length ? rows.join("") : `<li>No new drops in the last 24 hours ‚Äî be the first! üîî</li>`;
    }

    /* Spotlight (YouTube) */
    const youtubeApiKey="YOUR_YOUTUBE_API_KEY"; // add your key
    async function rotateYouTubeVideosForUser(uid){
      const cont=$("fav-game-updates"); if(!cont) return;
      if(!youtubeApiKey || youtubeApiKey==="YOUR_YOUTUBE_API_KEY"){
        cont.innerHTML=`<div class="spotlight-video"><p style="color:var(--gsu-red);margin:0">Add your YouTube API key to enable personalized gameplay drops.</p></div>`;
        return;
      }
      try{
        const snap=await getDoc(doc(db,"users",uid));
        if(!snap.exists()){ cont.innerHTML="<p style='color:#ff6b6b; text-align:center'>No user data found.</p>"; return; }
        const { favoriteGames } = snap.data(); 
        if(!Array.isArray(favoriteGames) || !favoriteGames.length){
          cont.innerHTML="<p style='color:#ff6b6b; text-align:center'>No favorite games set.</p>"; return;
        }
        cont.innerHTML="<p style='text-align:center; color:#ccc'>Loading gameplay drops‚Ä¶</p>";
        const blocks = await Promise.all(
          favoriteGames.slice(0,3).map(async title=>{
            const q = encodeURIComponent(`${title} gameplay`);
            try{
              const res=await fetch(`https://www.googleapis.com/youtube/v3/search?key=${youtubeApiKey}&part=snippet&type=video&maxResults=5&q=${q}`);
              const data=await res.json();
              const video=data.items?.find(i=>i.id?.videoId)?.id?.videoId;
              if(!video) throw new Error("No video");
              return `<div class="spotlight-video"><iframe src="https://www.youtube.com/embed/${video}" allowfullscreen></iframe><h3 style="margin:.4rem 0 0">üéÆ ${title}</h3><p style="color:var(--muted);margin:.2rem 0 0">Powered by YouTube</p></div>`;
            }catch{
              return `<div class="spotlight-video"><p style="color:#ff6b6b;margin:0">Failed to load videos for <strong>${title}</strong></p></div>`;
            }
          })
        );
        cont.innerHTML=blocks.join("");
      }catch{
        cont.innerHTML="<p style='color:#ff6b6b; text-align:center'>Could not load personalized videos.</p>";
      }
    }

    /* Run page */
    async function runHome(){
      try{ await window.populateStats?.(); }catch{}
      await Promise.all([buildUnionWatch(), buildCertifiedMoment(), buildTalkOfWeek(), buildAlerts()]);
      const user=auth.currentUser; const cont=$("fav-game-updates");
      if(cont){ user ? rotateYouTubeVideosForUser(user.uid) : cont.innerHTML="<p style='text-align:center; color:#ff6b6b'>Log in to see personalized videos.</p>"; }
    }

    document.addEventListener("DOMContentLoaded",runHome);
    onAuthStateChanged(auth,runHome);
    setInterval(buildAlerts,10*60*1000);
  </script>
</body>
</html>
