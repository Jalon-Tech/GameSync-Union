<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GameSync Union</title>
  <link rel="icon" href="GSU_LOGO.png" />
  <link rel="apple-touch-icon" href="GSU_LOGO.png" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />

  <style>
    :root { --gsu-red:#e60023; --black-main:#191818; --black-faded:#1F1F1F; --white-text:#FFFFFF; }
    *{margin:0; padding:0; box-sizing:border-box;}
    body{ font-family:'Roboto',sans-serif; background:var(--black-main); color:var(--white-text); }

    header { background:var(--black-faded); display:flex; justify-content:space-between; align-items:center; padding:1rem 2rem; flex-wrap:wrap; gap:1rem; position:relative; z-index:1000; }
    .logo{ display:flex; align-items:center; }
    .logo img{ height:60px; margin-right:1rem; }
    .logo-text{ font-size:1.6rem; font-family:'Montserrat',sans-serif; color:var(--white-text); }
    nav{ display:flex; flex-wrap:wrap; gap:1rem; }
    nav a{ text-decoration:none; color:var(--white-text); font-family:'Montserrat',sans-serif; transition:color .3s; font-size:1rem; }
    nav a:hover{ color:var(--gsu-red); }

    .main-container{ display:grid; grid-template-columns:1fr 3fr 1fr; gap:1.5rem; padding:2rem; }
    aside, main{ display:flex; flex-direction:column; gap:1.2rem; }
    .box{ background:var(--black-faded); border-radius:12px; padding:1rem; color:var(--white-text); transition:transform .3s, box-shadow .3s, border .3s; border:2px solid #333; box-shadow:0 0 12px rgba(255,255,255,.05); }
    .box:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 6px 16px rgba(230,0,35,.4), 0 0 10px rgba(255,255,255,.05); border:2px solid var(--gsu-red); }
    .box h2{ font-family:'Montserrat',sans-serif; margin-bottom:.7rem; color:#fff!important; text-shadow:0 0 6px rgba(255,0,55,.3); }
    main > .box:not(:last-child) { margin-bottom:2.2rem; }

    .input-field{ padding:.6rem; border:none; border-radius:6px; margin-bottom:.6rem; width:100%; background:#2a2a2a; color:var(--white-text); }
    .btn{ background:var(--gsu-red); border:none; color:#fff; padding:.8rem; width:100%; border-radius:6px; cursor:pointer; font-family:'Montserrat',sans-serif; }
    .btn:hover{ opacity:.85; }

    footer{ background:var(--black-faded); text-align:center; padding:1.2rem 1rem; margin-top:4rem; }
    .platform-icons{ display:flex; justify-content:center; align-items:center; gap:1.5rem; margin-bottom:.6rem; }
    .platform-icons img{ height:32px; width:auto; opacity:.9; }

    .stat-box { margin-bottom:12px; padding:10px 15px; border:2px solid #e60023; border-radius:10px; background:rgba(255,255,255,0.05); transition:margin .3s ease; }
    #profile-box { background:linear-gradient(to bottom right,#1e1e1e,#282828); border:2px solid var(--gsu-red); box-shadow:0 0 12px rgba(230,0,35,.2); border-radius:10px; text-align:center; font-size:1rem; }
    .update-flash-img { animation: flashGlow 1.3s ease-in-out; }
    @keyframes flashGlow {
      0%   { background-color:#e60023; color:#fff; border:2px solid #fff; box-shadow:0 0 18px 6px #e60023; margin-bottom:14px; }
      50%  { background-color:rgba(230,0,35,0.15); color:#e60023; border:2px solid #e60023; box-shadow:0 0 28px 10px #e60023; margin-bottom:24px; }
      100% { background-color:transparent; color:#fff; border:2px solid #e60023; box-shadow:none; margin-bottom:14px; }
    }

    .retro-header { font-size:1.1rem; color:var(--gsu-red); font-family:'Montserrat',sans-serif; margin-bottom:.6rem; }
    .match-review-style h2 { color:#e60023; font-family:'Montserrat',sans-serif; font-size:1.2rem; margin-bottom:.75rem; text-shadow:0 0 8px rgba(230,0,35,.7); border-bottom:2px solid #e60023; padding-bottom:.5rem; }
    .match-review-style { background:#1f1f1f; border:2px solid #333; border-radius:12px; padding:1rem; box-shadow:0 0 12px rgba(255,255,255,.05); }
    .review-box { border:2px solid #fff; background:#1c1c1c; color:#fff; padding:.75rem; border-radius:10px; width:100%; resize:vertical; min-height:100px; }

    .livewire-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:1rem; margin-top:1rem; }
    .stat-item { background:#2a2a2a; padding:1rem; border-radius:8px; font-size:.95rem; font-family:'Roboto',sans-serif; box-shadow:0 0 6px rgba(0,0,0,.3); }

    .culture-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:1rem; text-align:center; }
    .culture-tile { background:#2a2a2a; padding:1.4rem 1rem; border-radius:10px; font-family:'Montserrat',sans-serif; font-size:1rem; color:#fff; text-decoration:none; transition:transform .3s, background .3s; }
    .culture-tile:hover { background:var(--gsu-red); transform:scale(1.05); }
    .tile-hover { margin-top:.4rem; font-size:.85rem; color:#ddd; }

    #fav-images{ display:flex; overflow-x:auto; gap:1rem; padding:1rem 0; scroll-snap-type:x mandatory; border:1px solid #444; border-radius:10px; background:#1b1b1b; }
    #fav-images img{ height:280px; object-fit:contain; background:#111; border-radius:12px; padding:6px; }

    #spotlight3{ background:linear-gradient(to bottom right,#1f1f1f,#262626); border:2px solid transparent; border-radius:12px; padding:2rem 1.5rem; box-shadow:0 0 16px rgba(230,0,35,.3); text-align:center; max-width:800px; margin:1.5rem auto; }
    #spotlight3:hover{ border-color:var(--gsu-red); }
    #fav-game-updates{ display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:2rem; padding:1rem; margin-top:1rem; }
    .spotlight-video{ background:#2a2a2a; padding:1rem; border-radius:10px; border:2px solid transparent; }
    .spotlight-video iframe{ width:100%; height:200px; border:none; border-radius:8px; margin:.6rem 0; }

    .showoff-card { display:flex; gap:1rem; flex-wrap:wrap; align-items:center; background:#2a2a2a; border-radius:10px; padding:1rem; }
    .showoff-img { width:200px; height:120px; object-fit:cover; border-radius:8px; }

    .talk-quote { background:#2a2a2a; padding:1rem 1.2rem; border:4px solid var(--gsu-red); border-radius:8px; font-style:italic; }
    .certified-moment { text-align:center; }
    .certified-img { width:100%; max-width:400px; height:auto; border-radius:10px; margin-bottom:.8rem; }

    .modal{ display:none; position:fixed; z-index:100; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,.7); }
    .modal-content{ background:var(--black-faded); margin:10% auto; padding:24px; border:2px solid var(--gsu-red); border-radius:12px; width:80%; max-width:500px; color:var(--white-text); }
    .modal-content input{ width:100%; padding:12px; margin:10px 0 18px; background:#2a2a2a; color:#fff; border:1px solid #444; border-radius:6px; }

    @media (max-width:1024px){ .main-container{ grid-template-columns:1fr; padding:1rem; } header{ flex-direction:column; align-items:flex-start; } }
    @media (max-width:600px){ .logo img{ height:40px; } .logo-text{ font-size:1.2rem; } nav a{ font-size:.9rem; } .btn{ padding:.7rem; } .input-field{ font-size:.9rem; } }
  </style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="GSU_LOGO.png" alt="GSU Logo" />
      <div class="logo-text">GAMESYNC UNION</div>
    </div>
    <nav>
      <a href="index.html">Home</a>
      <a href="games.html">Games</a>
      <a href="trophies.html">GSU Hall of Trophies & Achievements</a>
      <a href="art.html">Art</a>
      <a href="game-guides.html">GSU Gameplay Center</a>
      <a href="uploads.html">GSU Player Lounge</a>
    </nav>
    <button id="logoutBtn" class="btn" style="max-width:120px; background-color:#777;">Log Out</button>
  </header>

  <div class="main-container">
    <!-- LEFT COLUMN -->
    <aside>
      <div class="box" id="auth-box">
        <h2>Create Account or Sign In</h2>
        <input type="text" class="input-field" placeholder="Email" />
        <input type="text" class="input-field" placeholder="Username" />
        <input type="password" class="input-field" placeholder="Password" />
        <button class="btn">Sign In</button>
        <p style="text-align:center; margin-top:.6rem;">
          Not a GSU member?
          <button class="btn" id="createAccountBtn" style="display:block; margin:1rem auto; padding:.25rem .75rem; font-size:.85rem;">
            Create your GSU account
          </button>
        </p>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üïπÔ∏è Retro Game Flashback</h2>
        <p style="font-size:.9rem; color:#ccc; margin-bottom:.8rem;">
          Step back into the early days of gaming. One random flashback every click.
        </p>
        <div class="retro-body">
          <div class="game-title">From here, the Retroverse info unfolds.</div>
          <div class="game-fact" id="retro-fact" style="max-height:90px; overflow-y:auto;">Loading fact...</div>
          <button class="btn" onclick="loadRetroFact()" style="margin-top:.8rem; font-size:.85rem;">üïπÔ∏è Spin the Retro Wheel</button>
        </div>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üéÆ GSU Character Sync-Up</h2>
        <p style="font-size:.9rem; color:#ccc; margin-bottom:1rem;">
          Choose your platform to reveal which video game legend is synced with your GSU energy.
        </p>

        <label class="sync-label">üïπÔ∏è Choose Your Platform to Begin the Sync:</label>
        <select id="platform-select" class="input-field" onchange="updateCharacterOptions()">
          <option value="">-- Choose Platform --</option>
          <option value="PlayStation">PlayStation</option>
          <option value="PC">PC</option>
          <option value="Xbox">Xbox</option>
          <option value="Nintendo">Nintendo</option>
        </select>

        <div id="no-character-msg" style="color:red; font-size:.9rem; margin-bottom:1rem; text-align:center;">No Video Game Character in Sync.</div>

        <div id="character-role" class="sync-role" style="text-align:center; font-weight:600; margin:.5rem 0;"></div>
        <div style="border:2px solid #e60023; border-radius:12px; padding:12px; background:#1a1a1a;">
          <div style="display:flex; flex-wrap:wrap; gap:.5rem; justify-content:center;">
            <img id="character-image" src="GSU_LOGO.png" alt="Character" style="height:140px; width:140px; object-fit:contain; border-radius:10px; padding:6px; background-color:#000; border:1px solid #444;">
            <div id="character-desc" style="font-size:.9rem; max-width:260px; color:#ccc; text-align:left;">Choose your platform to reveal your synced legend.</div>
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER COLUMN -->
    <main>
      <div class="box" style="text-align:center;">
        <h2>Welcome to GameSync Union</h2>
        <p style="margin-bottom:1rem;">No pause. No kink. Just raw sync ‚Äî GameSync Union is where gamers link.</p>
        <button class="btn" onclick="window.location.href='about.html'"><h3>üìòüéÆ The Full Breakdown: GameSync Union Explained</h3></button>
      </div>

      <div class="box" id="profile-box">
        <h2 style="color:var(--gsu-red);">Your Profile</h2>
        <p id="fav-games" class="stat-box">üî• Favorite Games</p>
        <p id="games-played" class="stat-box">üéÆ Number Of Games Played</p>
        <p id="trophy-stats" class="stat-box">üèÜ Trophy Stats (Total Trophies)</p>

        <div style="margin-top:1rem;">
          <label style="color:#ccc; font-size:.9rem;">üéÆ Synced Game Covers ‚Äì Pulled from Your Top 3 Favorites</label>
        </div>
        <div id="fav-images"></div>

        <div style="margin-top:1rem; text-align:center;">
          <button onclick="openEditModal()" class="btn" style="max-width:240px;">Update GSU Profile</button>
        </div>
      </div>

      <input type="text" class="input-field" placeholder="Search guides, uploads, art, users, or trophies..." />

      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üî• Statline Supreme: All Union. All Synced.</h2>
        <div class="livewire-stats">
          <div class="stat-item">üë• Total GSU Members: <span id="totalMembers">_</span></div>
          <div class="stat-item">üÜï New Members This Week: <span id="newMembers">_</span></div>
          <div class="stat-item">üìπ Videos Shared Across the GSU Community: <span id="videoUploads">_</span></div>
          <div class="stat-item">üé® Fan Art Pieces Shared: <span id="fanArt">_</span></div>
          <div class="stat-item">üèÜ Trophies Earned by GSU Players: <span id="trophies">_</span></div>
          <div class="stat-item">ü•ä Combo Guides Shared: <span id="combos">_</span></div>
          <div class="stat-item">üìä Total Community Poll Votes: <span id="pollVotes">_</span></div>
        </div>
      </div>

      <!-- üî• Made the Union Watch (dynamic) -->
      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üî• Made the Union Watch</h2>
        <p style="text-align:center; font-family:'Roboto'; color: var(--white-text);">
          When the Union highlights you ‚Äî it means something. Real gameplay earns the light.
        </p>

        <div class="showoff-card" id="unionWatch" style="flex-direction:column; align-items:center;">
          <div id="unionWatchMedia" style="width:100%; max-width:720px;"></div>
          <div class="showoff-info" style="text-align:center;">
            <h3 id="unionWatchTitle">Loading featured clip‚Ä¶</h3>
            <p id="unionWatchCaption"></p>
          </div>
        </div>

        <div style="width:100%; display:flex; justify-content:center; margin-top:1.2rem;">
          <button onclick="window.location.href='uploads.html'" class="btn" style="width:100%; max-width:240px;">See Why Everyone‚Äôs Talking</button>
        </div>
      </div>

      <!-- üëë Certified Moment (dynamic) -->
      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üëë One Trophy. One Flex.</h2>
        <div class="certified-moment">
          <img id="certifiedImg" src="GSU_LOGO.png" alt="Moment Screenshot" class="certified-img" />
          <p class="certified-caption" id="certifiedCaption">Finding a legendary flex‚Ä¶</p>
          <div style="text-align:center;">
            <button class="btn" onclick="window.location.href='trophies.html'" style="margin:0 auto; display:inline-block; max-width:220px;">Relive the Moment</button>
          </div>
        </div>
      </div>

      <!-- üé≠ Talk of the Week (dynamic) -->
      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üé≠ Union Rewind: Talk of the Week</h2>
        <div class="talk-quote">
          <blockquote id="talkQuoteText">Scanning the Lounge‚Ä¶</blockquote>
          <p id="talkQuoteWho">‚Äî</p>
        </div>
      </div>

      <!-- üì° Union Alerts (last 24h) -->
      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üì° Union Alerts (last 24h)</h2>
        <ul class="incoming-drop" id="alertsList">
          <li>Loading fresh drops‚Ä¶</li>
        </ul>
      </div>

      <div class="box">
        <h2 style="color:var(--gsu-red); font-family:'Montserrat',sans-serif; text-align:center;">üí™ Built by GSU. Flexed by Gamers.</h2>
        <div class="culture-grid">
          <a href="games.html" class="culture-tile">üéÆ Game Lineup<div class="tile-hover">What We‚Äôre Really Playing.</div></a>
          <a href="boss-fight-strategies.html" class="culture-tile">‚öîÔ∏è Boss Fight Guides<div class="tile-hover">Dominate Every Encounter.</div></a>
          <a href="gameplay-tutorials.html" class="culture-tile">üéì Gameplay Tutorials<div class="tile-hover">Learn Fast. Play Smarter.</div></a>
          <a href="community-gameplay-videos.html" class="culture-tile">üé• Gameplay Hub<div class="tile-hover">Your Best Runs. On Display.</div></a>
          <a href="combo-guides.html" class="culture-tile">ü•ä Combo Guides<div class="tile-hover">Damage That Matters.</div></a>
          <a href="trophy-tips.html" class="culture-tile">üìà Trophy Tips<div class="tile-hover">Level Up Without Wasting Time.</div></a>
          <a href="uploads.html" class="culture-tile">üí¨ Player Lounge<div class="tile-hover">Talk Real. Squad Up.</div></a>
          <a href="art.html" class="culture-tile">üñºÔ∏è Fan Art<div class="tile-hover">Clipped. Posted. Respected.</div></a>
        </div>
      </div>

      <!-- Spotlight videos personalized -->
      <div class="box" id="spotlight3">
        <h2>üéÆ GameSync Spotlight 3</h2>
        <p>Daily gameplay drops from the titles that matter to you.</p>
        <div id="fav-game-updates"></div>
      </div>
    </main>

    <!-- RIGHT COLUMN -->
    <aside>
      <div class="box match-review-style">
        <h2 class="retro-header">üïπÔ∏è The GameSync Game Room</h2>
        <p style="font-size:.9rem; color:#ccc; margin-bottom:.8rem;">Quick hitters that test reflexes, focus, and precision.</p>
        <div class="retro-body" style="display:flex; flex-direction:column; gap:.5rem;">
          <button class="btn" style="font-size:.85rem;" onclick="location.href='Charge_Run.html'">GSU Charge Run</button>
          <button class="btn" style="font-size:.85rem;">GSU Command Strike</button>
          <button class="btn" style="font-size:.85rem;">GSU Cipher Storm</button>
        </div>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üß† Game Dev Knowledge Drop</h2>
        <p style="font-size:.9rem; color:#ccc; margin-bottom:.8rem;">Level design is more psychology than geometry.</p>
        <div class="retro-body" style="display:flex; flex-direction:column; gap:.5rem;">
          <div style="font-size:.85rem;">üìò Analyzing flow, affordances, and feedback loops.</div>
          <button class="btn" style="font-size:.85rem;">üìö Learn More</button>
        </div>
      </div>

      <div class="box match-review-style">
        <h2 class="retro-header">üí¨ GSU Vibe Check</h2>
        <p style="font-size:.9rem; color:#ccc; margin-bottom:.8rem;">We scan the Lounge, uploads, and plays for the pulse.</p>
        <div class="retro-body" style="display:flex; flex-direction:column; gap:.6rem;">
          <div style="font-size:1rem; color:#fff; font-weight:bold;">üî• Mood: Hype & Competitive</div>
          <div style="font-size:.85rem; color:#bbb;">Top quoted: ‚ÄúDon‚Äôt get perfect-parried again.‚Äù</div>
          <div style="font-size:.85rem; color:#bbb;">Top activity: Trophy flexes + fan art drops</div>
          <button class="btn" style="margin-top:.6rem; font-size:.85rem;">üì° Scan Live Vibe</button>
        </div>
      </div>
    </aside>
  </div>

  <footer>
    <div class="platform-icons">
      <img src="PS_Logo.png" alt="PlayStation" />
      <img src="Xbox.png" alt="Xbox" />
      <img src="Steam.png" alt="PC" />
      <img src="Switch.png" alt="Nintendo Switch" />
    </div>
    <p>&copy; 2025 GameSync Union. Built for gamers, by gamers.</p>
  </footer>

  <!-- Edit Modal -->
  <div id="editModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeEditModal()" style="float:right; font-size:28px; color:var(--gsu-red); cursor:pointer;">&times;</span>
      <h2>Update Profile</h2>

      <label>Username:</label>
      <input type="text" id="editUsername" placeholder="Change your Username">

      <label>Platform:</label>
      <select id="editPlatform" class="input-field">
        <option value="">-- Select your new Platform --</option>
        <option value="PlayStation">PlayStation</option>
        <option value="PC">PC</option>
        <option value="Xbox">Xbox</option>
        <option value="Nintendo">Nintendo</option>
        <option value="Multiple">Multiple Platforms</option>
      </select>

      <label>Favorite Games (comma-separated):</label>
      <input type="text" id="editGames" placeholder="Spider-Man 2, Ratchet & Clank...">

      <label>Number of Games Played:</label>
      <input type="number" id="editGamesPlayed" min="0">

      <label>Favorite Games' Cover Image URLs (comma-separated):</label>
      <input type="text" id="editGameImages" placeholder="url1, url2, url3">

      <label>Total Trophy Count:</label>
      <input type="number" id="editTrophies" min="0">

      <button class="btn" onclick="saveProfileChanges()" style="margin-top:.5rem;">Save Changes</button>
    </div>
  </div>

  <!-- Signed-out notice -->
  <div id="authNotice" style="display:none; position:fixed; top:12%; left:50%; transform:translateX(-50%); background:#ffffff; color:#e60023; border:2px solid #e60023; padding:1.25rem 1.5rem; border-radius:12px; z-index:9999; font-family:'Montserrat',sans-serif; font-size:.95rem; max-width:360px; box-shadow:0 0 20px rgba(0,0,0,.3); text-align:center; line-height:1.6;">
    <div style="color:#000; font-weight:bold; margin-bottom:.75rem; font-size:1rem;">Signed out:</div>
    <div style="margin-bottom:1rem;">Access limited ‚Äî sign in or create your GSU account to get the full GSU experience.</div>
    <button onclick="hideAuthNotice()" style="background:#e60023; color:#fff; border:none; padding:.5rem 1rem; border-radius:8px; font-family:'Montserrat'; cursor:pointer;">Close</button>
  </div>
  <div id="authOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,.5); z-index:9998;"></div>

  <!-- ========================= JS ========================= -->

  <!-- Firebase core + SDKs -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, setPersistence, browserLocalPersistence, signOut } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

    // --- Firebase config (yours) ---
    const firebaseConfig = {
      apiKey: "AIzaSyBA7aIUj919ub7QtkQkAp-xv4XC0tzmSCI",
      authDomain: "gamesync-union.firebaseapp.com",
      projectId: "gamesync-union",
      storageBucket: "gamesync-union.appspot.com",
      messagingSenderId: "488911705365",
      appId: "1:488911705365:web:ad8b3be7936a46bb77c51c",
      measurementId: "G-CP48EXW1EV"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Persist login
    setPersistence(auth, browserLocalPersistence).catch(console.error);

    // Expose globally for other modules
    window.db = db; window.auth = auth; window.doc = doc; window.getDoc = getDoc; window.setDoc = setDoc; window.getAuth = getAuth;

    // --- Auth UI (simple email/password sign-in) ---
    const emailInput = document.querySelector('#auth-box input[placeholder="Email"]');
    const passwordInput = document.querySelector('#auth-box input[placeholder="Password"]');
    const signInBtn = document.querySelector('#auth-box .btn');
    const createAccountBtn = document.getElementById('createAccountBtn');

    if (createAccountBtn) {
      createAccountBtn.addEventListener('click', () => window.location.href = "account_creation.html");
    }
    if (signInBtn) {
      signInBtn.addEventListener('click', async () => {
        const email = (emailInput?.value || "").trim();
        const password = (passwordInput?.value || "");
        if (!email || !password) { alert("Enter both Email and Password."); return; }
        try {
          const userCred = await signInWithEmailAndPassword(auth, email, password);
          loadProfile(userCred.user.uid);
          alert("Signed in successfully");
        } catch (err) { alert("Login failed: " + err.message); }
      });
    }

    // Load Profile
    async function loadProfile(uid) {
      const snap = await getDoc(doc(db, "users", uid));
      if (!snap.exists()) return;

      const data = snap.data();
      const profileBox = document.getElementById("profile-box");

      // Username
      profileBox.querySelector(".username-info")?.remove();
      profileBox.querySelector(".platform-info")?.remove();

      const usernameEl = document.createElement("p");
      usernameEl.className = "username-info";
      usernameEl.textContent = `üë§ Username: ${data.username || "N/A"}`;
      usernameEl.style.fontWeight = "bold";
      usernameEl.style.marginBottom = "0.5rem";
      profileBox.prepend(usernameEl);

      const platformEl = document.createElement("p");
      platformEl.className = "platform-info";
      platformEl.textContent = `üîπ Platform: ${data.platform || "N/A"}`;
      platformEl.style.marginBottom = "0.5rem";
      profileBox.insertBefore(platformEl, usernameEl.nextSibling);

      // Stats
      document.getElementById("fav-games").textContent     = `üî• Favorite Games: ${Array.isArray(data.favoriteGames) ? data.favoriteGames.join(", ") : "N/A"}`;
      document.getElementById("games-played").textContent  = `üéÆ Number Of Games Played: ${data.gamesPlayed ?? "N/A"}`;
      document.getElementById("trophy-stats").textContent  = `üèÜ Trophy Stats (Total Trophies): ${data.trophyCount ?? "N/A"}`;

      const imageRow = document.getElementById("fav-images");
      imageRow.innerHTML = "";
      if (Array.isArray(data.favoriteImages)) {
        data.favoriteImages.forEach((url, index) => {
          const img = document.createElement("img");
          img.src = url;
          img.alt = (data.favoriteGames && data.favoriteGames[index]) || `Game ${index+1}`;
          img.classList.add("update-flash-img");
          imageRow.appendChild(img);
        });
      }
    }

    // Edit modal helpers
    window.openEditModal = function () {
      document.getElementById('editModal').style.display = 'block';
      document.getElementById('editGames').value = document.getElementById('fav-games').textContent.replace('üî• Favorite Games: ', '');
      document.getElementById('editGamesPlayed').value = document.getElementById('games-played').textContent.replace('üéÆ Number Of Games Played: ', '');
      document.getElementById('editTrophies').value = document.getElementById('trophy-stats').textContent.replace('üèÜ Trophy Stats (Total Trophies): ', '');
      document.getElementById('editUsername').value = document.querySelector(".username-info")?.textContent.replace("üë§ Username: ", "") || '';
      document.getElementById('editPlatform').value = document.querySelector(".platform-info")?.textContent.replace("üîπ Platform: ", "") || '';
    };
    window.closeEditModal = function () { document.getElementById('editModal').style.display = 'none'; };

    window.saveProfileChanges = async function () {
      const user = auth.currentUser;
      if (!user) { alert("You must be signed in to update your profile."); return; }

      const games = document.getElementById('editGames').value.trim();
      const gamesPlayed = document.getElementById('editGamesPlayed').value.trim();
      const imageUrls = document.getElementById('editGameImages').value.split(',').map(s => s.trim()).filter(Boolean);
      const trophies = document.getElementById('editTrophies').value.trim();
      const username = document.getElementById('editUsername').value.trim();
      const platform = document.getElementById('editPlatform').value;

      const uid = user.uid;
      await setDoc(doc(db, "users", uid), {
        username,
        platform,
        favoriteGames: games ? games.split(',').map(s => s.trim()) : [],
        gamesPlayed: gamesPlayed ? parseInt(gamesPlayed) : 0,
        favoriteImages: imageUrls,
        trophyCount: trophies ? parseInt(trophies) : 0,
      }, { merge: true });

      await loadProfile(uid);
      window.closeEditModal();
    };

    // Logout (v10-safe)
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        try {
          await signOut(auth);
          document.getElementById("profile-box").style.display = "none";
          window.location.href = "index.html";
        } catch (err) { alert("Error signing out: " + err.message); }
      });
    }

    // Signed-out overlay helpers
    window.showAuthNotice = function(){ const b=document.getElementById("authNotice"); const o=document.getElementById("authOverlay"); if(b) b.style.display="block"; if(o) o.style.display="block"; }
    window.hideAuthNotice = function(){ const b=document.getElementById("authNotice"); const o=document.getElementById("authOverlay"); if(b) b.style.display="none"; if(o) o.style.display="none"; }

    // Show/hide personalized sections based on auth
    onAuthStateChanged(auth, (user) => {
      const profileBox = document.getElementById("profile-box");
      if (user) { loadProfile(user.uid); if (profileBox) profileBox.style.display = "block"; }
      else      { if (profileBox) profileBox.style.display = "none"; showAuthNotice(); setTimeout(hideAuthNotice, 10000); }
    });
  </script>

  <!-- Stats, Spotlight, Alerts, Talk of the Week, Featured Clip -->
  <script type="module">
    import {
      getFirestore, collection, query, where, orderBy, limit, getDocs,
      getCountFromServer, Timestamp, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";

    const db   = window.db   || getFirestore();
    const auth = window.auth || getAuth();

    const $ = (id) => document.getElementById(id);

    // ---- helpers ----
    function setText(id, val){ const el = $(id); if (el) el.textContent = String(val); }

    async function safeCount(colName, qParts=[]){
      try{
        const base = collection(db, colName);
        const q = qParts.length ? query(base, ...qParts) : base;
        const snap = await getCountFromServer(q);
        return snap.data().count || 0;
      }catch(e){ return 0; }
    }

    async function countSubmissions({type=null, hasVideo=false}={}){
      // If your 'submissions' have consistent fields:
      try{
        if (type) {
          const n = await safeCount("submissions", [ where("type","==", type) ]);
          if (n) return n;
        }
      }catch{}
      // Fallback: shallow scan of newest docs
      try{
        const qs = await getDocs(query(collection(db,"submissions"), orderBy("timestamp","desc"), limit(200)));
        return qs.docs.filter(d=>{
          const x = d.data()||{};
          const okType  = type ? String(x.type||"").toLowerCase()===type : true;
          const okMedia = hasVideo ? !!x.videoUrl : true;
          return okType && okMedia;
        }).length;
      }catch{ return 0; }
    }

    async function sumPollVotes(){
      try{
        const qs = await getDocs(collection(db,"polls"));
        return qs.docs.reduce((sum,d)=>{
          const p = d.data()||{};
          if (typeof p.totalVotes === "number") return sum + p.totalVotes;
          if (Array.isArray(p.options)) return sum + p.options.reduce((s,o)=> s + Number(o.votes ?? o.count ?? 0), 0);
          if (p.choices && typeof p.choices === "object") return sum + Object.values(p.choices).reduce((s,v)=> s + Number(v||0), 0);
          return sum;
        },0);
      }catch{ return 0; }
    }

    async function usernameFrom(uid){
      if (!uid) return "GSU_Player";
      try{
        const s = await getDoc(doc(db,"users",uid));
        const u = s.data()||{};
        return (u.username || (u.email?.split("@")[0]) || "GSU_Player");
      }catch{ return "GSU_Player"; }
    }

    function youtubeEmbed(url){
      if (!url) return "";
      try{
        const u = new URL(url);
        if (u.hostname.includes("youtu.be")) return `https://www.youtube.com/embed/${u.pathname.slice(1)}`;
        if (u.hostname.includes("youtube.com")){
          const id = u.searchParams.get("v"); if (id) return `https://www.youtube.com/embed/${id}`;
        }
      }catch{}
      return "";
    }

    // ---- Retro facts + Character sync ----
    const RetroFacts = [
      "üïπÔ∏è Donkey Kong (1981) introduced Jumpman ‚Äî who would later become Mario.",
      "üß± Tetris (1984) was created by a Soviet engineer and smuggled out of the USSR.",
      "üíæ NES cartridges used 'lockout chips' to prevent unlicensed games.",
      "üéØ Pong (1972) was so popular the original machine overflowed with quarters and broke.",
      "üëæ Space Invaders (1978) was the first game to increase difficulty as you played.",
      "üé§ Mortal Kombat helped spark the ESRB rating system.",
      "üåÄ SNES Mode 7 enabled fake 3D in F-Zero and Mario Kart."
    ];
    window.loadRetroFact = function(){
      const random = RetroFacts[Math.floor(Math.random() * RetroFacts.length)];
      setText("retro-fact", random);
    };
    const CharacterAssignments = [
      { name:"Peter Parker/Spider-Man", role:"superhero", desc:"Smarts, strength, and soul. You choose right ‚Äî even when it costs you.", img:"https://cdn2.unrealengine.com/egs-marvelsspidermandigitaldeluxeedition-insomniacgamesnixxessoftware-editions-g1a-00-1920x1080-f8f8dc068a4d.jpg", platforms:["PlayStation","PC"] },
      { name:"Kratos", role:"anti-hero", desc:"Fueled by rage, guided by growth. You don‚Äôt run ‚Äî you conquer.", img:"https://w0.peakpx.com/wallpaper/909/900/HD-wallpaper-kratos-game-games-god-of-war-playstation-ps4-ps5-video-games-thumbnail.jpg", platforms:["PlayStation"] },
      { name:"Miles Morales", role:"superhero", desc:"Weight of two worlds, still moving with purpose. You‚Äôre the spark.", img:"https://static0.gamerantimages.com/wordpress/wp-content/uploads/2021/02/spider-man-miles-morales-web-fired-at-screen-night-time.jpg", platforms:["PlayStation","PC"] },
      { name:"Aloy", role:"hunter-protector", desc:"Curiosity + courage. You push boundaries to save the world.", img:"https://media.wired.com/photos/623233505f9392d9abe3e43e/master/pass/Horizon-Forbidden-West-Spoilers-Character-Games-Culture.jpg", platforms:["PlayStation","PC"] },
      { name:"Jin Sakai", role:"samurai-turned-ghost", desc:"Honor matters ‚Äî survival adapts. You do what it takes.", img:"https://images-wixmp-ed30a86b8c4ca887773594c2.wixmp.com/f/f03405b5-4361-4440-9bd3-6e7db6e9d0e2/dhozwq1-b24c7a15-142b-4437-8f67-de4e96005537.jpg", platforms:["PlayStation"] },
      { name:"Ratchet", role:"galactic hero", desc:"Inventive, loyal, always ready to blast through challenge.", img:"https://platform.theverge.com/wp-content/uploads/sites/2/chorus/uploads/chorus_asset/file/22528658/RACRA_Juggernaut_Legal_scaled.jpeg?quality=90&strip=all&crop=7.8125,0,84.375,100", platforms:["PlayStation"] },
      { name:"Mario", role:"hero-plumber", desc:"Heart and hustle. It‚Äôs-a you!", img:"https://static0.gamerantimages.com/wordpress/wp-content/uploads/2023/03/super-mario-odyssey-sequel-beanbean-kingdom.jpg", platforms:["Nintendo"] },
      { name:"Donkey Kong", role:"jungle powerhouse", desc:"Bold, strong, unshakable. Loyal to your crew.", img:"https://metro.co.uk/wp-content/uploads/2025/06/SEI_255987806-22f2.jpg?quality=90&strip=all&w=646", platforms:["Nintendo"] }
    ];
    window.updateCharacterOptions = function() {
      const platform = (document.getElementById("platform-select")?.value)||"";
      const roleEl = $("character-role");
      const descEl = $("character-desc");
      const imgEl  = $("character-image");
      const msgEl  = $("no-character-msg");
      if (!platform) { roleEl.textContent=""; descEl.textContent=""; imgEl.src="GSU_LOGO.png"; msgEl.style.display="block"; return; }
      const filtered = CharacterAssignments.filter(c => c.platforms.includes(platform));
      if (!filtered.length) { roleEl.textContent=""; descEl.textContent=""; imgEl.src="GSU_LOGO.png"; msgEl.style.display="block"; return; }
      const chosen = filtered[Math.floor(Math.random()*filtered.length)];
      roleEl.textContent = `üéÆ You Are: ${chosen.name} (${chosen.role})`;
      descEl.textContent = chosen.desc;
      imgEl.src = chosen.img;
      msgEl.style.display = "none";
    };
    document.addEventListener('DOMContentLoaded', () => { loadRetroFact(); updateCharacterOptions(); });

    // ---- Stats ----
    window.populateStats = async function(){
      const sevenDaysAgo = Timestamp.fromDate(new Date(Date.now() - 7*24*3600*1000));
      const totalMembers = await safeCount("users");
      const newMembers   = await safeCount("users", [ where("createdAt", ">=", sevenDaysAgo) ]);
      const videoUploads = await countSubmissions({ hasVideo:true });
      const fanArt       = await safeCount("community_art");
      const trophies     = await safeCount("community_trophies");
      const combos       = await countSubmissions({ type:"combo" });
      const pollVotes    = await sumPollVotes();

      setText("totalMembers", totalMembers);
      setText("newMembers",   newMembers);
      setText("videoUploads", videoUploads);
      setText("fanArt",       fanArt);
      setText("trophies",     trophies);
      setText("combos",       combos);
      setText("pollVotes",    pollVotes);
    };

    // ---- Featured Clip (Union Watch) ----
    const H24 = 24*60*60*1000;
    const since = Timestamp.fromDate(new Date(Date.now() - H24));

    async function buildUnionWatch(){
      const media = $("unionWatchMedia");
      const title = $("unionWatchTitle");
      const cap   = $("unionWatchCaption");
      if (!media) return;

      let docHit = null;
      try{
        const qs = await getDocs(query(
          collection(db,"submissions"),
          where("timestamp", ">=", since),
          orderBy("timestamp","desc"),
          limit(15)
        ));
        docHit = qs.docs.map(d=>({id:d.id, ...d.data()})).find(x => x.videoUrl);
      }catch{}

      if (!docHit){
        try{
          const qs = await getDocs(query(collection(db,"submissions"), orderBy("timestamp","desc"), limit(20)));
          docHit = qs.docs.map(d=>({id:d.id, ...d.data()})).find(x => x.videoUrl);
        }catch{}
      }

      if (!docHit){ title.textContent = "No featured clip yet ‚Äî be the first!"; cap.textContent=""; media.innerHTML=""; return; }

      const user = await usernameFrom(docHit.userId);
      const embed = youtubeEmbed(docHit.videoUrl);
      media.innerHTML = embed
        ? `<iframe src="${embed}" allowfullscreen style="width:100%;height:360px;border-radius:10px;"></iframe>`
        : `<img src="${docHit.cover || 'GSU_LOGO.png'}" alt="Clip" class="showoff-img" />`;

      title.textContent = `@${user} ‚Äî ${docHit.title || "Featured Clip"}`;
      cap.textContent   = docHit.caption || "Certified GSU moment.";
    }

    // ---- Certified Moment (latest trophy) ----
    async function buildCertifiedMoment(){
      const img = $("certifiedImg");
      const p   = $("certifiedCaption");
      if (!img || !p) return;
      try{
        const qs = await getDocs(query(collection(db,"community_trophies"), orderBy("timestamp","desc"), limit(1)));
        const d  = qs.docs[0]?.data();
        if (!d){ p.textContent="No trophies yet ‚Äî earn one and take the spotlight."; return; }
        const user = await usernameFrom(d.userId);
        img.src = d.cover || "GSU_LOGO.png";
        img.alt = d.game || "Trophy";
        p.innerHTML = `"${d.title || d.description || 'New Trophy'}" ‚Äî <strong>@${user}</strong>`;
      }catch{
        p.textContent="Couldn‚Äôt load trophies.";
      }
    }

    // ---- Talk of the Week ----
    async function buildTalkOfWeek(){
      const q = $("talkQuoteText");
      const w = $("talkQuoteWho");
      if (!q || !w) return;
      try{
        const qs = await getDocs(query(collection(db,"submissions"), orderBy("timestamp","desc"), limit(10)));
        const hit = qs.docs.map(d=>d.data()).find(x => (x.caption||"").length > 0);
        if (!hit){ q.textContent="‚ÄúBro didn‚Äôt dodge ‚Äî he teleported üíÄ‚Äù"; w.textContent="‚Äî GSU Lounge"; return; }
        const user = await usernameFrom(hit.userId);
        const text = String(hit.caption).trim().replace(/^["‚Äú]|["‚Äù]$/g,"");
        q.textContent = `‚Äú${text}‚Äù`;
        w.textContent = `‚Äî @${user}`;
      }catch{
        q.textContent="‚ÄúWe‚Äôre syncing up the quote feed‚Ä¶‚Äù"; w.textContent="‚Äî GSU";
      }
    }

    // ---- Alerts (last 24h) ----
    async function buildAlerts(){
      const list = $("alertsList");
      if (!list) return;
      list.innerHTML = `<li>Loading‚Ä¶</li>`;
      const rows = [];

      async function pushFrom(col, maker){
        try{
          const qs = await getDocs(query(collection(db,col), where("timestamp", ">=", since), orderBy("timestamp","desc")));
          for (const d of qs.docs){
            const x = d.data()||{};
            const user = await usernameFrom(x.userId);
            const line = maker(x, user);
            if (line) rows.push(`<li>${line}</li>`);
          }
        }catch(e){ /* collection may not exist */ }
      }

      await pushFrom("submissions", (x,u)=>{
        if (x.videoUrl) return `üé• New upload: <strong>${x.title || 'Clip'}</strong> ‚Äî @${u}`;
        if ((x.type||"").toLowerCase()==="combo") return `ü•ä New combo guide: <strong>${x.title || 'Combo'}</strong> ‚Äî @${u}`;
        return null;
      });
      await pushFrom("community_art",      (x,u)=> `üé® New art: <strong>${x.title || 'Art drop'}</strong> ‚Äî @${u}`);
      await pushFrom("community_trophies", (x,u)=> `üèÜ New trophy: <strong>${x.title || x.game || 'Trophy'}</strong> ‚Äî @${u}`);

      list.innerHTML = rows.length ? rows.join("") : `<li>No new drops in the last 24 hours ‚Äî be the first! üîî</li>`;
    }

    // ---- Spotlight videos personalized by favoriteGames ----
    const youtubeApiKey = "AIzaSyBtVEG3436lk_I4gfKCAxYSRv_IBU6lcBA";
    async function rotateYouTubeVideosForUser(uid){
      const cont = $("fav-game-updates");
      if (!cont) return;
      try{
        const snap = await getDoc(doc(db,"users",uid));
        if (!snap.exists()){ cont.innerHTML = "<p style='color:red; text-align:center;'>‚ùå No user data found.</p>"; return; }
        const { favoriteGames } = snap.data();
        if (!Array.isArray(favoriteGames) || !favoriteGames.length){
          cont.innerHTML = "<p style='color:red; text-align:center;'>‚ùå No favorite games set.</p>"; return;
        }
        cont.innerHTML = "<p style='text-align:center;'>üîÑ Loading gameplay drops...</p>";

        const blocks = await Promise.all(
          favoriteGames.slice(0,3).map(async (title) => {
            const cleanTitle = title.replace(/[^\w\s:]/gi, "").trim();
            try{
              const res = await fetch(`https://www.googleapis.com/youtube/v3/search?key=${youtubeApiKey}&part=snippet&type=video&maxResults=5&q=${encodeURIComponent(cleanTitle + " gameplay")}`);
              const data = await res.json();

              if (data?.error?.errors?.[0]?.reason === 'quotaExceeded'){
                return `
                  <div style="color: var(--gsu-red); text-align: center; padding: 1rem;">
                    Today‚Äôs video drops are temporarily unavailable. Check back tomorrow for fresh gameplay!
                    <br/><br/>
                    <button onclick="window.location.href='uploads.html'" style="background-color: var(--gsu-red); color: white; border: none; padding: 0.6rem 1rem; border-radius: 6px; cursor: pointer; font-family: 'Montserrat', sans-serif; font-weight: 600;">
                      Explore GSU Player Lounge
                    </button>
                  </div>
                `;
              }

              const video = data.items?.find(item => item.id.kind === "youtube#video");
              const videoId = video?.id?.videoId;
              if (!videoId) throw new Error("No videos found");

              return `
                <div class="spotlight-video">
                  <iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>
                  <h3 style="color:var(--gsu-red);">üéÆ ${title}</h3>
                  <p>‚ñ∂Ô∏è Daily gameplay drop powered by YouTube</p>
                </div>
              `;
            } catch(err){
              console.error(`Error loading video for ${title}:`, err);
              return `<div style="color:red; text-align:center;">‚ùå Failed to load video for <strong>${title}</strong></div>`;
            }
          })
        );
        cont.innerHTML = blocks.join("");
      } catch(e){
        console.error("Error fetching YouTube videos:", e);
        cont.innerHTML = `<p style="color:red; text-align:center;">‚ùå Could not load personalized videos.</p>`;
      }
    }

    // ---- Run everything ----
    async function runHome(){
      try{ await window.populateStats?.(); }catch{}
      await Promise.all([buildUnionWatch(), buildCertifiedMoment(), buildTalkOfWeek(), buildAlerts()]);
      const user = auth.currentUser;
      const vidsContainer = $("fav-game-updates");
      if (vidsContainer) {
        if (user) rotateYouTubeVideosForUser(user.uid);
        else vidsContainer.innerHTML = `<p style="color:red; text-align:center;">‚ùå Please log in to see personalized videos.</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", runHome);
    onAuthStateChanged(auth, runHome);

    // refresh alerts every 10 minutes to keep the 24h window rolling
    setInterval(buildAlerts, 10*60*1000);
  </script>
</body>
</html>
