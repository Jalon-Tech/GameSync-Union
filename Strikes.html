<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GSU Command Strike ‚Äî Solo</title>
<link rel="icon" href="GSU_LOGO.png" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
<style>
  :root{
    --gsu-red:#e60023; --bg:#000; --fg:#fff; --muted:#c7c7c7;
    /* iOS safe areas */
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  html, body{
    margin:0;
    /* allow vertical scroll; block sideways */
    overflow-x:hidden;
  }
  body{
    font-family:'Orbitron',sans-serif; background:var(--bg); color:var(--fg);
    display:flex; flex-direction:column; align-items:center;
    padding:calc(12px + var(--safe-top)) calc(16px + var(--safe-right)) calc(16px + var(--safe-bottom)) calc(16px + var(--safe-left));
    gap:12px;
    min-height:100svh;
  }

  /* ===== Global scale wrapper (shrinks whole page on small screens) ===== */
  #game-wrapper{
    transform-origin: top center;
    width:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
  }

  header{display:flex; flex-direction:column; align-items:center; gap:8px}
  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  nav a{color:#fff; text-decoration:none; background:var(--gsu-red); padding:8px 12px; border-radius:10px}

  .wrap{
    width:min(960px,96vw); border:3px solid var(--gsu-red); border-radius:16px; padding:14px;
    box-shadow:0 0 18px #e60023cc, inset 0 0 18px #e6002326;
    background:linear-gradient(#0a0a0a,#000);
  }
  .wrap.shake{animation:shake .3s ease}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-4px)}}

  .hud{display:grid; grid-template-columns:repeat(5,1fr); gap:8px; margin-bottom:10px; font-size:clamp(.8rem,2vw,1rem)}
  .pill{background:#111; border:1px solid #2a2a2a; border-radius:10px; padding:8px; text-align:center}
  .pill strong{color:var(--gsu-red)}

  .panel{border:1px solid #2a2a2a; border-radius:12px; padding:12px; background:#0b0b0b; display:flex; flex-direction:column; gap:12px;}

  /* ---------- FX Stage ---------- */
  .stage{
    position:relative; height:200px; border:1px solid #333; border-radius:12px;
    background:#0f0f0f; overflow:hidden;
    touch-action:manipulation; /* smoother taps on mobile */
  }
  .fx{position:absolute; inset:0; pointer-events:none}
  .target{position:absolute; font-size:52px; filter:drop-shadow(0 0 8px #fff)}
  .target.hit{filter:drop-shadow(0 0 14px #e60023)}
  .controller{
    position:absolute; width:64px; will-change:transform;
    filter:drop-shadow(0 0 8px rgba(230,0,35,.6));
  }
  .boom{position:absolute; font-size:64px; opacity:0}

  /* Speedlines when on streak */
  .speedlines{
    position:absolute; inset:0; pointer-events:none; opacity:0.0; mix-blend-mode:screen;
    background: repeating-linear-gradient(90deg, rgba(255,255,255,.07) 0 2px, transparent 2px 8px);
    animation:lines 1.1s linear infinite;
  }
  .speedlines.fast{opacity:.35; animation-duration:.6s}
  .speedlines.med{opacity:.22}
  @keyframes lines{
    from{transform:translateX(0)}
    to{transform:translateX(-40px)}
  }

  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none;
    font-weight:800; letter-spacing:1px;
  }
  .overlay .banner{
    padding:10px 16px; border:2px solid #fff; border-radius:14px; background:rgba(230,0,35,.15);
    text-shadow:0 0 12px rgba(255,255,255,.45); font-size:clamp(1.2rem,4.5vw,2rem);
    transform:scale(.8); opacity:0;
  }

  .big-next{text-align:center; font-size:clamp(1.2rem,4.5vw,1.8rem); background:#0f0f0f; border:1px solid #333; border-radius:12px; padding:12px;}
  .cmd{background:#0f0f0f; border:1px dashed #444; border-radius:12px; padding:12px; min-height:80px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center;}
  .token{padding:10px 12px; border-radius:10px; background:#171717; border:1px solid #333; font-size:1.05rem}
  .token.pending{outline:2px solid #ffae00}
  .token.ok{outline:2px solid #29d07a}
  .token.bad{outline:2px solid #d02121}

  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center}
  .btn{border:none; background:var(--gsu-red); color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer; box-shadow:0 0 10px #e60023aa; font-weight:700}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .hint{color:var(--muted); text-align:center; font-size:.95rem}

  /* On-screen controls */
  .controls{margin-top:6px; display:grid; grid-template-columns:repeat(3,64px); gap:8px; justify-content:center; align-items:center; user-select:none}
  .key{width:64px; height:64px; border-radius:12px; background:#121212; border:1px solid #333; display:flex; align-items:center; justify-content:center; font-size:1.2rem; cursor:pointer; box-shadow:0 0 8px rgba(255,255,255,.05)}
  .key:active{filter:brightness(1.2)}
  .letters{display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin-top:6px}
  .letters .key{width:48px; height:44px}

  /* Sparks & confetti */
  .spark{
    position:absolute; width:8px; height:8px; border-radius:50%;
    background:radial-gradient(circle,#fff 0 45%, rgba(255,255,255,.2) 60%, transparent 70%);
    box-shadow:0 0 10px rgba(255,255,255,.6);
  }
  .confetti{position:absolute; width:8px; height:12px; will-change:transform; opacity:.95}
  footer{opacity:.7; font-size:.85rem}
  @media (max-width:720px){ .hud{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div id="game-wrapper">
    <header>
      <img src="GSU_LOGO.png" alt="GSU" style="max-width:96px">
      <div>GAMESYNC UNION</div>
      <nav><a href="index.html">Home</a></nav>
    </header>

    <section class="wrap" id="wrap">
      <h1 style="margin:6px 0 10px 6px;">GSU COMMAND STRIKE ‚Äî SOLO</h1>
      <div class="hud">
        <div class="pill">üìú Round <strong id="round">1</strong>/12</div>
        <div class="pill">üéØ Progress <strong id="progress">0</strong>%</div>
        <div class="pill">‚è± Time <strong id="time">0</strong>ms</div>
        <div class="pill">‚úÖ Accuracy <strong id="acc">0</strong>%</div>
        <div class="pill">üî• Streak <strong id="streak">0</strong></div>
      </div>

      <div class="panel">
        <div class="stage" id="stage">
          <div class="fx" id="fx"></div>
          <div class="speedlines" id="speedlines"></div>
          <div class="overlay" id="overlay"><div class="banner" id="banner">ROUND CLEAR!</div></div>
        </div>

        <div class="big-next">Next: <span id="nextToken">‚Äî</span></div>
        <div class="cmd" id="cmd"></div>

        <div class="row">
          <button class="btn" id="start">‚ñ∂ Start Drill</button>
          <button class="btn" id="next" disabled>‚è≠ Next Pattern</button>
          <button class="btn" id="restart" disabled>üîÅ Restart</button>
        </div>

        <div class="hint">Arrows = directions ‚Ä¢ Letters like A/S/D/Q/E/F/J/K/L/Z/X/C/W/R/U/I (press the same letter)</div>

        <div class="controls" aria-label="D-Pad">
          <div></div><div class="key" data-sym="‚Üë">‚Üë</div><div></div>
          <div class="key" data-sym="‚Üê">‚Üê</div><div class="key" data-sym="‚Üì">‚Üì</div><div class="key" data-sym="‚Üí">‚Üí</div>
        </div>
        <div class="letters" id="lettersRow"></div>
      </div>
    </section>

    <footer>Built for GameSync Union ‚Äî GSU Command Strike‚Ñ¢</footer>
  </div>

<script>
/* ===== Global auto-scale (scroll allowed; sideways blocked) ===== */
(function(){
  const vvp = () => window.visualViewport || { width: innerWidth, height: innerHeight };
  const wrapper = document.getElementById('game-wrapper');

  function scalePage(){
    if(!wrapper) return;
    // reset to measure natural size
    wrapper.style.transform = 'scale(1)';
    const contentH = wrapper.scrollHeight;
    const contentW = wrapper.scrollWidth;
    const vw = vvp().width, vh = vvp().height;

    // fit by both height and width
    const sH = (vh - 2) / contentH;
    const sW = (vw - 2) / contentW;
    let scale = Math.min(sH, sW);

    // don't upscale on big screens
    if (scale > 1) scale = 1;
    // keep things usable on very small screens
    scale = Math.max(0.6, scale);

    wrapper.style.transform = `scale(${scale})`;
  }

  let raf = null;
  function requestFit(){ if(raf) cancelAnimationFrame(raf); raf = requestAnimationFrame(scalePage); }

  addEventListener('load', requestFit);
  addEventListener('resize', requestFit);
  addEventListener('orientationchange', requestFit);
  window.visualViewport && visualViewport.addEventListener('resize', requestFit);

  // Expose manual refresh for big layout changes if needed
  window.gsuFit = { refresh: requestFit };
})();
</script>

<script>
/* ---------------- Tokens & Pattern ---------------- */
const DIR = ["‚Üë","‚Üì","‚Üê","‚Üí"];
const LETTER_TOKENS = ["A","S","D","Q","E","F","J","K","L","Z","X","C","W","R","U","I"];
const MAX_ROUNDS = 12;

/* BIG BOOM SET */
const BOOM_ICONS = [
  'üí•','‚ú®','‚ö°','üî•','üí£','üéÜ','üéá','üß®','üå©Ô∏è','üåü','‚òÑÔ∏è','üí´','üåã','üåÄ','‚≠ê','üå†','üå™Ô∏è','‚ú¥Ô∏è','‚ú≥Ô∏è','‚ùáÔ∏è','‚ú∫','‚úπ','‚ú∏','‚úª',
  'üí•‚ú®','‚ö°üí•','üî•üí•','üéÜüí•','üéá‚ú®','üß®üí•','üí£üí•','üå©Ô∏è‚ö°','‚òÑÔ∏èüí•','üåãüî•','üåü‚ú®','‚≠ê‚ú®','üå†‚ú®','üí´‚ú®','‚ö°üî•','‚ú®‚ö°',
  'üí•üí•üí•','‚ú®‚ú®‚ú®','‚ö°‚ö°‚ö°','üî•üî•üî•','üéÜüéÜüéÜ','üéáüéáüéá','üß®üß®üß®'
];

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function tokenLengthByRound(r){
  const map = [4,4,5,5,6,6,6,7,7,7,8,8]; // 4 -> 8 over 12 rounds
  return map[Math.min(MAX_ROUNDS-1, Math.max(0, r-1))];
}
function genPattern(round){
  const len = tokenLengthByRound(round);
  const toks = [];
  for (let i=0;i<len;i++){
    const pool = Math.random() < 0.5 ? DIR : LETTER_TOKENS;
    let t = pick(pool);
    if (i>0 && t===toks[i-1]) t = pick(pool.filter(x=>x!==t)); // no immediate repeat
    toks.push(t);
  }
  return toks;
}

/* ---------------- State & DOM ---------------- */
const wrap = document.getElementById('wrap');
const stage = document.getElementById('stage');
const fx = document.getElementById('fx');
const speedlines = document.getElementById('speedlines');
const banner = document.getElementById('banner');

const roundEl = document.getElementById('round');
const progEl  = document.getElementById('progress');
const timeEl  = document.getElementById('time');
const accEl   = document.getElementById('acc');
const streakEl= document.getElementById('streak');
const cmdEl   = document.getElementById('cmd');
const nextTok = document.getElementById('nextToken');
const startBtn= document.getElementById('start');
const nextBtn = document.getElementById('next');
const restartBtn=document.getElementById('restart');
const lettersRow = document.getElementById('lettersRow');

let game = null;
function newGame(){
  return { round:1, maxRounds:MAX_ROUNDS, tokens:[], idx:0, start:0, end:0, hits:0, presses:0, streak:0, active:false };
}

/* On-screen letters */
lettersRow.innerHTML = LETTER_TOKENS.map(ch=>`<div class="key" data-sym="${ch}">${ch}</div>`).join("");

function renderCmd(){
  cmdEl.innerHTML = game.tokens.map((t,i)=>{
    let cls = "token";
    if (i < game.idx) cls += " ok";
    else if (i === game.idx) cls += " pending";
    return `<div class="${cls}">${t}</div>`;
  }).join("");
  nextTok.textContent = game.tokens[game.idx] ?? "‚Äî";
}

function setHUD(){
  roundEl.textContent = game.round;
  const p = game.tokens.length ? Math.floor(100 * (game.idx / game.tokens.length)) : 0;
  progEl.textContent = p;
  const t = game.end && game.start ? (game.end - game.start) : (performance.now() - game.start);
  timeEl.textContent = game.active ? Math.floor(t) : Math.floor(game.end - game.start);
  const acc = game.presses ? Math.floor(100 * (game.hits / game.presses)) : 0;
  accEl.textContent = acc;
  streakEl.textContent = game.streak;
  updateSpeedlines();
}

/* ---------------- Audio ---------------- */
let audioCtx = null;
function ensureAudio(){
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}
function beep(freq=880, dur=0.06, vol=0.04){
  if (!audioCtx) return;
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.frequency.value = freq;
  o.type = 'triangle';
  g.gain.value = vol;
  o.connect(g).connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur);
  o.stop(audioCtx.currentTime + dur);
}

/* ---------------- FX helpers ---------------- */
let currentTarget = null;
function rand(a,b){ return Math.random()*(b-a)+a }
function clamp(v,min,max){ return Math.max(min, Math.min(max,v)) }

function spawnTarget(){
  fx.innerHTML = "";
  banner.style.opacity = 0;
  const rect = stage.getBoundingClientRect();
  const pad = 24;
  const x = rand(pad, rect.width - pad - 52);
  const y = rand(pad, rect.height - pad - 52);
  const t = document.createElement('div');
  t.className = 'target';
  t.style.transform = `translate(${x}px, ${y}px)`;
  t.textContent = pick(['üéÆ','üïπÔ∏è','üëæ','üíø','üß©','üéØ','üõ°Ô∏è','üó°Ô∏è','üèÜ','ü™ô','üòÇ','üòà','ü§°','üôÑ','‚ò†Ô∏è','ü§™','ü§¨','ü§ë','üò¥','üë∫', 'üêí','ü¶Ö','üê∏','üê∑','üêä','üê∞','üêâ']);
  fx.appendChild(t);
  return {x,y,el:t};
}

function flyController(keyframes, onHit){
  const logo = document.createElement('img');
  logo.src = 'GSU_LOGO.png';
  logo.alt = 'GSU';
  logo.className = 'controller';
  fx.appendChild(logo);

  if (!keyframes[0]?.transform){
    keyframes[0] = {transform:`translate(-90px, ${rand(80,160)}px) rotate(-15deg) scale(1)`};
  }
  const anim = logo.animate(keyframes, {duration: 900, easing: 'cubic-bezier(.2,.7,.2,1)', fill:'forwards'});

  anim.onfinish = ()=>{
    const t = currentTarget?.el;
    if (t){ t.classList.add('hit'); }
    const boom = document.createElement('div');
    boom.className = 'boom';
    boom.textContent = pick(BOOM_ICONS);
    const bx = (currentTarget?.x ?? 120) + rand(-8,8);
    const by = (currentTarget?.y ?? 24)  + rand(-8,8);
    boom.style.transform = `translate(${bx}px, ${by}px) scale(.6)`;
    fx.appendChild(boom);
    boom.animate(
      [{opacity:.1, transform:`translate(${bx}px, ${by}px) scale(.6)`},
       {opacity:1,  transform:`translate(${bx}px, ${by}px) scale(1.25)`}],
      {duration: 380, easing:'ease-out', fill:'forwards'}
    );
    wrap.classList.add('shake');
    setTimeout(()=>wrap.classList.remove('shake'), 380);
    onHit && onHit();

    const rect = stage.getBoundingClientRect();
    const parkX = pick([rand(-10,10), rand(rect.width-70, rect.width-40)]);
    const parkY = rand(8, rect.height-70);
    logo.animate(
      [
        {transform: getComputedStyle(logo).transform, opacity:1},
        {transform:`translate(${parkX}px, ${parkY}px) scale(.85)`, opacity:.0}
      ],
      {duration: 520, easing:'ease-out', fill:'forwards'}
    ).onfinish = ()=> { logo.remove(); boom.remove(); t && t.remove(); };
  };
}

/* Trajectories */
function variantArc(){
  const sx = -90, sy = rand(80,160);
  const tx = (currentTarget?.x ?? 220), ty = (currentTarget?.y ?? 40);
  const midx = (sx + tx)/2 + rand(-40,40);
  const midy = Math.min(sy, ty) - rand(30,70);
  return [
    {transform:`translate(${sx}px, ${sy}px) rotate(-10deg) scale(1)`},
    {transform:`translate(${midx}px, ${midy}px) rotate(5deg) scale(1.05)`},
    {transform:`translate(${tx}px, ${ty}px) rotate(12deg) scale(1.1)`}
  ];
}
function variantZigzag(){
  const tx = (currentTarget?.x ?? 220), ty = (currentTarget?.y ?? 40);
  const sx = rand(-70, 20), sy = rand(40, 170);
  const kf = [];
  const steps = 4;
  for (let i=0;i<=steps;i++){
    const u = i/steps;
    const x = sx + (tx - sx)*u + (i%2? 18:-18);
    const y = sy + (ty - sy)*u + (i%2? -12:12);
    kf.push({transform:`translate(${x}px, ${y}px) rotate(${i*8-12}deg) scale(${1+u*0.15})`});
  }
  return kf;
}
function variantSpinDrop(){
  const tx = (currentTarget?.x ?? 220), ty = (currentTarget?.y ?? 40);
  const sx = rand(40, stage.clientWidth-80), sy = -120;
  return [
    {transform:`translate(${sx}px, ${sy}px) rotate(-360deg) scale(.9)`},
    {transform:`translate(${sx}px, ${ty-30}px) rotate(-90deg) scale(1)`},
    {transform:`translate(${tx}px, ${ty}px) rotate(0deg) scale(1.1)`}
  ];
}
function variantBoomerang(){
  const tx = (currentTarget?.x ?? 220), ty = (currentTarget?.y ?? 40);
  const sx = stage.clientWidth + 50, sy = rand(40, 180);
  const overX = clamp(tx + rand(40,90), 0, stage.clientWidth-60);
  return [
    {transform:`translate(${sx}px, ${sy}px) rotate(15deg) scale(1)`},
    {transform:`translate(${overX}px, ${ty-10}px) rotate(-10deg) scale(1.05)`},
    {transform:`translate(${tx}px, ${ty}px) rotate(0deg) scale(1.1)`}
  ];
}
function variantRainAndHit(){
  for(let i=0;i<6;i++){
    const mini = document.createElement('img');
    mini.src = 'GSU_LOGO.png'; mini.alt='GSU'; mini.className='controller'; mini.style.width = '40px';
    fx.appendChild(mini);
    const sx = rand(0, stage.clientWidth-50);
    const sy = -rand(30,160);
    const ey = stage.clientHeight - rand(30,100);
    mini.animate(
      [{transform:`translate(${sx}px, ${sy}px)`, opacity:.9},
       {transform:`translate(${sx+rand(-20,20)}px, ${ey}px)`, opacity:.2}],
      {duration: rand(600,900), easing:'ease-in', fill:'forwards'}
    ).onfinish=()=> mini.remove();
  }
  const tx = (currentTarget?.x ?? 220), ty = (currentTarget?.y ?? 40);
  const sx = -80, sy = rand(40, 160);
  return [
    {transform:`translate(${sx}px, ${sy}px) rotate(-5deg) scale(1)`},
    {transform:`translate(${tx}px, ${ty}px) rotate(8deg) scale(1.08)`}
  ];
}
function playStrikeVariant(){
  const variants = [variantArc, variantZigzag, variantSpinDrop, variantBoomerang, variantRainAndHit];
  const chosen = pick(variants);
  flyController(chosen(), ()=>{
    confetti(40);
    showBanner(game.round >= game.maxRounds ? "ALL ROUNDS CLEARED!" : "ROUND CLEAR!");
    beep(330, .08, .05);
  });
}

/* Flair */
function spawnSpark(){
  const s = document.createElement('div');
  s.className = 'spark';
  const x = rand(10, stage.clientWidth-10);
  const y = rand(10, stage.clientHeight-10);
  s.style.transform = `translate(${x}px, ${y}px)`;
  fx.appendChild(s);
  s.animate(
    [{transform:`translate(${x}px,${y}px) scale(.9)`, opacity:1},
     {transform:`translate(${x+rand(-20,20)}px,${y-25}px) scale(.4)`, opacity:0}],
    {duration: 300, easing:'ease-out', fill:'forwards'}
  ).onfinish=()=> s.remove();
}
function updateSpeedlines(){
  const st = game?.streak||0;
  if (st >= 8){ speedlines.classList.add('fast'); speedlines.classList.remove('med'); }
  else if (st >= 4){ speedlines.classList.add('med'); speedlines.classList.remove('fast'); }
  else { speedlines.classList.remove('fast','med'); }
}
function confetti(n=30){
  for(let i=0;i<n;i++){
    const c = document.createElement('div');
    c.className='confetti';
    c.style.background = pick(['#e60023','#22cc88','#33aaff','#ffcc33','#dd66ff','#ffffff']);
    const sx = (currentTarget?.x ?? stage.clientWidth/2) + rand(-12,12);
    const sy = (currentTarget?.y ?? stage.clientHeight/3) + rand(-8,8);
    c.style.transform = `translate(${sx}px, ${sy}px) rotate(${rand(0,360)}deg)`;
    fx.appendChild(c);
    c.animate(
      [{transform:`translate(${sx}px, ${sy}px) rotate(0deg)`, opacity:1},
       {transform:`translate(${sx+rand(-80,80)}px, ${stage.clientHeight + 20}px) rotate(${rand(180,720)}deg)`, opacity:rand(.6,.95)}],
      {duration: rand(900,1400), easing:'cubic-bezier(.2,.7,.2,1)', fill:'forwards'}
    ).onfinish = ()=> c.remove();
  }
}
function showBanner(text){
  banner.textContent = text;
  banner.animate([{opacity:0, transform:'scale(.8)'},{opacity:1, transform:'scale(1)'}], {duration:260, fill:'forwards', easing:'ease-out'});
  setTimeout(()=> banner.animate([{opacity:1},{opacity:0}], {duration:400, fill:'forwards'}), 900);
}

/* ---------------- Game flow ---------------- */
function startRound(){
  game.active = true;
  game.tokens = genPattern(game.round);
  game.idx = 0; game.hits = 0; game.presses = 0; game.streak = 0;
  game.start = performance.now(); game.end = 0;
  renderCmd(); setHUD();
  startBtn.disabled = true; nextBtn.disabled = true; restartBtn.disabled = false;
  currentTarget = spawnTarget();
}
function endRound(){
  game.active = false;
  game.end = performance.now();
  setHUD();
  playStrikeVariant();
  if (game.round >= game.maxRounds){
    startBtn.disabled = false; startBtn.textContent="üîÅ New Drill";
    nextBtn.disabled = true;
  } else {
    nextBtn.disabled = false;
  }
}
function nextRound(){ game.round++; startRound(); }

/* ---------------- Input Handling ---------------- */
function apply(sym){
  if (!game?.active) return;
  game.presses++;
  const need = game.tokens[game.idx];

  if (sym === need){
    ensureAudio(); beep(880 + (game.streak%4)*60, 0.05, 0.035);
    game.hits++; game.streak = Math.min(999, game.streak+1);
    spawnSpark();
    const tokenEls = cmdEl.querySelectorAll('.token');
    const cur = tokenEls[game.idx];
    if (cur){ cur.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}], {duration:160}); }
    game.idx++;
    renderCmd(); setHUD();
    if (game.streak && game.streak % 5 === 0){ showBanner(`COMBO x${game.streak}!`); beep(240, .08, .05); }
    if (game.idx >= game.tokens.length){ endRound(); }
  } else {
    ensureAudio(); beep(180, .06, .05);
    game.streak = 0;
    const tokenEls = cmdEl.querySelectorAll('.token');
    const cur = tokenEls[game.idx];
    if (cur){ cur.classList.add('bad'); setTimeout(()=>cur.classList.remove('bad'), 150); }
    setHUD();
  }
}

/* Keyboard: arrows + any letter, no focus needed */
function onKey(e){
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  if (!game) return;

  let sym = null;
  if (e.key === "ArrowUp") sym = "‚Üë";
  else if (e.key === "ArrowDown") sym = "‚Üì";
  else if (e.key === "ArrowLeft") sym = "‚Üê";
  else if (e.key === "ArrowRight") sym = "‚Üí";
  else if (/^[a-z]$/i.test(e.key)) sym = e.key.toUpperCase();

  if (sym && (DIR.includes(sym) || LETTER_TOKENS.includes(sym))) apply(sym);
}
window.addEventListener('keydown', onKey);

/* Touch buttons */
document.querySelectorAll('.key[data-sym]').forEach(k=>{
  k.addEventListener('click', ()=> apply(k.getAttribute('data-sym')));
});

/* Buttons */
startBtn.addEventListener('click', ()=>{
  ensureAudio();
  if (!game) game = newGame();
  else game.round = 1;
  startRound();
});
nextBtn.addEventListener('click', nextRound);
restartBtn.addEventListener('click', ()=>{ if (game) startRound(); });
</script>
</body>
</html>
