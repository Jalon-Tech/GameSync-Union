<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GSU Charge Run</title>
<link rel="icon" href="GSU_LOGO.png" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
<style>
  :root{
    /* JS keeps this updated to fit the screen */
    --cell: 36px;

    --gsu-red:#e60023; 
    --bg:#000; 
    --fg:#fff; 
    --muted:#c7c7c7;

    /* iOS safe areas */
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }

  *{box-sizing:border-box}
  html, body {height:100%}
  body{
    margin:0; 
    font-family:'Orbitron',sans-serif; 
    background:var(--bg); 
    color:var(--fg);
    min-height:100svh; /* stable viewport unit (iOS friendly) */
    padding:calc(8px + var(--safe-top)) calc(12px + var(--safe-right)) calc(12px + var(--safe-bottom)) calc(12px + var(--safe-left));
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    gap:12px;
  }

  /* Header */
  header{
    width:100%; 
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    justify-content:center; 
    gap:8px;
  }
  .logo{
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    justify-content:center; 
    text-align:center;
  }
  .logo img{
    width:clamp(80px, 12vw, 120px);
    height:auto; 
    display:block; 
    margin:0 auto;
  }
  .logo .text{letter-spacing:2px; opacity:.9; font-size:clamp(.8rem, 2.6vw, 1rem)}

  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  nav a{
    color:#fff; text-decoration:none; background:var(--gsu-red); 
    padding:.55rem .9rem; border-radius:10px; font-weight:700;
  }

  /* Main frame */
  .frame{
    width:min(980px, 100%);
    border:2px solid var(--gsu-red); border-radius:16px; padding:12px;
    box-shadow:0 0 18px #e60023cc, inset 0 0 18px #e6002326;
    background:linear-gradient(#0a0a0a,#000);
  }
  .frame.shake{animation:shake .25s ease}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}50%{transform:translateX(5px)}75%{transform:translateX(-5px)}}

  h1{margin:6px 0 0 6px; font-size:clamp(1.2rem, 4vw, 2rem)}
  h2.sub{
    margin:4px 0 10px 6px; color:var(--gsu-red); 
    font-size:clamp(.85rem, 2.8vw, 1.05rem); opacity:.9
  }

  /* HUD */
  .hud{
    display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:10px;
    font-size:clamp(.78rem, 2.6vw, 1rem);
  }
  .pill{
    background:#111; border:1px solid #2a2a2a; border-radius:10px; padding:.55rem .6rem; text-align:center;
    min-height:40px; display:flex; align-items:center; justify-content:center;
  }
  .pill strong{color:var(--gsu-red)}

  /* Board */
  #boardWrap{
    position:relative; 
    display:flex; 
    justify-content:center;
    /* reserve some room on very short screens */
    min-height: 0;
  }
  #gameCanvas{
    display:grid;
    grid-template-columns: repeat(20, var(--cell));
    grid-template-rows: repeat(20, var(--cell));
    border:2px solid #222; border-radius:12px; overflow:hidden;
    background:
      linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
    background-size: var(--cell) var(--cell);
    box-shadow:0 0 20px #e60023aa inset;
    margin: 0 auto;
  }

  /* Glow when Surge is active */
  #gameCanvas.power{
    animation:powerGlow 1s ease-in-out infinite alternate;
    border-color:#ff4060;
  }
  @keyframes powerGlow{
    from{box-shadow:0 0 16px #e60023aa inset}
    to  {box-shadow:0 0 30px #ff6a80cc inset}
  }

  .grid-cell{width:var(--cell); height:var(--cell); position:relative; overflow:visible}
  .grid-cell div{
    width:100%; height:100%; background-size:contain; background-repeat:no-repeat; background-position:center; position:absolute;
    display:flex; align-items:center; justify-content:center; font-size:calc(var(--cell) * .7);
  }

  /* Player controller */
  .controller{
    background-image:url('GSU_LOGO.png'); background-size:contain; background-repeat:no-repeat;
    z-index:3;
    transform:scale(1.52);
    filter:drop-shadow(0 0 8px rgba(230,0,35,.7));
    animation:idlePulse 1.4s ease-in-out infinite;
  }
  @keyframes idlePulse{0%,100%{transform:scale(1.50)}50%{transform:scale(1.62)}}

  .battery::after{content:'üîã'}
  .hazard::after{content:'üî•'}
  .reverse-surge::after{content:'üîÑ'}
  .trapped-fire{
    background-image:url('GSU_LOGO.png');
    animation:flash 1s infinite;
    filter:hue-rotate(140deg) drop-shadow(0 0 8px #66d1ff);
  }
  @keyframes flash{0%,100%{opacity:.9}50%{opacity:.6}}

  /* Floating feedback */
  .float{
    position:absolute; font-size:14px; color:#fff; text-shadow:0 0 6px rgba(255,255,255,.7);
    animation:floatUp .6s ease-out forwards;
    pointer-events:none;
  }
  @keyframes floatUp{from{transform:translateY(0); opacity:1}to{transform:translateY(-16px); opacity:0}}

  /* Buttons / Controls */
  .controls{margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:8px}
  .dpad{
    display:grid; 
    grid-template-columns:repeat(3,clamp(48px, 15vw, 64px)); 
    gap:8px
  }
  .key{
    width:clamp(48px, 15vw, 64px); 
    height:clamp(48px, 15vw, 64px); 
    border-radius:12px; background:#121212; border:1px solid #333; display:flex;
    align-items:center; justify-content:center; font-size:clamp(1.1rem, 6vw, 1.4rem); cursor:pointer; user-select:none;
    box-shadow:0 0 8px rgba(255,255,255,.05);
  }
  .key:active{filter:brightness(1.2)}
  .btn{
    border:none; background:var(--gsu-red); color:#fff; padding:.7rem 1rem; border-radius:10px; cursor:pointer;
    box-shadow:0 0 10px #e60023aa; font-weight:700; font-size:clamp(.9rem, 3.2vw, 1rem);
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* Overlays */
  .overlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:blur(2px);
  }
  .overlay.show{display:flex}
  .panel{
    background:#0b0b0b; border:1px solid #333; border-radius:14px; padding:16px 20px; text-align:center; min-width:260px;
    box-shadow:0 0 20px rgba(0,0,0,.6);
  }
  .panel h2{margin:0 0 8px 0; color:var(--gsu-red)}
  .panel .row{display:flex; gap:10px; justify-content:center; margin-top:10px}

  footer{opacity:.7; font-size:.85rem; text-align:center; margin-top:10px}

  /* Responsive tweaks */
  @media (max-width:900px){
    .hud{grid-template-columns:repeat(4,1fr)}
  }
  @media (max-width:640px){
    .hud{grid-template-columns:repeat(3,1fr)}
  }
</style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="GSU_LOGO.png" alt="GSU Logo" />
      <div class="text">GAMESYNC UNION</div>
    </div>
    <nav><a href="index.html">Home</a></nav>
  </header>

  <section class="frame" id="frame">
    <h1>GSU CHARGE RUN</h1>
    <h2 class="sub">Collect batteries, dodge fires, and trigger Reverse Surge to freeze hazards.</h2>

    <div class="hud">
      <div class="pill">üîã Goal <strong id="goalText">0 / 10</strong></div>
      <div class="pill">üî• Fires <strong id="firesText">20</strong></div>
      <div class="pill">‚è± Time <strong id="timer">30</strong>s</div>
      <div class="pill">‚ö° Surge <strong id="powerBar">0</strong></div>
      <div class="pill">‚ù§Ô∏è Lives <strong id="lives">3</strong></div>
      <div class="pill">üîÑ Reverse <strong id="reverseHint">2 tiles</strong></div>
      <div class="pill">‚¨Ü Level <strong id="surgeLevel">0</strong></div>
    </div>

    <div id="boardWrap">
      <div id="gameCanvas" aria-live="polite"></div>

      <!-- Overlays -->
      <div class="overlay" id="gameOver">
        <div class="panel">
          <h2>Game Over</h2>
          <div id="finalStats" style="opacity:.85; margin-bottom:8px;"></div>
          <div class="row">
            <button class="btn" id="retryBtn">üîÅ Play Again</button>
            <button class="btn" onclick="location.href='index.html'">üè† Home</button>
          </div>
        </div>
      </div>

      <div class="overlay" id="levelUp">
        <div class="panel">
          <h2>Level Up!</h2>
          <div style="opacity:.85">Grid surges with power. Hazards increase.</div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px; flex-wrap:wrap">
      <button class="btn" id="startGameBtn">‚ñ∂ Start</button>
      <button class="btn" id="pauseBtn" disabled>‚è∏ Pause</button>
      <button class="btn" id="fitBtn">üîç Fit to Screen</button>
    </div>

    <div class="controls">
      <div style="color:var(--muted); font-size:clamp(.78rem, 2.6vw, .95rem)">Desktop: Arrow Keys ‚Ä¢ Mobile: tap the D-Pad</div>
      <div class="dpad" aria-label="Directional pad">
        <div></div><div class="key" data-dir="ArrowUp">‚¨ÜÔ∏è</div><div></div>
        <div class="key" data-dir="ArrowLeft">‚¨ÖÔ∏è</div><div class="key" data-dir="ArrowDown">‚¨áÔ∏è</div><div class="key" data-dir="ArrowRight">‚û°Ô∏è</div>
      </div>
    </div>

    <footer>Built for GameSync Union ‚Äî GSU Charge Run‚Ñ¢</footer>
  </section>

<script>
/* ===== DOM & State ===== */
const frame = document.getElementById('frame');
const canvas = document.getElementById("gameCanvas");
const startBtn = document.getElementById("startGameBtn");
const pauseBtn = document.getElementById("pauseBtn");
const fitBtn = document.getElementById("fitBtn");

const gameOverOverlay = document.getElementById("gameOver");
const levelUpOverlay = document.getElementById("levelUp");
const finalStats = document.getElementById("finalStats");

const timerDisplay = document.getElementById("timer");
const livesDisplay = document.getElementById("lives");
const goalText = document.getElementById("goalText");
const powerBar = document.getElementById("powerBar");
const surgeLevelDisplay = document.getElementById("surgeLevel");
const firesText = document.getElementById("firesText");
const reverseHint = document.getElementById("reverseHint");

const rows = 20, cols = 20;
let controllerPos = { x: 10, y: 10 };
let batteryPositions = [];
let firePositions = [];
let reverseSurgeTiles = [];
let trappedFires = [];
let collectedBatteries = 0;
let lives = 3;
let timer = 30;
let level = 0;
let gameInterval, moveInterval, freezeInterval;
let isTimerExpired = false;
let surgeActive = false;
let paused = false;
let totalCollected = 0;

/* ===== Fit-to-screen logic (iPhone-safe) =====
   Chooses the largest cell size that allows:
   - full 20x20 grid
   - HUD + controls + margins
   to fit in the *visual* viewport without scrolling. */
function getViewportHeight(){
  // Use VisualViewport when available (iOS Safari with dynamic bars)
  return (window.visualViewport ? window.visualViewport.height : window.innerHeight);
}
function fitBoard(auto=false){
  const wrap = document.getElementById('boardWrap');

  // Width limit from frame padding
  const usableW = wrap.clientWidth - 8;

  // Height: visual viewport minus distance from top of board to bottom, leaving room for controls/footer
  const boardTop = wrap.getBoundingClientRect().top;
  const vvh = getViewportHeight();

  // Reserve some space below for buttons + dpad (~180-220 on phones), but scale with viewport
  const reserveBelow = Math.max(150, Math.min(260, vvh * 0.28));
  const usableH = Math.max(220, vvh - boardTop - reserveBelow);

  // Determine cell size that fits both width and height
  const byW = Math.floor(usableW / cols);
  const byH = Math.floor(usableH / rows);

  // Clamp so it doesn't get too tiny or too huge
  const cell = Math.max(18, Math.min(44, Math.min(byW, byH)));

  document.documentElement.style.setProperty('--cell', cell + 'px');

  if (!auto){
    canvas.style.transition = 'transform .12s ease';
    canvas.style.transform = 'scale(0.995)';
    setTimeout(()=>{ canvas.style.transform = 'scale(1)' }, 130);
  }
}
// Listen for all viewport changes (keyboard up, bars collapsing, rotation)
window.addEventListener('resize', ()=>fitBoard(true));
window.visualViewport?.addEventListener('resize', ()=>fitBoard(true));
window.addEventListener('orientationchange', ()=>fitBoard(true));
fitBoard(true);

/* ===== Grid helpers ===== */
function createGrid(){
  canvas.innerHTML = "";
  canvas.classList.remove('power');
  const frag = document.createDocumentFragment();
  for (let i=0;i<rows*cols;i++){
    const cell = document.createElement("div");
    cell.classList.add("grid-cell");
    frag.appendChild(cell);
  }
  canvas.appendChild(frag);
}
function getIndex(x,y){ return y * cols + x; }

function render(){
  const cells = canvas.querySelectorAll(".grid-cell");
  cells.forEach(cell => cell.innerHTML = "");

  // controller
  const c = document.createElement("div");
  c.classList.add("controller");
  cells[getIndex(controllerPos.x, controllerPos.y)]?.appendChild(c);

  // items
  batteryPositions.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("battery");
    cells[getIndex(pos.x, pos.y)]?.appendChild(el);
  });
  firePositions.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("hazard");
    cells[getIndex(pos.x, pos.y)]?.appendChild(el);
  });
  trappedFires.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("trapped-fire");
    cells[getIndex(pos.x, pos.y)]?.appendChild(el);
  });
  reverseSurgeTiles.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("reverse-surge");
    cells[getIndex(pos.x, pos.y)]?.appendChild(el);
  });

  goalText.textContent = `${collectedBatteries} / ${10 + level*2}`;
  livesDisplay.textContent = lives;
  powerBar.textContent = level;
  surgeLevelDisplay.textContent = level;
  firesText.textContent = 20 + level*2;
  reverseHint.textContent = `${reverseSurgeTiles.length} tiles`;
}

function getRandomUniquePositions(count, exclude = []){
  const positions = [];
  const excludeSet = new Set(exclude.map(e=>`${e.x},${e.y}`));
  while (positions.length < count){
    const pos = { x:Math.floor(Math.random()*cols), y:Math.floor(Math.random()*rows) };
    const key = `${pos.x},${pos.y}`;
    if (!excludeSet.has(key) && !positions.some(e=>`${e.x},${e.y}`===key)){
      positions.push(pos);
    }
  }
  return positions;
}

function moveItemsRandomly(list){
  return list.map(pos=>{
    const dirs = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
    const dir = dirs[Math.floor(Math.random()*dirs.length)];
    const nx = Math.max(0, Math.min(cols-1, pos.x+dir.x));
    const ny = Math.max(0, Math.min(rows-1, pos.y+dir.y));
    return {x:nx, y:ny};
  });
}

function floatText(text, pos){
  const span = document.createElement('div');
  span.className = 'float';
  span.textContent = text;
  const cell = canvas.children[getIndex(pos.x, pos.y)];
  cell?.appendChild(span);
  setTimeout(()=>span.remove(), 650);
}

/* ===== Level & Timer ===== */
function spawnLevel(){
  const batteriesNeeded = 10 + level * 2;
  const firesNeeded = 20 + level * 2;
  const exclude = [controllerPos];

  batteryPositions = getRandomUniquePositions(batteriesNeeded, exclude);
  firePositions = getRandomUniquePositions(firesNeeded, [...exclude, ...batteryPositions]);
  reverseSurgeTiles = getRandomUniquePositions(2, [...exclude, ...batteryPositions, ...firePositions]);
  trappedFires = [];
  collectedBatteries = 0;
  timer = 30 + level * 5;
  isTimerExpired = false;
  surgeActive = false;
  canvas.classList.remove('power');

  render();
}

function startTimer(){
  clearInterval(gameInterval); clearInterval(moveInterval); clearInterval(freezeInterval);

  gameInterval = setInterval(()=>{
    if (paused) return;
    if (!isTimerExpired && !surgeActive){
      timer--;
      timerDisplay.textContent = `${timer}`;
      if (timer <= 0){
        isTimerExpired = true;
        loseLife();
      }
    }
  },1000);

  moveInterval = setInterval(()=>{
    if (paused) return;
    batteryPositions = moveItemsRandomly(batteryPositions);
    reverseSurgeTiles = moveItemsRandomly(reverseSurgeTiles);
    if (!surgeActive){
      firePositions = moveItemsRandomly(firePositions);
    }
    checkCollision();
  }, 900);
}

function loseLife(){
  lives--;
  frame.classList.add('shake');
  setTimeout(()=>frame.classList.remove('shake'), 250);

  if (lives <= 0){
    clearInterval(gameInterval); clearInterval(moveInterval);
    finalStats.textContent = `Levels cleared: ${level} ‚Ä¢ Batteries total: ${totalCollected}`;
    gameOverOverlay.classList.add('show');
    pauseBtn.disabled = true;
  } else {
    spawnLevel();
    startTimer();
  }
}

/* ===== Power-up ===== */
function activateReverseSurge(){
  if (surgeActive) return;
  surgeActive = true;
  canvas.classList.add('power');
  trappedFires = [...firePositions];
  firePositions = [];

  let freezeCounter = 8;
  freezeInterval = setInterval(()=>{
    freezeCounter--;
    if (freezeCounter <= 0){
      surgeActive = false;
      firePositions = [...firePositions, ...trappedFires];
      trappedFires = [];
      clearInterval(freezeInterval);
      canvas.classList.remove('power');
    }
    render();
  },1000);
}

/* ===== Collisions & Progress ===== */
function checkCollision(){
  let leveled = false;

  // battery
  batteryPositions = batteryPositions.filter(pos=>{
    if (pos.x === controllerPos.x && pos.y === controllerPos.y){
      collectedBatteries++; totalCollected++;
      floatText('+üîã', pos);
      return false;
    }
    return true;
  });

  // reverse surge
  reverseSurgeTiles = reverseSurgeTiles.filter(pos=>{
    if (pos.x === controllerPos.x && pos.y === controllerPos.y){
      activateReverseSurge();
      floatText('‚ö° Freeze!', pos);
      return false;
    }
    return true;
  });

  // trapped fires do nothing
  trappedFires = trappedFires.filter(pos=> !(pos.x === controllerPos.x && pos.y === controllerPos.y));

  // fire hit
  for (const pos of firePositions){
    if (pos.x === controllerPos.x && pos.y === controllerPos.y && !isTimerExpired){
      isTimerExpired = true;
      floatText('üî• Ouch!', pos);
      return loseLife();
    }
  }

  // level up?
  if (collectedBatteries >= 10 + level*2){
    level++;
    if (level >= 5){
      clearInterval(gameInterval); clearInterval(moveInterval);
      gameOverOverlay.classList.add('show');
      finalStats.textContent = `FULL SYNC COMPLETE! Levels: ${level} ‚Ä¢ Batteries: ${totalCollected}`;
      pauseBtn.disabled = true;
      return;
    }
    leveled = true;
  }

  render();

  if (leveled){
    powerBar.textContent = `${level}`;
    surgeLevelDisplay.textContent = `${level}`;
    levelUpOverlay.classList.add('show');
    setTimeout(()=> levelUpOverlay.classList.remove('show'), 900);
    spawnLevel();
    startTimer();
  }
}

/* ===== Game Control ===== */
function startGame(){
  gameOverOverlay.classList.remove('show');
  levelUpOverlay.classList.remove('show');
  lives = 3; level = 0; totalCollected = 0;
  controllerPos = {x:10, y:10};
  timerDisplay.textContent = '30';
  startBtn.disabled = true; pauseBtn.disabled = false; paused = false;
  fitBoard(true);           // ensure perfect fit at start
  createGrid();
  spawnLevel();
  startTimer();
}
function pauseGame(){
  paused = !paused;
  pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
}

/* ===== Input ===== */
function move(dir){
  let moved = false;
  if (dir === "ArrowUp"   && controllerPos.y > 0)         { controllerPos.y--; moved = true; }
  if (dir === "ArrowDown" && controllerPos.y < rows - 1)   { controllerPos.y++; moved = true; }
  if (dir === "ArrowLeft" && controllerPos.x > 0)          { controllerPos.x--; moved = true; }
  if (dir === "ArrowRight"&& controllerPos.x < cols - 1)   { controllerPos.x++; moved = true; }
  if (moved) checkCollision();
}

document.addEventListener("keydown", e=>{
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key) && !paused){
    move(e.key);
  }
});

document.querySelectorAll('.key[data-dir]').forEach(k=>{
  k.addEventListener('click', ()=> move(k.getAttribute('data-dir')));
});

startBtn.addEventListener("click", startGame);
pauseBtn.addEventListener("click", pauseGame);
document.getElementById('retryBtn')?.addEventListener('click', startGame);
fitBtn.addEventListener('click', ()=>fitBoard(false));

/* Init */
createGrid();
render();
</script>
</body>
</html>
