<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>GSU Charge Run</title>
<link rel="icon" href="GSU_LOGO.png" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet" />
<style>
  :root{
    --gsu-red:#e60023; --bg:#000; --fg:#fff; --muted:#c7c7c7;
    --cell:40px; /* tile size */
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:'Orbitron',sans-serif; background:var(--bg); color:var(--fg);
    min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:16px; gap:14px;
  }
  header{display:flex; flex-direction:column; align-items:center; gap:8px}
  .logo img{max-width:110px}
  .logo .text{letter-spacing:2px; opacity:.9}

  nav{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  nav a{color:#fff; text-decoration:none; background:var(--gsu-red); padding:8px 12px; border-radius:10px}

  .frame{
    width:min(960px,96vw);
    border:3px solid var(--gsu-red); border-radius:16px; padding:14px;
    box-shadow:0 0 18px #e60023cc, inset 0 0 18px #e6002326;
    background:linear-gradient(#0a0a0a,#000);
  }
  .frame.shake{animation:shake .25s ease}
  @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(4px)}75%{transform:translateX(-4px)}}

  h1{margin:6px 0 2px 6px}
  h2.sub{margin:0 0 8px 6px; color:var(--gsu-red); font-size:1rem; opacity:.9}

  .hud{
    display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-bottom:10px; font-size:clamp(.8rem,2vw,1rem);
  }
  .pill{background:#111; border:1px solid #2a2a2a; border-radius:10px; padding:8px; text-align:center}
  .pill strong{color:var(--gsu-red)}

  /* Board */
  #gameCanvas{
    display:grid;
    grid-template-columns: repeat(20, var(--cell));
    grid-template-rows: repeat(20, var(--cell));
    border:2px solid #222; border-radius:12px; overflow:hidden;
    background:
      linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
      linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
    background-size: var(--cell) var(--cell);
    box-shadow:0 0 20px #e60023cc inset;
    position:relative;
  }
  /* subtle glow border that animates when power-up active */
  #gameCanvas.power{
    animation:powerGlow 1s ease-in-out infinite alternate;
    border-color:#ff4060;
  }
  @keyframes powerGlow{
    from{box-shadow:0 0 16px #e60023aa inset}
    to  {box-shadow:0 0 28px #ff6a80cc inset}
  }

  .grid-cell{width:var(--cell); height:var(--cell); position:relative; overflow:visible}
  .grid-cell div{
    width:100%; height:100%; background-size:contain; background-repeat:no-repeat; background-position:center; position:absolute;
    display:flex; align-items:center; justify-content:center; font-size:calc(var(--cell) * .7);
  }

  .controller{
    background-image:url('GSU_LOGO.png'); z-index:3;
    filter:drop-shadow(0 0 8px rgba(230,0,35,.6));
    animation:idlePulse 1.4s ease-in-out infinite;
  }
  @keyframes idlePulse{0%,100%{transform:scale(1)}50%{transform:scale(1.04)}}

  .battery::after{content:'üîã'}
  .hazard::after{content:'üî•'}
  .reverse-surge::after{content:'üîÑ'}
  .trapped-fire{
    background-image:url('GSU_LOGO.png');
    animation:flash 1s infinite;
    filter:hue-rotate(140deg) drop-shadow(0 0 8px #66d1ff);
  }
  @keyframes flash{0%,100%{opacity:.85}50%{opacity:.55}}

  /* Floating feedback */
  .float{
    position:absolute; font-size:14px; color:#fff; text-shadow:0 0 6px rgba(255,255,255,.7);
    animation:floatUp .6s ease-out forwards;
    pointer-events:none;
  }
  @keyframes floatUp{from{transform:translateY(0); opacity:1}to{transform:translateY(-16px); opacity:0}}

  /* Controls */
  .controls{
    margin-top:10px; display:flex; flex-direction:column; align-items:center; gap:8px;
  }
  .dpad{display:grid; grid-template-columns:repeat(3,64px); gap:8px}
  .key{
    width:64px; height:64px; border-radius:12px; background:#121212; border:1px solid #333; display:flex;
    align-items:center; justify-content:center; font-size:1.4rem; cursor:pointer; user-select:none;
    box-shadow:0 0 8px rgba(255,255,255,.05);
  }
  .key:active{filter:brightness(1.2)}
  .btn{
    border:none; background:var(--gsu-red); color:#fff; padding:10px 16px; border-radius:10px; cursor:pointer;
    box-shadow:0 0 10px #e60023aa; font-weight:700;
  }
  .btn:disabled{opacity:.6; cursor:not-allowed}

  /* Overlay screens */
  .overlay{
    position:absolute; inset:0; display:none; align-items:center; justify-content:center; backdrop-filter:blur(2px);
  }
  .overlay.show{display:flex}
  .panel{
    background:#0b0b0b; border:1px solid #333; border-radius:14px; padding:16px 20px; text-align:center; min-width:260px;
    box-shadow:0 0 20px rgba(0,0,0,.6);
  }
  .panel h2{margin:0 0 8px 0; color:var(--gsu-red)}
  .panel .row{display:flex; gap:10px; justify-content:center; margin-top:10px}

  footer{opacity:.7; font-size:.85rem; text-align:center; margin-top:10px}

  @media (max-width:640px){
    :root{ --cell:32px }
    .hud{grid-template-columns:repeat(3,1fr)}
  }
</style>
</head>
<body>
  <header>
    <div class="logo">
      <img src="GSU_LOGO.png" alt="GSU Logo">
      <div class="text">GAMESYNC UNION</div>
    </div>
    <nav>
      <a href="index.html">Home</a>
    </nav>
  </header>

  <section class="frame" id="frame">
    <h1>GSU CHARGE RUN</h1>
    <h2 class="sub">Collect batteries, dodge fires, and trigger Reverse Surge to freeze hazards.</h2>

    <div class="hud">
      <div class="pill">üîã Goal <strong id="goalText">0 / 10</strong></div>
      <div class="pill">üî• Fires <strong id="firesText">20</strong></div>
      <div class="pill">‚è± Time <strong id="timer">30</strong>s</div>
      <div class="pill">‚ö° Surge <strong id="powerBar">0</strong></div>
      <div class="pill">‚ù§Ô∏è Lives <strong id="lives">3</strong></div>
      <div class="pill">üîÑ Reverse <strong id="reverseHint">2 tiles</strong></div>
      <div class="pill">‚¨Ü Level <strong id="surgeLevel">0</strong></div>
    </div>

    <div id="boardWrap" style="position:relative">
      <div id="gameCanvas" aria-live="polite"></div>

      <!-- Overlay screens -->
      <div class="overlay" id="gameOver">
        <div class="panel">
          <h2>Game Over</h2>
          <div id="finalStats" style="opacity:.85; margin-bottom:8px;"></div>
          <div class="row">
            <button class="btn" id="retryBtn">üîÅ Play Again</button>
            <button class="btn" onclick="location.href='index.html'">üè† Home</button>
          </div>
        </div>
      </div>

      <div class="overlay" id="levelUp">
        <div class="panel">
          <h2>Level Up!</h2>
          <div style="opacity:.85">Grid surges with power. Hazards increase.</div>
        </div>
      </div>
    </div>

    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
      <button class="btn" id="startGameBtn">‚ñ∂ Start GSU Charge Run</button>
      <button class="btn" id="pauseBtn" disabled>‚è∏ Pause</button>
    </div>

    <div class="controls">
      <div style="color:var(--muted)">On desktop: Arrow Keys to move. On mobile: tap the D-Pad.</div>
      <div class="dpad">
        <div></div><div class="key" data-dir="ArrowUp">‚¨ÜÔ∏è</div><div></div>
        <div class="key" data-dir="ArrowLeft">‚¨ÖÔ∏è</div><div class="key" data-dir="ArrowDown">‚¨áÔ∏è</div><div class="key" data-dir="ArrowRight">‚û°Ô∏è</div>
      </div>
    </div>

    <footer>Built for GameSync Union ‚Äî GSU Charge Run‚Ñ¢</footer>
  </section>

<script>
/* ------------ DOM & State ------------ */
const frame = document.getElementById('frame');
const canvas = document.getElementById("gameCanvas");
const startBtn = document.getElementById("startGameBtn");
const pauseBtn = document.getElementById("pauseBtn");
const gameOverOverlay = document.getElementById("gameOver");
const levelUpOverlay = document.getElementById("levelUp");
const finalStats = document.getElementById("finalStats");

const timerDisplay = document.getElementById("timer");
const livesDisplay = document.getElementById("lives");
const goalText = document.getElementById("goalText");
const powerBar = document.getElementById("powerBar");
const surgeLevelDisplay = document.getElementById("surgeLevel");
const firesText = document.getElementById("firesText");
const reverseHint = document.getElementById("reverseHint");

const rows = 20, cols = 20;
let controllerPos = { x: 10, y: 10 };
let batteryPositions = [];
let firePositions = [];
let reverseSurgeTiles = [];
let trappedFires = [];
let collectedBatteries = 0;
let lives = 3;
let timer = 30;
let level = 0;
let gameInterval, moveInterval, freezeInterval;
let isTimerExpired = false;
let surgeActive = false;
let paused = false;
let totalCollected = 0;

/* ------------ Helpers ------------ */
function createGrid(){
  canvas.innerHTML = "";
  canvas.classList.remove('power');
  for (let i=0;i<rows*cols;i++){
    const cell = document.createElement("div");
    cell.classList.add("grid-cell");
    canvas.appendChild(cell);
  }
}
function getIndex(x,y){ return y * cols + x; }
function inBounds(x,y){ return x>=0 && x<cols && y>=0 && y<rows; }

function render(){
  const cells = canvas.querySelectorAll(".grid-cell");
  cells.forEach(cell => cell.innerHTML = "");

  // controller
  const c = document.createElement("div");
  c.classList.add("controller");
  cells[getIndex(controllerPos.x, controllerPos.y)].appendChild(c);

  // items
  batteryPositions.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("battery");
    cells[getIndex(pos.x, pos.y)].appendChild(el);
  });
  firePositions.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("hazard");
    cells[getIndex(pos.x, pos.y)].appendChild(el);
  });
  trappedFires.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("trapped-fire");
    cells[getIndex(pos.x, pos.y)].appendChild(el);
  });
  reverseSurgeTiles.forEach(pos=>{
    const el = document.createElement("div");
    el.classList.add("reverse-surge");
    cells[getIndex(pos.x, pos.y)].appendChild(el);
  });

  goalText.textContent = `${collectedBatteries} / ${10 + level*2}`;
  livesDisplay.textContent = lives;
  powerBar.textContent = level;
  surgeLevelDisplay.textContent = level;
  firesText.textContent = 20 + level*2;
}

function getRandomUniquePositions(count, exclude = []){
  const positions = [];
  const excludeSet = new Set(exclude.map(e=>`${e.x},${e.y}`));
  while (positions.length < count){
    const pos = { x:Math.floor(Math.random()*cols), y:Math.floor(Math.random()*rows) };
    const key = `${pos.x},${pos.y}`;
    if (!excludeSet.has(key) && !positions.some(e=>`${e.x},${e.y}`===key)){
      positions.push(pos);
    }
  }
  return positions;
}

function moveItemsRandomly(list){
  return list.map(pos=>{
    const dirs = [{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
    const dir = dirs[Math.floor(Math.random()*dirs.length)];
    const nx = Math.max(0, Math.min(cols-1, pos.x+dir.x));
    const ny = Math.max(0, Math.min(rows-1, pos.y+dir.y));
    return {x:nx, y:ny};
  });
}

function floatText(text, pos){
  const span = document.createElement('div');
  span.className = 'float';
  span.textContent = text;
  const cell = canvas.children[getIndex(pos.x, pos.y)];
  cell?.appendChild(span);
  setTimeout(()=>span.remove(), 650);
}

/* ------------ Level / Timer ------------ */
function spawnLevel(){
  const batteriesNeeded = 10 + level * 2;
  const firesNeeded = 20 + level * 2;
  const exclude = [controllerPos];

  batteryPositions = getRandomUniquePositions(batteriesNeeded, exclude);
  firePositions = getRandomUniquePositions(firesNeeded, [...exclude, ...batteryPositions]);
  reverseSurgeTiles = getRandomUniquePositions(2, [...exclude, ...batteryPositions, ...firePositions]);
  trappedFires = [];
  collectedBatteries = 0;
  timer = 30 + level * 5;
  isTimerExpired = false;
  surgeActive = false;
  canvas.classList.remove('power');

  reverseHint.textContent = `${reverseSurgeTiles.length} tiles`;
  render();
}

function startTimer(){
  clearInterval(gameInterval); clearInterval(moveInterval); clearInterval(freezeInterval);

  gameInterval = setInterval(()=>{
    if (paused) return;
    if (!isTimerExpired && !surgeActive){
      timer--;
      timerDisplay.textContent = `${timer}`;
      if (timer <= 0){
        isTimerExpired = true;
        loseLife();
      }
    }
  },1000);

  moveInterval = setInterval(()=>{
    if (paused) return;
    batteryPositions = moveItemsRandomly(batteryPositions);
    reverseSurgeTiles = moveItemsRandomly(reverseSurgeTiles);
    if (!surgeActive){
      firePositions = moveItemsRandomly(firePositions);
    }
    checkCollision();
  }, 900);
}

function loseLife(){
  lives--;
  frame.classList.add('shake');
  setTimeout(()=>frame.classList.remove('shake'), 250);

  if (lives <= 0){
    clearInterval(gameInterval); clearInterval(moveInterval);
    finalStats.textContent = `Levels cleared: ${level} ‚Ä¢ Batteries total: ${totalCollected}`;
    gameOverOverlay.classList.add('show');
    pauseBtn.disabled = true;
  } else {
    spawnLevel();
    startTimer();
  }
}

/* ------------ Power-up ------------ */
function activateReverseSurge(){
  if (surgeActive) return;
  surgeActive = true;
  canvas.classList.add('power');
  trappedFires = [...firePositions];
  firePositions = [];

  let freezeCounter = 8;
  freezeInterval = setInterval(()=>{
    freezeCounter--;
    if (freezeCounter <= 0){
      surgeActive = false;
      firePositions = [...firePositions, ...trappedFires];
      trappedFires = [];
      clearInterval(freezeInterval);
      canvas.classList.remove('power');
    }
    render();
  },1000);
}

/* ------------ Collisions & Progress ------------ */
function checkCollision(){
  let leveled = false;

  // battery
  batteryPositions = batteryPositions.filter(pos=>{
    if (pos.x === controllerPos.x && pos.y === controllerPos.y){
      collectedBatteries++; totalCollected++;
      floatText('+üîã', pos);
      return false;
    }
    return true;
  });

  // reverse surge
  reverseSurgeTiles = reverseSurgeTiles.filter(pos=>{
    if (pos.x === controllerPos.x && pos.y === controllerPos.y){
      activateReverseSurge();
      floatText('‚ö° Freeze!', pos);
      return false;
    }
    return true;
  });

  // trapped fires do nothing to player, just visuals
  trappedFires = trappedFires.filter(pos=> !(pos.x === controllerPos.x && pos.y === controllerPos.y));

  // fire hit
  for (const pos of firePositions){
    if (pos.x === controllerPos.x && pos.y === controllerPos.y && !isTimerExpired){
      isTimerExpired = true;
      floatText('üî• Ouch!', pos);
      return loseLife();
    }
  }

  // level up?
  if (collectedBatteries >= 10 + level*2){
    level++;
    if (level >= 5){
      clearInterval(gameInterval); clearInterval(moveInterval);
      gameOverOverlay.classList.add('show');
      finalStats.textContent = `FULL SYNC COMPLETE! Levels: ${level} ‚Ä¢ Batteries: ${totalCollected}`;
      pauseBtn.disabled = true;
      return;
    }
    leveled = true;
  }

  render();

  if (leveled){
    powerBar.textContent = `${level}`;
    surgeLevelDisplay.textContent = `${level}`;
    levelUpOverlay.classList.add('show');
    setTimeout(()=> levelUpOverlay.classList.remove('show'), 900);
    spawnLevel();
    startTimer();
  }
}

/* ------------ Game Control ------------ */
function startGame(){
  gameOverOverlay.classList.remove('show');
  levelUpOverlay.classList.remove('show');
  lives = 3; level = 0; totalCollected = 0;
  controllerPos = {x:10, y:10};
  timerDisplay.textContent = '30';
  startBtn.disabled = true; pauseBtn.disabled = false; paused = false;
  createGrid();
  spawnLevel();
  startTimer();
}
function pauseGame(){
  paused = !paused;
  pauseBtn.textContent = paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
}

/* ------------ Input ------------ */
function move(dir){
  let moved = false;
  if (dir === "ArrowUp"   && controllerPos.y > 0)         { controllerPos.y--; moved = true; }
  if (dir === "ArrowDown" && controllerPos.y < rows - 1)   { controllerPos.y++; moved = true; }
  if (dir === "ArrowLeft" && controllerPos.x > 0)          { controllerPos.x--; moved = true; }
  if (dir === "ArrowRight"&& controllerPos.x < cols - 1)   { controllerPos.x++; moved = true; }
  if (moved) checkCollision();
}

document.addEventListener("keydown", e=>{
  // Only prevent arrows from scrolling
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)) e.preventDefault();
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key) && !paused){
    move(e.key);
  }
});

document.querySelectorAll('.key[data-dir]').forEach(k=>{
  k.addEventListener('click', ()=> move(k.getAttribute('data-dir')));
});

startBtn.addEventListener("click", startGame);
pauseBtn.addEventListener("click", pauseGame);
document.getElementById('retryBtn')?.addEventListener('click', startGame);

/* Init */
createGrid();
render();
</script>
</body>
</html>
